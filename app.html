<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farm Fam</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel CDN for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js CDN for Insights -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js"; 
    // Import Firestore functions
    import { 
      getFirestore,
      doc,
      getDoc,
      setDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBDaxMSn6CGiSfYho92FFZieTjLND8I4BM",
      authDomain: "chicken-chores.firebaseapp.com",
      projectId: "chicken-chores",
      storageBucket: "chicken-chores.appspot.com",
      messagingSenderId: "804974041900",
      appId: "1:804974041900:web:b37a3d768f1771f35aea89"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // Initialize Firebase Authentication and get a reference to the service
    const auth = getAuth(app); 
    const googleProvider = new GoogleAuthProvider();

    // Initialize Firestore
    const db = getFirestore(app);

    // Attach Firebase Auth services to the global window object
    window.firebaseAuth = {
      auth,
      googleProvider,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    };

    // Attach Firebase Firestore services to the global window object
    window.firebaseDb = {
        db,
        doc,
        getDoc,
        setDoc,
        onSnapshot
    };

  </script>
</head>
<body class="min-h-screen" style="background-color: #F0F8F0;">
  <div id="root" class="container mx-auto p-2 sm:p-4"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // App pages/routes
    const PAGES = {
      ONBOARDING: 'onboarding',
      LOGIN: 'login',
      TASKS: 'tasks',
      LEADERBOARD: 'leaderboard',
      PROFILE: 'profile',
      TASK_EDITOR: 'task-editor',
      BADGE_EDITOR: 'badge-editor',
      SETTINGS: 'settings',
      FAMILY_MEMBERS: 'family-members'
    };

    // Onboarding steps
    const ONBOARDING_STEPS = [
      {
        id: 'welcome',
        title: 'Welcome to Farm Fam! ðŸ”',
        content: 'Transform your family\'s farm chores into a fun, organized experience!',
        icon: 'ðŸ '
      },
      {
        id: 'tasks',
        title: 'Assign Tasks ðŸ“‹',
        content: 'Make responsibility feel like an adventure on the homestead.',
        icon: 'ðŸ”'
      },
      {
        id: 'rewards',
        title: 'Earn Rewards â­',
        content: 'Complete tasks to earn points and unlock special badges like "Egg Expert" and "Feed Master".',
        icon: 'ðŸ†'
      },
      {
        id: 'auth',
        title: 'You\'re All Set! ðŸŽ‰',
        content: 'Create an account to save your progress, or skip to start using Farm Fam right away!',
        icon: 'ðŸš€'
      }
    ];

    // Initial data for tasks and users
    const initialTasks = [
      { id: 1, name: "Feed Chickens", frequency: "Daily", assignee: "Kid 1", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Fill feeders with chicken feed", emoji: "ðŸ”", active: true, timeOfDay: "Morning" },
      { id: 2, name: "Feed Chickens", frequency: "Daily", assignee: "Kid 2", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Fill feeders with chicken feed", emoji: "ðŸ”", active: true, timeOfDay: "Evening" },
      { id: 3, name: "Collect Eggs", frequency: "Daily", assignee: "Kid 1", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Gather fresh eggs from nesting boxes", emoji: "ðŸ¥š", active: true, timeOfDay: "Evening" },
      { id: 4, name: "Clean Coop", frequency: "Specific", assignee: "Dad", points: 10, daysOfWeek: ["Saturday"], notes: "Deep clean chicken coop and replace bedding", emoji: "ðŸ§¹", active: true, timeOfDay: "Anytime" },
      { id: 5, name: "Refill Chickens' Water", frequency: "Specific", assignee: "Kid 2", points: 5, daysOfWeek: ["Monday", "Wednesday", "Friday"], notes: "Check and refill water containers", emoji: "ðŸ’§", active: true, timeOfDay: "Morning" },
      { id: 6, name: "Clean Water Bowl", frequency: "Specific", assignee: "Mom", points: 5, daysOfWeek: ["Sunday"], notes: "Scrub and sanitize water containers", emoji: "ðŸ§½", active: true, timeOfDay: "Anytime" },
      { id: 7, name: "Check Feed Storage", frequency: "Specific", assignee: "Dad", points: 5, daysOfWeek: ["Friday"], notes: "Verify feed levels and quality", emoji: "ðŸ“¦", active: true, timeOfDay: "Anytime" },
      { id: 8, name: "Supervised Free Range", frequency: "Daily", assignee: "Kid 1", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Let chickens roam in yard with supervision", emoji: "ðŸ“", active: true, timeOfDay: "Evening" },
      { id: 9, name: "Check for Illness", frequency: "Daily", assignee: "Mom", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Observe chickens for signs of illness", emoji: "ðŸ”", active: true, timeOfDay: "Anytime" },
      { id: 10, name: "Secure Coop at Night", frequency: "Daily", assignee: "Dad", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Close and lock coop doors for safety", emoji: "ðŸ”’", active: true, timeOfDay: "Evening" },
      { id: 11, name: "Feed Dogs", frequency: "Daily", assignee: "Dad", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Fill dog food bowls", emoji: "ðŸ¶", active: true, timeOfDay: "Morning" },
      { id: 12, name: "Feed Dogs", frequency: "Daily", assignee: "Mom", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Fill dog food bowls", emoji: "ðŸ¶", active: true, timeOfDay: "Evening" }
    ];

    const initialUsers = [
      { name: "Mom", points: 0, badges: [], avatar: "ðŸ‘©", color: "pink" },
      { name: "Dad", points: 0, badges: [], avatar: "ðŸ‘¨", color: "blue" },
      { name: "Kid 1", points: 0, badges: [], avatar: "ðŸ§‘", color: "orange" },
      { name: "Kid 2", points: 0, badges: [], avatar: "ðŸ‘¦", color: "green" },
    ];

    const getInitialState = () => ({
        tasks: JSON.parse(localStorage.getItem("tasks")) || initialTasks,
        users: JSON.parse(localStorage.getItem("users")) || initialUsers,
        customBadges: JSON.parse(localStorage.getItem("customBadges")) || {},
        taskCompletions: JSON.parse(localStorage.getItem("taskCompletions")) || {},
        lastWeeklyReset: localStorage.getItem("lastWeeklyReset") || null,
        lastResetDate: localStorage.getItem("lastResetDate") || new Date().toDateString(),
    });

    const presetTasks = [
        { name: "Feed Chickens", points: 5, frequency: "Daily", notes: "Fill feeders with chicken feed", emoji: "ðŸŒ¾", active: true, assignee: "Kid 1" },
        { name: "Collect Eggs", points: 5, frequency: "Daily", notes: "Gather fresh eggs from nesting boxes", emoji: "ðŸ¥š", active: true, assignee: "Kid 2" },
        { name: "Clean Coop", points: 10, frequency: "Custom", daysOfWeek: ["Saturday"], notes: "Deep clean chicken coop and replace bedding", emoji: "ðŸ§¹", active: true, assignee: "Dad" },
        { name: "Refill Water", points: 5, frequency: "Daily", notes: "Check and refill water containers", emoji: "ðŸ’§", active: true, assignee: "Kid 2" },
        { name: "Clean Water Bowl", points: 5, frequency: "Custom", daysOfWeek: ["Sunday"], notes: "Scrub and sanitize water containers", emoji: "ðŸ§½", active: true, assignee: "Mom" },
        { name: "Check Feed Storage", points: 5, frequency: "Custom", daysOfWeek: ["Friday"], notes: "Verify feed levels and quality", emoji: "ðŸ“¦", active: true, assignee: "Dad" },
        { name: "Supervised Free Range", points: 5, frequency: "Daily", notes: "Let chickens roam in yard with supervision", emoji: "ðŸ“", active: true, assignee: "Kid 1" },
        { name: "Check for Illness", points: 5, frequency: "Daily", notes: "Observe chickens for signs of illness", emoji: "ðŸ”", active: true, assignee: "Mom" },
        { name: "Secure Coop at Night", points: 5, frequency: "Daily", notes: "Close and lock coop doors for safety", emoji: "ðŸ”’", active: true, assignee: "Dad" },
        { name: "Replace Bedding", points: 5, frequency: "Custom", daysOfWeek: ["Wednesday"], notes: "Add fresh bedding material to coop", emoji: "ðŸ›ï¸", active: true, assignee: "Mom" },
        { name: "Feed Dogs", points: 5, frequency: "Daily", notes: "Fill dog food bowls", emoji: "ðŸ•", active: true, assignee: "Kid 2" }
      ];

    // Comprehensive categorized emoji system
    const emojiCategories = {
      "Smileys & People": [
        "ðŸ˜Š", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ™‚", "ðŸ˜‰", "ðŸ˜", "ðŸ¤—", "ðŸ˜Ž", "ðŸ¤”", "ðŸ˜´", "ðŸ˜‹", "ðŸ˜œ", "ðŸ¤©", "ðŸ¥³",
        "ðŸ‘", "ðŸ‘", "ðŸ’ª", "ðŸ™Œ", "ðŸ‘‹", "âœ‹", "ðŸ‘Œ", "âœŒï¸", "ðŸ¤ž", "ðŸ¤Ÿ", "ðŸ¤", "ðŸ‘Š", "âœŠ", "ðŸ™",
        "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦", "ðŸ‘ª", "ðŸ‘¶", "ðŸ‘§", "ðŸ‘¦", "ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘´", "ðŸ‘µ", "ðŸ™‹â€â™€ï¸", "ðŸ™‹â€â™‚ï¸", "ðŸ’â€â™€ï¸", "ðŸ’â€â™‚ï¸",
        "ðŸ‘©â€ðŸ¦°", "ðŸ‘©â€ðŸ¦±", "ðŸ‘©â€ðŸ¦³", "ðŸ‘©â€ðŸ¦²", "ðŸ‘¨â€ðŸ¦°", "ðŸ‘¨â€ðŸ¦±", "ðŸ‘¨â€ðŸ¦³", "ðŸ‘¨â€ðŸ¦²", "ðŸ§‘â€ðŸ¦°", "ðŸ§‘â€ðŸ¦±", "ðŸ§‘â€ðŸ¦³", "ðŸ§‘â€ðŸ¦²",
        "ðŸ‘±â€â™€ï¸", "ðŸ‘±â€â™‚ï¸", "ðŸ§”", "ðŸ§”â€â™€ï¸", "ðŸ§”â€â™‚ï¸", "ðŸ‘¸", "ðŸ¤´", "ðŸ‘°", "ðŸ¤µ", "ðŸ‘°â€â™€ï¸", "ðŸ‘°â€â™‚ï¸", "ðŸ¤µâ€â™€ï¸", "ðŸ¤µâ€â™‚ï¸",
        "ðŸ¤±", "ðŸ¤°", "ðŸ‘¼", "ðŸŽ…", "ðŸ¤¶", "ðŸ§™â€â™€ï¸", "ðŸ§™â€â™‚ï¸", "ðŸ§šâ€â™€ï¸", "ðŸ§šâ€â™‚ï¸", "ðŸ§›â€â™€ï¸", "ðŸ§›â€â™‚ï¸", "ðŸ§œâ€â™€ï¸", "ðŸ§œâ€â™‚ï¸",
        "ðŸ§â€â™€ï¸", "ðŸ§â€â™‚ï¸", "ðŸ§žâ€â™€ï¸", "ðŸ§žâ€â™‚ï¸", "ðŸ§Ÿâ€â™€ï¸", "ðŸ§Ÿâ€â™‚ï¸", "ðŸ’†â€â™€ï¸", "ðŸ’†â€â™‚ï¸", "ðŸ’‡â€â™€ï¸", "ðŸ’‡â€â™‚ï¸", "ðŸš¶â€â™€ï¸", "ðŸš¶â€â™‚ï¸",
        "ðŸƒâ€â™€ï¸", "ðŸƒâ€â™‚ï¸", "ðŸ’ƒ", "ðŸ•º", "ðŸ•´ï¸", "ðŸ‘¯â€â™€ï¸", "ðŸ‘¯â€â™‚ï¸", "ðŸ§˜â€â™€ï¸", "ðŸ§˜â€â™‚ï¸", "ðŸ§—â€â™€ï¸", "ðŸ§—â€â™‚ï¸", "ðŸ‡",
        "â›·ï¸", "ðŸ‚", "ðŸŒï¸â€â™€ï¸", "ðŸŒï¸â€â™‚ï¸", "ðŸ„â€â™€ï¸", "ðŸ„â€â™‚ï¸", "ðŸš£â€â™€ï¸", "ðŸš£â€â™‚ï¸", "ðŸŠâ€â™€ï¸", "ðŸŠâ€â™‚ï¸", "â›¹ï¸â€â™€ï¸", "â›¹ï¸â€â™‚ï¸",
        "ðŸ‹ï¸â€â™€ï¸", "ðŸ‹ï¸â€â™‚ï¸", "ðŸš´â€â™€ï¸", "ðŸš´â€â™‚ï¸", "ðŸšµâ€â™€ï¸", "ðŸšµâ€â™‚ï¸", "ðŸ¤¸â€â™€ï¸", "ðŸ¤¸â€â™‚ï¸", "ðŸ¤¼â€â™€ï¸", "ðŸ¤¼â€â™‚ï¸", "ðŸ¤½â€â™€ï¸", "ðŸ¤½â€â™‚ï¸",
        "ðŸ¤¾â€â™€ï¸", "ðŸ¤¾â€â™‚ï¸", "ðŸ¤¹â€â™€ï¸", "ðŸ¤¹â€â™‚ï¸", "ðŸ§‘â€ðŸ³", "ðŸ‘¨â€ðŸ³", "ðŸ‘©â€ðŸ³", "ðŸ§‘â€ðŸŽ“", "ðŸ‘¨â€ðŸŽ“", "ðŸ‘©â€ðŸŽ“", "ðŸ§‘â€ðŸŽ¤", "ðŸ‘¨â€ðŸŽ¤", "ðŸ‘©â€ðŸŽ¤",
        "ðŸ§‘â€ðŸ«", "ðŸ‘¨â€ðŸ«", "ðŸ‘©â€ðŸ«", "ðŸ§‘â€ðŸ­", "ðŸ‘¨â€ðŸ­", "ðŸ‘©â€ðŸ­", "ðŸ§‘â€ðŸ’»", "ðŸ‘¨â€ðŸ’»", "ðŸ‘©â€ðŸ’»", "ðŸ§‘â€ðŸ’¼", "ðŸ‘¨â€ðŸ’¼", "ðŸ‘©â€ðŸ’¼",
        "ðŸ§‘â€ðŸ”§", "ðŸ‘¨â€ðŸ”§", "ðŸ‘©â€ðŸ”§", "ðŸ§‘â€ðŸ”¬", "ðŸ‘¨â€ðŸ”¬", "ðŸ‘©â€ðŸ”¬", "ðŸ§‘â€ðŸŽ¨", "ðŸ‘¨â€ðŸŽ¨", "ðŸ‘©â€ðŸŽ¨", "ðŸ§‘â€ðŸš’", "ðŸ‘¨â€ðŸš’", "ðŸ‘©â€ðŸš’",
        "ðŸ§‘â€âœˆï¸", "ðŸ‘¨â€âœˆï¸", "ðŸ‘©â€âœˆï¸", "ðŸ§‘â€ðŸš€", "ðŸ‘¨â€ðŸš€", "ðŸ‘©â€ðŸš€", "ðŸ§‘â€âš–ï¸", "ðŸ‘¨â€âš–ï¸", "ðŸ‘©â€âš–ï¸", "ðŸ§‘â€ðŸŒ¾", "ðŸ‘¨â€ðŸŒ¾", "ðŸ‘©â€ðŸŒ¾",
        "ðŸ§‘â€âš•ï¸", "ðŸ‘¨â€âš•ï¸", "ðŸ‘©â€âš•ï¸", "ðŸ•µï¸â€â™€ï¸", "ðŸ•µï¸â€â™‚ï¸", "ðŸ’‚â€â™€ï¸", "ðŸ’‚â€â™‚ï¸", "ðŸ‘®â€â™€ï¸", "ðŸ‘®â€â™‚ï¸", "ðŸ‘·â€â™€ï¸", "ðŸ‘·â€â™‚ï¸"
      ],
      "Animals & Nature": [
        "ðŸ”", "ðŸ“", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¶", "ðŸ•", "ðŸ±", "ðŸˆ", "ðŸ­", "ðŸ¹", "ðŸ°", "ðŸ‡", "ðŸ¦Š", "ðŸº", "ðŸ·", "ðŸ½",
        "ðŸ®", "ðŸ„", "ðŸ´", "ðŸŽ", "ðŸ¦„", "ðŸ¸", "ðŸ¢", "ðŸ", "ðŸ¦Ž", "ðŸ™", "ðŸ¦‘", "ðŸ ", "ðŸŸ", "ðŸ¡", "ðŸ¦ˆ", "ðŸ³", "ðŸ‹",
        "ðŸ¦‹", "ðŸ›", "ðŸ", "ðŸž", "ðŸ•·ï¸", "ðŸ¦—", "ðŸœ", "ðŸª²", "ðŸ¦Ÿ", "ðŸª°", "ðŸª±", "ðŸ¦ ",
        "ðŸŒ³", "ðŸŒ²", "ðŸŒ´", "ðŸŒµ", "ðŸŒ¿", "ðŸŒ±", "ðŸŒ¾", "ðŸŒ¸", "ðŸŒº", "ðŸŒ»", "ðŸŒ¹", "ðŸŒ·", "ðŸŒ¼", "ðŸŒµ", "ðŸƒ", "ðŸ‚", "ðŸ",
        "ðŸŒ¤ï¸", "â˜€ï¸", "ðŸŒž", "ðŸŒ", "ðŸŒ›", "ðŸŒœ", "ðŸŒš", "ðŸŒ•", "ðŸŒ–", "ðŸŒ—", "ðŸŒ˜", "ðŸŒ‘", "â­", "ðŸŒŸ", "ðŸ’«", "âœ¨", "â˜„ï¸",
        "ðŸŒˆ", "â˜”", "â›ˆï¸", "ðŸŒ©ï¸", "â„ï¸", "â˜ƒï¸", "â›„", "ðŸŒŠ", "ðŸ’§", "ðŸ’¦"
      ],
      "Food & Drink": [
        "ðŸ¥š", "ðŸ³", "ðŸ§ˆ", "ðŸ¥“", "ðŸ¥ž", "ðŸ§‡", "ðŸž", "ðŸ¥–", "ðŸ¥¨", "ðŸ§€", "ðŸ¥—", "ðŸ¥™", "ðŸ¥ª", "ðŸŒ®", "ðŸŒ¯", "ðŸ•", "ðŸ”", "ðŸŸ",
        "ðŸŒ­", "ðŸ¥©", "ðŸ—", "ðŸ–", "ðŸ¦´", "ðŸŒ¶ï¸", "ðŸ¥•", "ðŸŒ½", "ðŸ¥¬", "ðŸ¥’", "ðŸ§„", "ðŸ§…", "ðŸ„", "ðŸ¥”", "ðŸ ", "ðŸ«", "ðŸ‡",
        "ðŸˆ", "ðŸ‰", "ðŸŠ", "ðŸ‹", "ðŸŒ", "ðŸ", "ðŸ¥­", "ðŸ‘", "ðŸ’", "ðŸ“", "ðŸ«–", "â˜•", "ðŸµ", "ðŸ§ƒ", "ðŸ¥¤", "ðŸ§‹", "ðŸ¶", "ðŸ¾",
        "ðŸ·", "ðŸ¸", "ðŸ¹", "ðŸº", "ðŸ»", "ðŸ¥‚", "ðŸ¥ƒ", "ðŸ§Š", "ðŸ¥›", "ðŸ¼", "ðŸ¯", "ðŸ§‚", "ðŸ’§"
      ],
      "Activities & Sports": [
        "âš½", "ðŸ€", "ðŸˆ", "âš¾", "ðŸ¥Ž", "ðŸŽ¾", "ðŸ", "ðŸ‰", "ðŸ¥", "ðŸŽ±", "ðŸª€", "ðŸ“", "ðŸ¸", "ðŸ’", "ðŸ‘", "ðŸ¥", "ðŸ",
        "ðŸªƒ", "ðŸ¥…", "â›³", "ðŸª", "ðŸ¹", "ðŸŽ£", "ðŸ¤¿", "ðŸ¥Š", "ðŸ¥‹", "ðŸŽ½", "ðŸ›¹", "ðŸ›¼", "ðŸ›´", "â›·ï¸", "ðŸ‚", "ðŸª‚", "ðŸ‹ï¸â€â™€ï¸",
        "ðŸ‹ï¸â€â™‚ï¸", "ðŸ¤¼â€â™€ï¸", "ðŸ¤¼â€â™‚ï¸", "ðŸ¤¸â€â™€ï¸", "ðŸ¤¸â€â™‚ï¸", "â›¹ï¸â€â™€ï¸", "â›¹ï¸â€â™‚ï¸", "ðŸ¤º", "ðŸ¤¾â€â™€ï¸", "ðŸ¤¾â€â™‚ï¸", "ðŸŒï¸â€â™€ï¸", "ðŸŒï¸â€â™‚ï¸",
        "ðŸ‡", "ðŸ§˜â€â™€ï¸", "ðŸ§˜â€â™‚ï¸", "ðŸ„â€â™€ï¸", "ðŸ„â€â™‚ï¸", "ðŸŠâ€â™€ï¸", "ðŸŠâ€â™‚ï¸", "ðŸ¤½â€â™€ï¸", "ðŸ¤½â€â™‚ï¸", "ðŸš£â€â™€ï¸", "ðŸš£â€â™‚ï¸", "ðŸ§—â€â™€ï¸", "ðŸ§—â€â™‚ï¸",
        "ðŸšµâ€â™€ï¸", "ðŸšµâ€â™‚ï¸", "ðŸš´â€â™€ï¸", "ðŸš´â€â™‚ï¸", "ðŸŽ¯", "ðŸŽª", "ðŸŽ¨", "ðŸŽ¬", "ðŸŽ¤", "ðŸŽ§", "ðŸŽ¼", "ðŸŽµ", "ðŸŽ¶", "ðŸŽ¹", "ðŸ¥", "ðŸª˜",
        "ðŸŽ·", "ðŸŽº", "ðŸª—", "ðŸŽ¸", "ðŸª•", "ðŸŽ»", "ðŸŽ²", "â™ ï¸", "â™¥ï¸", "â™¦ï¸", "â™£ï¸", "â™Ÿï¸", "ðŸƒ", "ðŸ€„", "ðŸŽ´", "ðŸŽ­", "ðŸ–¼ï¸", "ðŸŽ¨"
      ],
      "Travel & Places": [
        "ðŸ ", "ðŸ¡", "ðŸ˜ï¸", "ðŸšï¸", "ðŸ—ï¸", "ðŸ­", "ðŸ¢", "ðŸ¬", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¦", "ðŸ¨", "ðŸª", "ðŸ«", "ðŸ©", "ðŸ’’",
        "ðŸ›ï¸", "â›ª", "ðŸ•Œ", "ðŸ•", "ðŸ›•", "ðŸ•‹", "â›©ï¸", "ðŸ›¤ï¸", "ðŸ›£ï¸", "ðŸ—¾", "ðŸžï¸", "ðŸŸï¸", "ðŸ›ï¸", "ðŸ—ï¸", "ðŸ§±", "ðŸª¨", "ðŸªµ",
        "ðŸ›–", "ðŸ˜ï¸", "ðŸ™ï¸", "ðŸŒ†", "ðŸŒ‡", "ðŸŒƒ", "ðŸ—¼", "ðŸ—ï¸", "ðŸŽ¡", "ðŸŽ¢", "ðŸŽ ", "â›±ï¸", "ðŸ–ï¸", "ðŸœï¸", "ðŸï¸", "ðŸžï¸",
        "ðŸš—", "ðŸš•", "ðŸš™", "ðŸšŒ", "ðŸšŽ", "ðŸŽï¸", "ðŸš“", "ðŸš‘", "ðŸš’", "ðŸš", "ðŸ›»", "ðŸšš", "ðŸš›", "ðŸšœ", "ðŸï¸", "ðŸ›µ", "ðŸš²",
        "ðŸ›´", "ðŸ›¹", "ðŸ›¼", "ðŸš", "ðŸ›¸", "âœˆï¸", "ðŸ›©ï¸", "ðŸ›«", "ðŸ›¬", "ðŸª‚", "ðŸ’º", "ðŸš€", "ðŸ›°ï¸", "ðŸš‰", "ðŸšž", "ðŸš", "ðŸš„",
        "ðŸš…", "ðŸšˆ", "ðŸš‚", "ðŸš†", "ðŸš‡", "ðŸšŠ", "ðŸšŸ", "ðŸš ", "ðŸš¡", "ðŸ›³ï¸", "â›µ", "ðŸš¤", "ðŸ›¥ï¸", "ðŸ›¶", "â›´ï¸", "ðŸš¢", "âš“",
        "ðŸª", "â›½", "ðŸš§", "ðŸš¦", "ðŸš¥", "ðŸ—ºï¸", "ðŸ›ï¸", "ðŸ›‹ï¸", "ðŸª‘", "ðŸšª", "ðŸªŸ", "ðŸ›", "ðŸ›€"
      ],
      "Objects & Tools": [
        "ðŸ§¹", "ðŸ§½", "ðŸª£", "ðŸ§´", "ðŸ§¼", "ðŸª’", "ðŸ§³", "âŒš", "ðŸ“±", "ðŸ“²", "ðŸ’»", "âŒ¨ï¸", "ðŸ–¥ï¸", "ðŸ–¨ï¸", "ðŸ–±ï¸", "ðŸ–²ï¸", "ðŸ•¹ï¸",
        "ðŸ—œï¸", "ðŸ’¾", "ðŸ’¿", "ðŸ“€", "ðŸ“¼", "ðŸ“·", "ðŸ“¸", "ðŸ“¹", "ðŸŽ¥", "ðŸ“½ï¸", "ðŸŽžï¸", "ðŸ“ž", "â˜Žï¸", "ðŸ“Ÿ", "ðŸ“ ", "ðŸ“º", "ðŸ“»",
        "ðŸŽ™ï¸", "ðŸŽšï¸", "ðŸŽ›ï¸", "ðŸ§­", "â±ï¸", "â²ï¸", "â°", "ðŸ•°ï¸", "âŒ›", "â³", "ðŸ“¡", "ðŸ”‹", "ðŸª«", "ðŸ”Œ", "ðŸ’¡", "ðŸ”¦", "ðŸ•¯ï¸",
        "ðŸª”", "ðŸ§¯", "ðŸ›¢ï¸", "ðŸ’¸", "ðŸ’µ", "ðŸ’´", "ðŸ’¶", "ðŸ’·", "ðŸª™", "ðŸ’°", "ðŸ’³", "ðŸ’Ž", "âš–ï¸", "ðŸªœ", "ðŸ§°", "ðŸª›", "ðŸ”§",
        "ðŸ”¨", "âš’ï¸", "ðŸ› ï¸", "â›ï¸", "ðŸªš", "ðŸ”©", "âš™ï¸", "ðŸª¤", "ðŸ§²", "ðŸ”«", "ðŸ’£", "ðŸ§¨", "ðŸª“", "ðŸ”ª", "ðŸ—¡ï¸", "âš”ï¸", "ðŸ›¡ï¸",
        "ðŸš¬", "âš°ï¸", "ðŸª¦", "âš±ï¸", "ðŸº", "ðŸ”®", "ðŸ“¿", "ðŸ§¿", "ðŸª¬", "ðŸ’ˆ", "âš—ï¸", "ðŸ”­", "ðŸ”¬", "ðŸ•³ï¸", "ðŸ©¹", "ðŸ©º", "ðŸ’Š",
        "ðŸ’‰", "ðŸ§¬", "ðŸ¦ ", "ðŸ§«", "ðŸ§ª", "ðŸŒ¡ï¸", "ðŸ§¹", "ðŸ§º", "ðŸ§»", "ðŸª£", "ðŸ§´", "ðŸ§¼", "ðŸª¥", "ðŸª’", "ðŸ§½", "ðŸª£", "ðŸ§°",
        "ðŸ“¦", "ðŸ“‹", "ðŸ“Œ", "ðŸ“", "ðŸ“Ž", "ðŸ–‡ï¸", "ðŸ“", "ðŸ“", "âœ‚ï¸", "ðŸ—ƒï¸", "ðŸ—„ï¸", "ðŸ—‘ï¸", "ðŸ”’", "ðŸ”“", "ðŸ”", "ðŸ”", "ðŸ”‘",
        "ðŸ—ï¸", "ðŸ”¨", "ðŸª“", "â›ï¸", "âš’ï¸", "ðŸ› ï¸", "ðŸ—¡ï¸", "ðŸ”«", "ðŸªƒ", "ðŸ¹", "ðŸ›¡ï¸", "ðŸªš", "ðŸ”§", "ðŸª›", "ðŸ”©", "âš™ï¸", "ðŸ—œï¸",
        "âš–ï¸", "ðŸ¦¯", "ðŸ”—", "â›“ï¸", "ðŸª", "ðŸ§°", "ðŸ§²", "ðŸªœ", "ðŸŽ¯", "ðŸ†", "ðŸ…", "ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰", "ðŸŽ–ï¸", "ðŸŽ—ï¸", "ðŸŽ«",
        "ðŸŽŸï¸", "ðŸŽª", "ðŸŽ­", "ðŸŽ¨", "ðŸŽ¬", "ðŸŽ¤", "ðŸŽ§", "ðŸŽ¼", "ðŸŽµ", "ðŸŽ¶", "ðŸŽ¹", "ðŸ¥", "ðŸª˜", "ðŸŽ·", "ðŸŽº", "ðŸª—", "ðŸŽ¸",
        "ðŸª•", "ðŸŽ»", "ðŸŽ²", "â™ ï¸", "â™¥ï¸", "â™¦ï¸", "â™£ï¸", "â™Ÿï¸", "ðŸƒ", "ðŸ€„", "ðŸŽ´", "ðŸŽ‰", "ðŸŽŠ", "ðŸŽˆ", "ðŸŽ", "ðŸŽ€", "ðŸª…",
        "ðŸª†", "ðŸ””", "ðŸ”•", "ðŸ“¯", "ðŸ“¢", "ðŸ“£", "ðŸ“»", "ðŸ”Š", "ðŸ”‰", "ðŸ”ˆ", "ðŸ”‡", "ðŸ”•", "ðŸ“¯", "ðŸ“¢", "ðŸ“£", "ðŸ“ª", "ðŸ“«",
        "ðŸ“¬", "ðŸ“­", "ðŸ“®", "ðŸ—³ï¸", "âœï¸", "âœ’ï¸", "ðŸ–‹ï¸", "ðŸ–Šï¸", "ðŸ–Œï¸", "ðŸ–ï¸", "ðŸ“", "ðŸ’¼", "ðŸ“", "ðŸ“‚", "ðŸ—‚ï¸", "ðŸ“…", "ðŸ“†",
        "ðŸ—’ï¸", "ðŸ—“ï¸", "ðŸ“‡", "ðŸ“ˆ", "ðŸ“‰", "ðŸ“Š", "ðŸ“‹", "ðŸ“Œ", "ðŸ“", "ðŸ“Ž", "ðŸ–‡ï¸", "ðŸ“", "ðŸ“", "âœ‚ï¸", "ðŸ—ƒï¸", "ðŸ—„ï¸", "ðŸ—‘ï¸"
      ]
    };

    // Simple flat array for backwards compatibility
    const taskEmojis = Object.values(emojiCategories).flat();

    // Main App Component
    const App = () => {
      // Default to localStorage, Firestore will override for logged-in users
      const [tasks, setTasks] = useState(getInitialState().tasks);
      const [users, setUsers] = useState(getInitialState().users);
      const [customBadges, setCustomBadges] = useState(getInitialState().customBadges);
      const [taskCompletions, setTaskCompletions] = useState(getInitialState().taskCompletions);
      const [lastWeeklyReset, setLastWeeklyReset] = useState(getInitialState().lastWeeklyReset);
      const [lastResetDate, setLastResetDate] = useState(getInitialState().lastResetDate);

      // UI/Form-related state ---
      const [newTask, setNewTask] = useState({ name: "", frequency: "Daily", assignee: "Mom", points: 0, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "", startDate: new Date().toISOString().split('T')[0], emoji: "", active: true, timeOfDay: "Anytime" });
      const [showPresets, setShowPresets] = useState(false);

      // Subscription Management State
      const [subscriptionData, setSubscriptionData] = useState({
        status: 'none', // 'none', 'active', 'expired', 'cancelled'
        subscriptionEndDate: null,
        plan: null, // 'monthly', 'yearly'
        customerId: null,
        subscriptionId: null
      });
      const [showPaywall, setShowPaywall] = useState(false);

      // Page routing and onboarding state
      const [currentPage, setCurrentPage] = useState(() => {
        const hasCompletedOnboarding = localStorage.getItem("hasCompletedOnboarding");
        return hasCompletedOnboarding ? PAGES.TASKS : PAGES.ONBOARDING;
      });
      const [onboardingStep, setOnboardingStep] = useState(0);

      // Auth and Data Loading State
      const [currentUser, setCurrentUser] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [isSaving, setIsSaving] = useState(false);
      const dataSyncTimer = useRef(null);
      const isInitialLoad = useRef(true); // Prevents initial state from overwriting Firestore

      const [showPageTransition, setShowPageTransition] = useState(false);
      const [view, setView] = useState("tasks");
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [editingBadge, setEditingBadge] = useState(null);
      const [newCustomBadge, setNewCustomBadge] = useState({ name: "", emoji: "ðŸ…", description: "", points: 0 });
      const [editingTask, setEditingTask] = useState(null);
      const [editedTaskData, setEditedTaskData] = useState({});
      const [badgeNotifications, setBadgeNotifications] = useState({});
      const [showMenu, setShowMenu] = useState(false);
      const [selectedProfile, setSelectedProfile] = useState(null);
      const [editingProfile, setEditingProfile] = useState(null);
      const [showEmojiPicker, setShowEmojiPicker] = useState(false);
      const [emojiPickerTarget, setEmojiPickerTarget] = useState(null);
      const [selectedEmojiCategory, setSelectedEmojiCategory] = useState("Smileys & People");
      const [showPostPaymentButton, setShowPostPaymentButton] = useState(false);

      // *** SECURITY: Check for payment bypass attempts ***
      const checkForPaymentBypass = () => {
        if (location.search.includes('success=true')) return false;
        if (location.search.includes('signup=true')) return false;
        const pendingSignup = localStorage.getItem("pendingSignup");
        const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
        
        // If user has pending signup data but no valid subscription, they're trying to bypass payment
        if ((pendingSignup || pendingGoogleSignup) && (!currentUser || subscriptionData.status !== 'active')) {
          console.warn("ðŸš¨ Potential payment bypass detected - clearing fake data");
          localStorage.removeItem("pendingSignup");
          localStorage.removeItem("pendingGoogleSignup");
          return true;
        }
          return false;
      };

      // Check for payment bypass on app load
      useEffect(() => {
        if (!location.search.includes('success=true')) {
          if (checkForPaymentBypass()) {
            console.log('ðŸ”’ Payment bypass attempt blocked');
          }
        }
      }, []);

      // *** SECURITY: Server-side payment verification ***
      const verifyPaymentWithServer = async (email) => {
        try {
          const response = await fetch('/api/verify-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email })
          });

          if (!response.ok) {
            console.error("âŒ Payment verification failed:", response.status);
          return false;
        }
        
          const result = await response.json();
          return result.hasValidPayment || false;
        } catch (error) {
          console.error("âŒ Error verifying payment:", error);
          return false;
        }
      };

      // *** SUBSCRIPTION HELPER FUNCTIONS ***
      
      // Check if user has paid subscription (now includes expiration check)
      const hasActiveSubscription = () => {
        if (!currentUser || subscriptionData.status !== 'active') {
          return false;
        }
        // Check if subscription has expired based on end date
        if (subscriptionData.subscriptionEndDate) {
          const endDate = new Date(subscriptionData.subscriptionEndDate);
        const now = new Date();
          
          if (now > endDate) {
            // Subscription has expired - update status
            console.log('âš ï¸ Subscription has expired:', subscriptionData.subscriptionEndDate);
            setSubscriptionData(prev => ({
              ...prev,
              status: 'expired'
            }));
        return false;
          }
        }
        
        return true;
      };

      // Check subscription expiration on app load and periodically
      useEffect(() => {
        if (!currentUser || subscriptionData.status !== 'active') return;

        const checkExpiration = () => {
          if (subscriptionData.subscriptionEndDate) {
            const endDate = new Date(subscriptionData.subscriptionEndDate);
        const now = new Date();
            
            if (now > endDate) {
              console.log('ðŸš¨ Subscription expired on:', subscriptionData.subscriptionEndDate);
              setSubscriptionData(prev => ({
                ...prev,
                status: 'expired'
              }));
              alert('âš ï¸ Your subscription has expired. Please renew to continue using Farm Fam.');
            }
          }
        };

        // Check immediately
        checkExpiration();

        // Check every hour
        const interval = setInterval(checkExpiration, 60 * 60 * 1000);
        
        return () => clearInterval(interval);
      }, [currentUser, subscriptionData.subscriptionEndDate, subscriptionData.status]);

      

      // Initialize a new user's data in Firestore (only after payment)
      const initializeFirestoreData = async (user, familyName, subscriptionInfo) => {
        if (!user || !user.uid) {
          console.error("âŒ No user or user.uid provided to initializeFirestoreData");
          return;
        }
        
        const { db, doc, setDoc } = window.firebaseDb;
        const userDocRef = doc(db, 'families', user.uid);

        const initialData = {
          familyName: familyName,
          createdAt: new Date().toISOString(),
          tasks: initialTasks,
          users: initialUsers,
          customBadges: {},
          taskCompletions: {},
          lastWeeklyReset: null,
          lastResetDate: new Date().toDateString(),
          subscriptionData: subscriptionInfo
        };

        try {
          await setDoc(userDocRef, initialData);
          setSubscriptionData(subscriptionInfo);
          // Also save the local userAccount info for display purposes
          localStorage.setItem("userAccount", JSON.stringify({
            uid: user.uid,
            email: user.email,
            familyName: familyName,
            createdAt: initialData.createdAt
          }));
          navigateToPage(PAGES.TASKS);
        } catch (error) {
          console.error("âŒ Error initializing Firestore data:", error);
          console.error("Error code:", error.code);
          console.error("Error message:", error.message);
          console.error("Current auth state:", window.firebaseAuth.auth.currentUser);
          alert("Could not initialize your account data. Please try again.");
          throw error; // Re-throw so the calling function can handle it
        }
      };

      // Check authentication state on app load and set up data listener
      useEffect(() => {
        if (!window.firebaseAuth || !window.firebaseDb) return;
        const { auth, onAuthStateChanged } = window.firebaseAuth;
        const { db, doc, onSnapshot } = window.firebaseDb;
        let currentFirestoreListener = null; // Track the current listener

        const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
            // Clean up any existing Firestore listener first
            if (currentFirestoreListener) {
                currentFirestoreListener();
                currentFirestoreListener = null;
            }

            // If pending signup, do NOT treat as logged in
            const pendingEmailSignup = localStorage.getItem("pendingSignup");
            const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
            
            if ((pendingEmailSignup || pendingGoogleSignup) && user) {
                // Check if we're in the middle of post-payment signup
                const isPostPaymentSignup = window.location.search.includes('success=true') 
                                            || location.search.includes('success=true')
                                            || document.querySelector('[data-post-payment="true"]');
                
                if (isPostPaymentSignup) {
                    setCurrentUser(user);
                    setIsLoading(false);
                    return;
                }
                
                // For Google signup, we need to handle the family name prompt first
                // Don't sign out immediately - let the Google signup flow handle it
                if (pendingGoogleSignup) {
                    // The Google signup flow will handle signing out after family name is entered
                    setCurrentUser(user);
                    setIsLoading(false);
                    return;
                }

                if (pendingEmailSignup) {
                    // The Email signup flow will handle signing out after family name is entered
                    setCurrentUser(user);
                    setIsLoading(false);
                    return;
                }
                
                // For email signup, sign out immediately
                window.firebaseAuth.signOut(auth);
                setCurrentUser(null);
                isInitialLoad.current = false;
                setIsLoading(false);
                return;
            }

            if (user) {
                // --- USER IS LOGGED IN ---
                setCurrentUser(user);

                const userDocRef = doc(db, 'families', user.uid);

                currentFirestoreListener = onSnapshot(userDocRef, (docSnap) => {
                    setIsLoading(true);
                    if (docSnap.exists()) {
                        console.log("Firestore data received.");
                        const data = docSnap.data();

                        // Load data from Firestore
                        setTasks(data.tasks || initialTasks);
                        setUsers(data.users || initialUsers);
                        setCustomBadges(data.customBadges || {});
                        setTaskCompletions(data.taskCompletions || {});
                        setLastWeeklyReset(data.lastWeeklyReset || null);
                        setLastResetDate(data.lastResetDate || new Date().toDateString());

                        // Load subscription data (simplified)
                        if (data.subscriptionData) {
                          setSubscriptionData(data.subscriptionData);
                        } else {
                          // User has no subscription data - they need to pay
                          setSubscriptionData({
                            status: 'none',
                            subscriptionEndDate: null,
                            plan: null,
                            customerId: null,
                            subscriptionId: null
                          });
                        }

                        // Set flag to allow saving updates
                        isInitialLoad.current = false;
                    } else {
                        // Document doesn't exist - this case is handled by signup
                        isInitialLoad.current = false;
                    }
                    setIsLoading(false);
                }, (error) => {
                    console.error("Firestore snapshot error:", error);
                    if (error.code === "permission-denied" || error.message.includes("Missing or insufficient permissions")) {
                        // Show paywall or friendly message
                        setShowPaywall(true); // or set a custom state to show a message
                    } else {
                        // Other errors
                    alert("Error loading your data. Please refresh.");
                    }
                    setIsLoading(false);
                });
            } else {
                // --- USER IS A GUEST ---
                setCurrentUser(null);

                // Load from localStorage
                const localData = getInitialState();
                setTasks(localData.tasks);
                setUsers(localData.users);
                setCustomBadges(localData.customBadges);
                setTaskCompletions(localData.taskCompletions);
                setLastWeeklyReset(localData.lastWeeklyReset);
                setLastResetDate(localData.lastResetDate);

                isInitialLoad.current = false;
                setIsLoading(false);
            }

            // Cleanup the previous listener when auth state changes
            return () => {
              unsubscribeAuth();
              if (currentFirestoreListener) {
                  currentFirestoreListener();
              }
            };
        });

        // Cleanup both listeners when the component unmounts
        return () => unsubscribeAuth();
      }, []);

      // Effect to save data to Firestore (for logged-in users) or localStorage (for guests/expired)
      useEffect(() => {
        // Don't save on the very first render before data is loaded
        if (isInitialLoad.current) return;

        // Clear any existing timer
        if (dataSyncTimer.current) {
            clearTimeout(dataSyncTimer.current);
        }

        if (currentUser && hasActiveSubscription()) {
            setIsSaving(true);
            dataSyncTimer.current = setTimeout(async () => {
                const { db, doc, setDoc } = window.firebaseDb;
                const userDocRef = doc(db, 'families', currentUser.uid);

                const dataToSave = {
                    tasks,
                    users,
                    customBadges,
                    taskCompletions,
                    lastWeeklyReset,
                    lastResetDate,
                    subscriptionData
                };

                try {
                    // Using { merge: true } is a good practice, though we are saving the whole object.
                    await setDoc(userDocRef, dataToSave, { merge: true });
                    console.log("âœ… Data saved to Firestore.");
                    navigateToPage(PAGES.TASKS);
                } catch (error) {
                    console.error("Error saving data to Firestore:", error);
                } finally {
                    setIsSaving(false);
                }
            }, 1500); // Debounce for 1.5 seconds
        } else {
            // --- GUEST USER OR EXPIRED USER: Save to localStorage immediately ---
            localStorage.setItem("tasks", JSON.stringify(tasks));
            localStorage.setItem("users", JSON.stringify(users));
            localStorage.setItem("customBadges", JSON.stringify(customBadges));
            localStorage.setItem("taskCompletions", JSON.stringify(taskCompletions));
            localStorage.setItem("lastWeeklyReset", lastWeeklyReset);
            localStorage.setItem("lastResetDate", lastResetDate);
            
            if (currentUser && subscriptionData.status === 'expired') {
              console.log("ðŸ’¾ Expired user - saving to localStorage only");
            }
        }

      }, [tasks, users, customBadges, taskCompletions, lastWeeklyReset, lastResetDate, subscriptionData, currentUser]);


      const getDateKey = (date) => date.toDateString();

      const isFutureDate = (date) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const inputDate = new Date(date);
        inputDate.setHours(0, 0, 0, 0);
        return inputDate > today;
      };

      const isNotToday = (date) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const inputDate = new Date(date);
        inputDate.setHours(0, 0, 0, 0);
        return inputDate.getTime() !== today.getTime();
      };

      // Close menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (showMenu && !event.target.closest('nav')) {
            setShowMenu(false);
          }
        };

        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showMenu]);

      useEffect(() => {
        const checkMidnightReset = () => {
          const now = new Date();
          const today = now.toDateString();

          if (lastResetDate && lastResetDate !== today) {
            // For guest users, reset everything at midnight
            if (!currentUser) {
              // Clear all guest data
              localStorage.removeItem("tasks");
              localStorage.removeItem("users");
              localStorage.removeItem("customBadges");
              localStorage.removeItem("taskCompletions");
              localStorage.removeItem("lastWeeklyReset");

              // Reset to initial state
              setTasks(initialTasks);
              setUsers(initialUsers);
              setCustomBadges({});
              setTaskCompletions({});
              setLastWeeklyReset(null);

              console.log("Guest mode data reset at midnight");
            }
            // For authenticated users, don't reset anything daily - badges persist until weekly reset

            setLastResetDate(today);
          }
        };

        checkMidnightReset();
        const now = new Date();
        const midnight = new Date();
        midnight.setHours(24, 0, 0, 0);
        const msUntilMidnight = midnight.getTime() - now.getTime();

        const midnightTimeout = setTimeout(() => {
          checkMidnightReset();
          const dailyInterval = setInterval(checkMidnightReset, 24 * 60 * 60 * 1000);
          return () => clearInterval(dailyInterval);
        }, msUntilMidnight);

        return () => clearTimeout(midnightTimeout);
      }, [lastResetDate, currentUser]);

      const getWeekStart = (date) => {
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(date.setDate(diff)).toDateString();
      };

      useEffect(() => {
        const checkWeeklyReset = () => {
          const now = new Date();
          const currentWeekStart = getWeekStart(now);

          if (!lastWeeklyReset || lastWeeklyReset !== currentWeekStart) {
            // Reset points and badges for the new week
            const resetUsers = users.map(user => ({ ...user, points: 0, badges: [] }));
            setUsers(resetUsers);
            setLastWeeklyReset(currentWeekStart);
            console.log("Weekly reset: cleared points and badges for new week");
          }
        };

        checkWeeklyReset();
        const dailyInterval = setInterval(checkWeeklyReset, 24 * 60 * 60 * 1000);
        return () => clearInterval(dailyInterval);
      }, [users, lastWeeklyReset]);


      const addTask = (e) => {
        if (e) e.preventDefault();
        if (!newTask.name || (newTask.frequency !== 'Once' && newTask.daysOfWeek.length === 0)) return;
        setTasks([...tasks, { id: Date.now(), ...newTask }]);
        setNewTask({ name: "", frequency: "Daily", assignee: users[0]?.name || "Mom", points: 0, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "", startDate: new Date().toISOString().split('T')[0], emoji: "", active: true, timeOfDay: "Anytime" });
        setShowPresets(false);
        navigateToPage(PAGES.TASKS);
      };

      const selectPresetTask = (preset) => {
        setNewTask({
          ...newTask,
          name: preset.name,
          points: preset.points,
          frequency: preset.frequency,
          notes: preset.notes,
          emoji: preset.emoji,
          active: preset.active,
          daysOfWeek: preset.daysOfWeek || (preset.frequency === "Daily" ? ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] : ["Monday"]),
          timeOfDay: preset.timeOfDay || "Anytime"
        });
        setShowPresets(false);
      };

      const getTasksForDay = (dayOfWeek) => {
        return tasks.filter(task => {
          // Only include active tasks
          if (task.active === false) return false;

          // Handle "Once" frequency - only show if it matches the start date
          if (task.frequency === "Once") {
            const taskStartDate = new Date(task.startDate);
            const currentDate = new Date(selectedDate);
            taskStartDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);
            return taskStartDate.getTime() === currentDate.getTime();
          }

          if (!task.daysOfWeek || task.daysOfWeek.length === 0) {
            return false;
          }
          return task.daysOfWeek.includes(dayOfWeek);
        });
      };

      const getCurrentDayName = () => selectedDate.toLocaleDateString('en-US', { weekday: 'long' });

      const deleteTask = (id) => setTasks(tasks.filter(task => task.id !== id));

      const duplicateTask = (task) => {
        const duplicatedTask = {
          ...task,
          id: Date.now(),
          name: `${task.name} (Copy)`
        };

        // Find the index of the original task
        const originalIndex = tasks.findIndex(t => t.id === task.id);

        // Create new tasks array with the copy inserted right after the original
        const newTasks = [...tasks];
        newTasks.splice(originalIndex + 1, 0, duplicatedTask);

        setTasks(newTasks);
      };

      const updateTask = (taskId, updatedTask) => {
        // Find the old task before update
        const oldTask = tasks.find(task => task.id === taskId);
        setTasks(tasks.map(task => task.id === taskId ? { ...task, ...updatedTask } : task));
        setEditingTask(null);
        setEditedTaskData({});

        // If points or assignee changed, update user points for completed dates
        if ((updatedTask.points !== undefined && oldTask.points !== updatedTask.points) || (updatedTask.assignee && oldTask.assignee !== updatedTask.assignee)) {
          setUsers(prevUsers => {
            // For each user, recalculate points based on completions
            return prevUsers.map(user => {
              let points = user.points;
              // For each date, if this task was completed, adjust points
              Object.entries(taskCompletions).forEach(([dateKey, completions]) => {
                if (completions[taskId]) {
                  // If user was the old assignee, remove old points
                  if (user.name === oldTask.assignee) {
                    points -= oldTask.points;
                  }
                  // If user is the new assignee, add new points
                  if (user.name === (updatedTask.assignee || oldTask.assignee)) {
                    points += updatedTask.points !== undefined ? updatedTask.points : oldTask.points;
                  }
                }
              });
              // Prevent negative points
              points = Math.max(0, points);
              return { ...user, points };
            });
          });
        }
      };

      const systemBadges = {
        "First Timer": { emoji: "ðŸ£", description: "Complete your first task", points: 0, isCustom: false },
        "Daily Hero": { emoji: "â­", description: "Complete 5 daily tasks", points: 0, isCustom: false },
        "Century Club": { emoji: "ðŸ’¯", description: "Earn 100 points", points: 100, isCustom: false },
        "Egg Expert": { emoji: "ðŸ¥š", description: "Complete 'Collect Eggs' 5 times", points: 0, isCustom: false },
        "Feed Master": { emoji: "ðŸŒ¾", description: "Complete 'Feed Chickens' 7 times", points: 0, isCustom: false },
        "Clean Machine": { emoji: "ðŸ§¹", description: "Complete any cleaning task 3 times", points: 0, isCustom: false },
        "Streak Master": { emoji: "ðŸ”¥", description: "Complete all your daily tasks", points: 0, isCustom: false },
        "Team Player": { emoji: "ðŸ¤", description: "Family completes all tasks in a day", points: 0, isCustom: false }
      };

      const badgeDefinitions = {
        ...Object.fromEntries(Object.entries(systemBadges).filter(([badgeName]) => !customBadges[badgeName]?.deleted)),
        ...Object.fromEntries(Object.entries(customBadges).filter(([_, badgeInfo]) => !badgeInfo.deleted))
      };

      const addCustomBadge = (e) => {
        e.preventDefault();
        if (!newCustomBadge.name || !newCustomBadge.description) return;
        const updatedCustomBadges = {
          ...customBadges,
          [newCustomBadge.name]: {
            emoji: newCustomBadge.emoji,
            description: newCustomBadge.description,
            points: newCustomBadge.points,
            isCustom: true
          }
        };
        setCustomBadges(updatedCustomBadges);

        // Immediately check if any users already meet the requirements for this new badge
        setUsers(prevUsers => {
          return prevUsers.map(user => {
            const userTasks = tasks.filter(t => t.assignee === user.name);
            const updatedUser = { ...user };

            // Check if user meets the requirements for the new badge
            if (newCustomBadge.points > 0 && user.points >= newCustomBadge.points && !user.badges.includes(newCustomBadge.name)) {
              updatedUser.badges = [...user.badges, newCustomBadge.name];
            }

            return updatedUser;
          });
        });

        setNewCustomBadge({ name: "", emoji: "ðŸ…", description: "", points: 0 });
      };

      const updateBadge = (badgeName, updatedInfo) => {
        const updatedCustomBadges = {
          ...customBadges,
          [badgeName]: { ...updatedInfo, isCustom: badgeDefinitions[badgeName]?.isCustom }
        };
        setCustomBadges(updatedCustomBadges);

        // Only check user badges when editing is complete, not on every keystroke
        // This prevents the form from closing while typing
      };

      const saveBadgeChanges = (badgeName, updatedInfo) => {
        // Immediately check if any users meet the updated requirements for this badge
        setUsers(prevUsers => {
          return prevUsers.map(user => {
            const updatedUser = { ...user };
            const hasBadge = user.badges.includes(badgeName);
            const meetsRequirements = updatedInfo.points > 0 && user.points >= updatedInfo.points;

            if (meetsRequirements && !hasBadge) {
              // User meets requirements but doesn't have badge - award it
              updatedUser.badges = [...user.badges, badgeName];
            } else if (!meetsRequirements && hasBadge) {
              // User no longer meets requirements but has badge - remove it
              updatedUser.badges = user.badges.filter(badge => badge !== badgeName);
            }

            return updatedUser;
          });
        });

        setEditingBadge(null);
      };

      const deleteBadge = (badgeName) => {
        if (!badgeDefinitions[badgeName]?.isCustom) {
          const updatedCustomBadges = {
            ...customBadges,
            [badgeName]: { ...badgeDefinitions[badgeName], deleted: true }
          };
          setCustomBadges(updatedCustomBadges);
        } else {
          const updatedCustomBadges = { ...customBadges };
          delete updatedCustomBadges[badgeName];
          setCustomBadges(updatedCustomBadges);
        }
        setUsers(users.map(user => ({
          ...user,
          badges: user.badges.filter(badge => badge !== badgeName)
        })));
      };

      const awardCustomBadge = (userName, badgeName) => {
        setUsers(users.map(user => 
          user.name === userName && !user.badges.includes(badgeName) ? { ...user, badges: [...user.badges, badgeName] } : user
        ));
      };

      const checkBadges = (user, userTasks, allTasks, allUsers) => {
        return checkBadgesWithCompletions(user, userTasks, allTasks, allUsers, taskCompletions);
      };

      const checkBadgesWithCompletions = (user, userTasks, allTasks, allUsers, completions) => {
        let newBadges = [];

        // Helper function to check if task is completed with given completions
        const isTaskCompletedInState = (taskId, date, completionsState) => {
          const dateKey = getDateKey(date);
          const dateCompletions = completionsState[dateKey];
          return dateCompletions ? dateCompletions[taskId] || false : false;
        };

        // Get all completed tasks for this user across all time (for cumulative badges)
        const allCompletedTasks = [];
        Object.keys(completions).forEach(dateKey => {
          const dayCompletions = completions[dateKey];
          Object.keys(dayCompletions).forEach(taskId => {
            if (dayCompletions[taskId]) {
              const task = userTasks.find(t => t.id === parseInt(taskId));
              if (task) {
                allCompletedTasks.push(task);
              }
            }
          });
        });

        // Today's completed tasks using current completion state
        const todayCompletedTasks = userTasks.filter(t => isTaskCompletedInState(t.id, selectedDate, completions));
        const todayDailyTasks = todayCompletedTasks.filter(t => t.frequency === "Daily");
        if (allCompletedTasks.length >= 1) newBadges.push("First Timer");
        if (todayDailyTasks.length >= 5) newBadges.push("Daily Hero");
        if (user.points >= 100) newBadges.push("Century Club");
        if (allCompletedTasks.filter(t => t.name.toLowerCase().includes("egg")).length >= 5) newBadges.push("Egg Expert");
        if (allCompletedTasks.filter(t => t.name.toLowerCase().includes("feed")).length >= 7) newBadges.push("Feed Master");
        if (allCompletedTasks.filter(t => t.name.toLowerCase().includes("clean")).length >= 3) newBadges.push("Clean Machine");

        const userDailyTasks = userTasks.filter(t => {
          const currentDay = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
          return t.daysOfWeek && t.daysOfWeek.includes(currentDay);
        });
        const completedDailyTasks = userDailyTasks.filter(t => isTaskCompletedInState(t.id, selectedDate, completions));
        if (userDailyTasks.length > 0 && completedDailyTasks.length === userDailyTasks.length) newBadges.push("Streak Master");

        const todayTasks = allTasks.filter(t => {
          const currentDay = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
          return t.daysOfWeek && t.daysOfWeek.includes(currentDay);
        });
        const allTasksCompleted = todayTasks.length > 0 && todayTasks.every(t => isTaskCompletedInState(t.id, selectedDate, completions));
        if (allTasksCompleted) newBadges.push("Team Player");

        // After system badge logic, before returning newBadges:
        Object.entries(badgeDefinitions).forEach(([badgeName, badgeInfo]) => {
          if (badgeInfo.isCustom && badgeInfo.points > 0) {
            if (user.points >= badgeInfo.points) {
              newBadges.push(badgeName);
            }
          }
        });

        return [...new Set(newBadges)];
      };

      const isTaskCompleted = (taskId, date) => {
        const dateKey = getDateKey(date);
        const dateCompletions = taskCompletions[dateKey];
        return dateCompletions ? dateCompletions[taskId] || false : false;
      };

      const toggleTask = (task) => {
        const dateKey = getDateKey(selectedDate);
        const wasCompleted = isTaskCompleted(task.id, selectedDate);
        const newCompletionStatus = !wasCompleted;

        // Update task completions first
        setTaskCompletions(prev => {
          const currentDateCompletions = prev[dateKey] || {};
          const newCompletions = {
            ...prev,
            [dateKey]: {
              ...currentDateCompletions,
              [task.id]: newCompletionStatus
            }
          };

          // Update users with the new completion state
          setUsers(prevUsers => {
            return prevUsers.map(u => {
              let newPoints = u.points;
              if (task.assignee === u.name) {
                newPoints = wasCompleted ? u.points - task.points : u.points + task.points;
              }

              const userTasks = tasks.filter(t => t.assignee === u.name);
              const updatedUser = { ...u, points: newPoints };

              // Check badges with the updated completion state
              const newBadges = checkBadgesWithCompletions(updatedUser, userTasks, tasks, prevUsers, newCompletions);
              return { ...updatedUser, badges: newBadges };
            });
          });

          return newCompletions;
        });
      };

      const getPersonColor = (assignee) => {
        const user = users.find(u => u.name === assignee);
        const userColor = user?.color;

        switch (userColor) {
          case "blue": return "bg-blue-200 text-blue-800";
          case "purple": return "bg-purple-200 text-purple-800";
          case "orange": return "bg-orange-200 text-orange-800";
          case "pink": return "bg-pink-200 text-pink-800";
          case "green": return "bg-green-200 text-green-800";
          case "red": return "bg-red-200 text-red-800";
          case "yellow": return "bg-yellow-200 text-yellow-800";
          case "indigo": return "bg-indigo-200 text-indigo-800";
              default: return "bg-gray-200 text-gray-800";
        }
      };

      const getPersonTextColor = (assignee) => {
        const user = users.find(u => u.name === assignee);
        const userColor = user?.color;

        switch (userColor) {
          case "blue": return "text-blue-600";
          case "purple": return "text-purple-600";
          case "orange": return "text-orange-600";
          case "pink": return "text-pink-600";
          case "green": return "text-green-600";
          case "red": return "text-red-600";
          case "yellow": return "text-yellow-600";
          case "indigo": return "text-indigo-600";
              default: return "text-gray-600";
        }
      };

      // Page navigation with smooth transitions
      const navigateToPage = (page, additionalState = {}) => {
        setShowPageTransition(true);
        setTimeout(() => {
          setCurrentPage(page);
          if (page === PAGES.TASKS) {
            setView("tasks");
            setSelectedProfile(null);
          } else if (page === PAGES.LEADERBOARD) {
            setView("leaderboard");
            setSelectedProfile(null);
          } else if (page === PAGES.PROFILE && additionalState.profile) {
            setView("profile");
            setSelectedProfile(additionalState.profile);
          } else if (page === PAGES.TASK_EDITOR) {
            setView("task-editor");
            setSelectedProfile(null);
          } else if (page === PAGES.BADGE_EDITOR) {
            setView("badge-editor");
            setSelectedProfile(null);
          }
          setShowPageTransition(false);
        }, 150);
      };

      const completeOnboarding = () => {
        localStorage.setItem("hasCompletedOnboarding", "true");
        navigateToPage(PAGES.TASKS);
      };

      const resetOnboarding = () => {
        localStorage.removeItem("hasCompletedOnboarding");
        setOnboardingStep(0);
        navigateToPage(PAGES.ONBOARDING);
      };

      // *** AUTHENTICATION FUNCTIONS - UPDATED FOR FIRESTORE ***
      const handleSignup = async (e, authForm) => {
        e.preventDefault();
        
        if (authForm.password !== authForm.confirmPassword) {
          alert("Passwords don't match!");
          return;
        }
        
        if (!authForm.email || !authForm.password || !authForm.familyName) {
          alert("Please fill in all fields!");
          return;
        }

        // Store signup info for after payment
        localStorage.setItem("pendingSignup", JSON.stringify(authForm));
        
        // Show paywall for required subscription
        setShowPaywall(true);
      };

      const handleLogin = async (e, authForm) => {
        e.preventDefault();
        if (!authForm.email || !authForm.password) {
          alert("Please fill in all fields!");
          return;
        }

        try {
          const result = await window.firebaseAuth.signInWithEmailAndPassword(
            window.firebaseAuth.auth,
            authForm.email,
            authForm.password
          );

          const user = result.user;
          console.log("Email login successful for:", user.email);

          const { db, doc, getDoc } = window.firebaseDb;
          const userDocRef = doc(db, 'families', user.uid);
          const docSnap = await getDoc(userDocRef);

          if (docSnap.exists()) {
              const data = docSnap.data();
              // This is the crucial step that was missing
              localStorage.setItem("userAccount", JSON.stringify({
                  uid: user.uid,
                  email: user.email,
                  familyName: data.familyName,
                  createdAt: data.createdAt
              }));
          } else {
              // This is an unlikely edge case, but good to have
              console.warn("User is authenticated but has no Firestore document!");
          }

          // onAuthStateChanged will handle data loading
          navigateToPage(PAGES.TASKS);
        } catch (error) {
          console.error("Login error:", error);
          if (error.code === "auth/invalid-login-credentials" || error.code === "auth/user-not-found" || error.code === "auth/wrong-password") {
            alert("Invalid email or password.");
          } else {
            alert(error.message);
          }
        }
      };

      const handleGoogleLogin = async () => {
        try {
          const result = await window.firebaseAuth.signInWithPopup(
            window.firebaseAuth.auth,
            window.firebaseAuth.googleProvider
          );
          const user = result.user;
          console.log("Google login successful for:", user.email);

          // Check if there's existing pending signup data for this email
          const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
          if (pendingGoogleSignup) {
            const signupData = JSON.parse(pendingGoogleSignup);
            if (signupData.email === user.email) {
              // Sign out and show paywall again
              await window.firebaseAuth.signOut(window.firebaseAuth.auth);
              setShowPaywall(true);
              return;
            }
          }

          // Check if Firestore document exists for this user
          const { db, doc, getDoc } = window.firebaseDb;
          const userDocRef = doc(db, 'families', user.uid);
          const docSnap = await getDoc(userDocRef);

          if (!docSnap.exists()) {
            // 1. Check Stripe for active subscription
            const response = await fetch('/api/restore-subscription', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: user.email })
            });
            const result = await response.json();
            if (result.subscription && result.subscription.status === 'active') {
              let familyName = "Uknown Family";
              familyName = prompt("Welcome! Please enter your Family Name to continue:");
              if (familyName === null) {
                await window.firebaseAuth.signOut(window.firebaseAuth.auth);
                return;
              }

              if (!user || !user.uid || user.uid === "pending") {
                alert("Google authentication failed. Please try again.");
                await window.firebaseAuth.signOut(window.firebaseAuth.auth);
                return;
              }
              // 2. Create Firestore doc and log in
              await initializeFirestoreData(user, familyName, {
                status: 'active',
                plan: result.subscription.plan,
                subscriptionEndDate: result.subscription.current_period_end,
                customerId: result.subscription.customer,
                subscriptionId: result.subscription.id
              });
              // Set userAccount, navigate, etc.
              return;
            } else {
              // 3. Prompt for family name, show paywall
              console.log("New Google user detected. Prompting for family name.");
              // let familyName = "";
              // while (!familyName || familyName.trim() === "") {
              //   familyName = prompt("Welcome! Please enter your Family Name to continue:");
              //   if (familyName === null) {
              //     console.log("User cancelled sign-up. Signing out.");
              //     await window.firebaseAuth.signOut(window.firebaseAuth.auth);
              //     return;
              //   }
              // }
            // Store Google signup info for after payment (like email signup)
            console.log("ðŸ”¥ New Google user needs to pay first");
              // localStorage.setItem("pendingGoogleSignup", JSON.stringify({
              //   uid: user.uid,
              //   email: user.email,
              //   familyName: familyName.trim(),
              //   provider: 'google'
              // }));
            // Sign out the Google user temporarily until payment is complete
            await window.firebaseAuth.signOut(window.firebaseAuth.auth);
            // Show paywall for required subscription
            setShowPaywall(true);
            // Do NOT set userAccount or navigate
            return;
            }
          } else {
            // Returning user logged in via Google
            const data = docSnap.data();
            localStorage.setItem("userAccount", JSON.stringify({
              uid: user.uid,
              email: user.email,
              familyName: data.familyName,
              createdAt: data.createdAt
            }));
            navigateToPage(PAGES.TASKS);
          }
        } catch (error) {
          if (error.code === 'auth/popup-closed-by-user') {
            return;
          }
          console.error("Google login error:", error);
        }
      };

      const handleLogout = async () => {
        if (confirm("Are you sure you want to log out?")) {
          try {
            await window.firebaseAuth.signOut(window.firebaseAuth.auth);
            // onAuthStateChanged will fire and reset the state to guest mode
            localStorage.removeItem("userAccount");
            navigateToPage(PAGES.LOGIN);
          } catch (error) {
            console.error("Logout error:", error);
            alert(error.message);
          }
        }
      };

      const getTaskEmoji = (taskName, taskEmoji) => {
        if (taskEmoji) return taskEmoji;
        const name = taskName.toLowerCase();
        if (name.includes('feed') && name.includes('chicken')) return "ðŸŒ¾";
        if (name.includes('egg')) return "ðŸ¥š";
        if (name.includes('clean') && name.includes('coop')) return "ðŸ§¹";
        if (name.includes('water') && name.includes('refill')) return "ðŸ’§";
        if (name.includes('water') && name.includes('clean')) return "ðŸ§½";
        if (name.includes('feed') && name.includes('storage')) return "ðŸ“¦";
        if (name.includes('free range') || name.includes('supervised')) return "ðŸ“";
        if (name.includes('clean')) return "ðŸ§¹";
        if (name.includes('feed')) return "ðŸŒ¾";
        if (name.includes('water')) return "ðŸ’§";
        if (name.includes('egg')) return "ðŸ¥š";
        return "ðŸ“‹";
      };

      // Emoji picker functions
      const openEmojiPicker = (target) => {
        setEmojiPickerTarget(target);
        setShowEmojiPicker(true);
      };

      const closeEmojiPicker = () => {
        setShowEmojiPicker(false);
        setEmojiPickerTarget(null);
      };

      const selectEmoji = (emoji) => {
        if (emojiPickerTarget === 'newTask') {
          setNewTask({ ...newTask, emoji });
        } else if (emojiPickerTarget === 'editTask') {
          setEditedTaskData({ ...editedTaskData, emoji });
        } else if (emojiPickerTarget === 'newBadge') {
          setNewCustomBadge({ ...newCustomBadge, emoji });
        }
        closeEmojiPicker();
      };

      // Emoji Picker Component
      const EmojiPicker = () => {
        if (!showEmojiPicker) return null;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-md w-full max-h-96 overflow-hidden">
              <div className="p-4 border-b border-gray-200">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-lg font-semibold text-gray-800">Choose Emoji</h3>
                  <button
                    onClick={closeEmojiPicker}
                    className="text-gray-500 hover:text-gray-700 text-xl"
                  >
                    Ã—
                  </button>
                </div>

                {/* Category Tabs */}
                <div className="flex space-x-1 overflow-x-auto">
                  {Object.keys(emojiCategories).map((category) => (
                    <button
                      key={category}
                      onClick={(e) => {
                        e.stopPropagation();
                        setSelectedEmojiCategory(category);
                      }}
                      className={`px-3 py-1 rounded-lg text-xs font-medium whitespace-nowrap ${
                        selectedEmojiCategory === category
                          ? "bg-blue-500 text-white"
                          : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                      }`}
                    >
                      {category.split(' ')[0]}
                    </button>
                  ))}
                </div>
              </div>

              <div className="p-4 overflow-y-auto max-h-64">
                <div className="grid grid-cols-8 gap-2">
                  {emojiCategories[selectedEmojiCategory].map((emoji, index) => (
                    <button
                      key={index}
                      onClick={() => selectEmoji(emoji)}
                      className="w-8 h-8 flex items-center justify-center text-lg hover:bg-gray-100 rounded-lg transition-colors"
                    >
                      {emoji}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Click outside handler for emoji picker
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (showEmojiPicker && !event.target.closest('.fixed')) {
            closeEmojiPicker();
          }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showEmojiPicker]);

      // *** PAYWALL COMPONENT ***
      const PaywallModal = () => {
        if (!showPaywall) return null;

        const handleSubscribe = async (plan) => {
          try {
            
            // Check if this is a new signup (email or Google)
            const pendingSignup = localStorage.getItem("pendingSignup");
            const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
            const isNewSignup = !!(pendingSignup || pendingGoogleSignup);
            
            let userInfo = {
              userId: currentUser?.uid,
              email: currentUser?.email,
              familyName: JSON.parse(localStorage.getItem("userAccount") || '{}').familyName
            };

            // If new signup, use pending signup info
            if (isNewSignup) {
              let signupData;
              if (pendingGoogleSignup) {
                signupData = JSON.parse(pendingGoogleSignup);
              } else {
                signupData = JSON.parse(pendingSignup);
              }
              
              userInfo = {
                userId: null, // No user account yet
                email: signupData.email,
                familyName: signupData.familyName
              };
            }
            
            // Initialize Stripe (replace with your publishable key)
            const stripe = Stripe('pk_test_51RnGgYH2JPCj4zv8Dp4ZDvT4MwTVXW01vLhOTB4Rj9CJP9lmvoYprJ2G9HJQ7REAEuwjHXFhI41W9vOkPyST9JM500iUj4bCc1'); // publishable key
            
            // Create checkout session
            const response = await fetch('/api/create-checkout-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                plan: plan,
                userId: userInfo.userId,
                email: userInfo.email,
                familyName: userInfo.familyName,
                isNewSignup: isNewSignup
              })
            });

            if (!response.ok) {
              throw new Error('Failed to create checkout session');
            }

            const session = await response.json();

            // Redirect to Stripe Checkout
            const result = await stripe.redirectToCheckout({
              sessionId: session.id
            });

            if (result.error) {
              console.error('Stripe error:', result.error);
              alert('Payment failed: ' + result.error.message);
            }

          } catch (error) {
            console.error('Subscription error:', error);
            alert('Failed to start subscription. Please try again.');
          }
        };

        const handleRestorePurchase = async () => {
          try {            
            if (!currentUser) {
              alert("Please log in to restore your subscription.");
              return;
            }

            // Check for existing subscription
            const response = await fetch('/api/restore-subscription', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                userId: currentUser.uid,
                email: currentUser.email
              })
            });

            if (!response.ok) {
              throw new Error('Failed to check subscription');
            }

            const result = await response.json();

            if (result.subscription) {
              // Update local subscription data
              const restoredData = {
                status: result.subscription.status === 'active' ? 'active' : 'expired',
                plan: result.subscription.plan,
                subscriptionEndDate: result.subscription.current_period_end,
                customerId: result.subscription.customer,
                subscriptionId: result.subscription.id
              };
              
              setSubscriptionData(restoredData);
              setShowPaywall(false);
              alert("âœ… Subscription restored successfully!");
            } else {
              alert("No active subscription found for this account.");
            }

          } catch (error) {
            console.error("Error restoring subscription:", error);
            alert("Failed to restore subscription. Please try again or contact support.");
          }
        };


        return (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999] p-4">
            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto relative">
              
              {/* Close Button */}
              <button
                onClick={async () => {                  
                  // Check if user has pending Google signup and is authenticated
                  const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
                  if (pendingGoogleSignup && currentUser) {
                    try {
                      // Sign out the Google user since they didn't complete payment
                      await window.firebaseAuth.signOut(window.firebaseAuth.auth);
                    } catch (error) {
                      console.error('Error signing out Google user:', error);
                    }
                  }
                  
                  // Clear any pending signup data
                  localStorage.removeItem("pendingSignup");
                  localStorage.removeItem("pendingGoogleSignup");
                  
                  // Close the paywall
                  setShowPaywall(false);
                }}
                className="absolute top-4 right-4 w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-500 hover:text-gray-700 transition-colors z-10"
                aria-label="Close"
              >
                âœ•
              </button>
              
              <div className="p-6">
                {/* Header */}
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">ðŸš€</div>
                  <h2 className="text-2xl font-bold text-gray-900 mb-2">
                    Subscribe to Farm Fam
                  </h2>
                  <p className="text-gray-600">
                    Choose your plan to start using Farm Fam with your family!
                  </p>
                </div>

                {/* Features List */}
                <div className="mb-6">
                  <h3 className="font-semibold text-gray-900 mb-3">Premium Features:</h3>
                  <div className="space-y-2">
                    {[
                      "âœ… Cloud sync across devices",
                      "âœ… Priority customer support",
                      "âœ… No daily data resets"
                    ].map((feature, index) => (
                      <div key={index} className="flex items-center text-sm text-gray-700">
                        <span>{feature}</span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Pricing Plans */}
                <div className="space-y-3 mb-6">
                  <button
                    onClick={() => handleSubscribe('monthly')}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl font-semibold text-center transition-colors"
                  >
                    <div className="flex items-center justify-between">
                      <div className="text-left">
                        <div className="text-lg">Monthly Plan</div>
                        <div className="text-sm opacity-90">Cancel anytime</div>
                      </div>
                      <div className="text-right">
                        <div className="text-xl">$4.99</div>
                        <div className="text-sm opacity-90">/month</div>
                      </div>
                    </div>
                  </button>

                  <button
                    onClick={() => handleSubscribe('yearly')}
                    className="w-full bg-green-600 hover:bg-green-700 text-white p-4 rounded-xl font-semibold text-center transition-colors relative"
                  >
                    <div className="absolute -top-2 right-4 bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full text-xs font-bold">
                      SAVE 50%
                    </div>
                    <div className="flex items-center justify-between">
                      <div className="text-left">
                        <div className="text-lg">Yearly Plan</div>
                        <div className="text-sm opacity-90">Best value!</div>
                      </div>
                      <div className="text-right">
                        <div className="text-xl">$29.99</div>
                        <div className="text-sm opacity-90">/year</div>
                      </div>
                    </div>
                  </button>
                </div>

                {/* Restore Purchase & Close */}
                <div className="space-y-3">
                  <button
                    onClick={handleRestorePurchase}
                    className="w-full text-blue-600 hover:text-blue-800 text-sm font-medium py-2"
                  >
                    Already subscribed? Restore Purchase
                  </button>
                  
                </div>

                {/* Terms */}
                <div className="text-xs text-gray-500 text-center mt-4 pt-4 border-t border-gray-200">
                  <p>Subscriptions auto-renew. Cancel anytime in settings.</p>
                  <div className="mt-2 space-x-4">
                    <a href="#" className="hover:text-gray-700">Privacy Policy</a>
                    <a href="#" className="hover:text-gray-700">Terms of Service</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };


      // *** COMPLETION RATE HELPER ***
      const completionRate = () => {
        const total = tasks.length;
        if (!total) return 0;
        let completed = 0;
        for (let i = 0; i < tasks.length; i++) {
          if (isTaskCompleted(tasks[i].id, selectedDate)) {
            completed++;
          }
        }
        return Math.round((completed / total) * 100);
      };

      const getUserCompletionRates = () => {
        return users.map(user => {
          const userTasks = tasks.filter(t => t.assignee === user.name);
          let completedTasks = 0;
          for (let i = 0; i < userTasks.length; i++) {
            if (isTaskCompleted(userTasks[i].id, selectedDate)) {
              completedTasks++;
            }
          }
          const rate = userTasks.length ? Math.round((completedTasks / userTasks.length) * 100) : 0;
          return { name: user.name, rate };
        });
      };

      useEffect(() => {
        if (view === "insights") {
          const ctx = document.getElementById("completionChart")?.getContext("2d");
          if (ctx) {
            const userRates = getUserCompletionRates();
            const colors = ["#4CAF50", "#2196F3", "#FF9800", "#E91E63"];
            new Chart(ctx, {
              type: "bar",
              data: {
                labels: userRates.map(u => u.name),
                datasets: [{
                  label: "Completion Rate (%)",
                  data: userRates.map(u => u.rate),
                  backgroundColor: colors.slice(0, userRates.length),
                  borderColor: colors.slice(0, userRates.length),
                  borderWidth: 1,
                }],
              },
              options: {
                scales: { y: { beginAtZero: true, max: 100 } },
                plugins: { 
                  title: { display: true, text: "Task Completion Rate by Person" },
                  legend: { display: false }
                },
                responsive: true,
                maintainAspectRatio: false
              },
            });
          }
        }
      }, [view, tasks, taskCompletions, selectedDate]);

      // Handle Stripe Checkout return (success/cancel)
      useEffect(() => {        
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const canceled = urlParams.get('canceled');

        if (success === 'true') {
          window.history.replaceState(null, null, window.location.pathname);

          const isNewSignup = urlParams.get('signup') === 'true';
          const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
          const pendingSignup = localStorage.getItem("pendingSignup");

          localStorage.setItem("hasCompletedOnboarding", "true");
          navigateToPage(PAGES.LOGIN);

          if (isNewSignup) {
            if (pendingGoogleSignup) {
              setShowPostPaymentButton(true);
            } else if (pendingSignup) {
              handlePostPaymentSignup(); // This will create the account and log in
            }
          } else {
            alert('ðŸŽ‰ Payment successful! Your subscription is being activated...');
          }
          localStorage.setItem("hasCompletedOnboarding", "true");
          window.history.replaceState(null, null, window.location.pathname);
          
        } else if (canceled === 'true') {
          alert('Payment was canceled. You can try again anytime!');
          window.history.replaceState(null, null, window.location.pathname);
        }
      }, []);

      // Sync subscription data from Stripe for newly created users
      const syncSubscriptionData = async (userId, email) => {
        try {
          const response = await fetch('/api/restore-subscription', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId: userId,
              email: email
            })
          });

          if (!response.ok) {
            console.warn('Could not sync subscription data, will be updated by webhook');
            return;
          }

          const result = await response.json();
          if (result.subscription) {
            const syncedData = {
              status: 'active',
              plan: result.subscription.plan,
              subscriptionEndDate: result.subscription.current_period_end,
              customerId: result.subscription.customer,
              subscriptionId: result.subscription.id
            };
            
            setSubscriptionData(syncedData);
          }

        } catch (error) {
          console.warn("Could not sync subscription data:", error);
          // Don't throw - webhook will eventually update this
        }
      };

      // Handle account creation after successful payment for new users
      const handlePostPaymentSignup = async () => {
        try {
          const pendingSignup = localStorage.getItem("pendingSignup");
          const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
          
          if (!pendingSignup && !pendingGoogleSignup) {
            alert("Signup data not found. Please try signing up again.");
            navigateToPage(PAGES.LOGIN);
            return;
          }

          let signupData, user;

          if (pendingGoogleSignup) {
            // Handle Google signup
            signupData = JSON.parse(pendingGoogleSignup);            
            // SECURITY: Verify payment with server before proceeding
            const hasValidPayment = await verifyPaymentWithServer(signupData.email);
            if (!hasValidPayment) {
              alert("âŒ Payment verification failed. Please complete payment first.");
              setShowPostPaymentButton(false);
              return;
            }
            
            // Re-authenticate with Google to get the user object
            try {
              const result = await window.firebaseAuth.signInWithPopup(
                window.firebaseAuth.auth,
                window.firebaseAuth.googleProvider
              );
              user = result.user;
              
              // Verify it's the same user
              if (user.email !== signupData.email) {
                console.error("Google account mismatch:", user.email, "vs", signupData.email);
                alert(`Google account mismatch. Please use the same Google account you signed up with: ${signupData.email}`);
                // Don't return here - allow user to try again
                setShowPostPaymentButton(true); // Keep the modal open
                return;
              }
              
              // Wait a moment for auth state to propagate
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              // Verify user is still authenticated
              const currentUser = window.firebaseAuth.auth.currentUser;
              if (!currentUser || currentUser.uid !== user.uid) {
                throw new Error("Authentication state is inconsistent. Please try again.");
              }
              
            } catch (error) {
              console.error("Google re-authentication failed:", error);
              if (error.message.includes("mismatch")) {
                // For mismatch errors, keep the modal open for retry
                return;
              } else {
                alert("Google authentication failed. Please try again.");
                setShowPostPaymentButton(true); // Keep the modal open
              return;
              }
            }
            
          } else {
            // Handle email signup  
            signupData = JSON.parse(pendingSignup);
            // SECURITY: Verify payment with server before proceeding
            const hasValidPayment = await verifyPaymentWithServer(signupData.email);
            if (!hasValidPayment) {
              alert("âŒ Payment verification failed. Please complete payment first.");
              return;
            }

            // Create Firebase account
            const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(
              window.firebaseAuth.auth,
              signupData.email,
              signupData.password
            );
            user = userCredential.user;
          }

          // Double-check user is authenticated before creating Firestore doc
          if (!user || !user.uid) {
            throw new Error("User authentication failed. Please try again.");
          }

          // Get real subscription data from Stripe before creating Firestore document
          let subscriptionData = {
            status: 'active',
            subscriptionEndDate: null,
            plan: null,
            customerId: null,
            subscriptionId: null
          };

          try {
            const response = await fetch('/api/restore-subscription', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                userId: user.uid,
                email: user.email
              })
            });

            if (response.ok) {
              const result = await response.json();
              if (result.subscription) {
                subscriptionData = {
                  status: 'active',
                  plan: result.subscription.plan,
                  subscriptionEndDate: result.subscription.current_period_end,
                  customerId: result.subscription.customer,
                  subscriptionId: result.subscription.id
                };
              } else {
                console.warn("No subscription found in Stripe response");
              }
            } else {
              console.warn("Failed to fetch subscription data from Stripe");
            }
          } catch (error) {
            console.warn("Could not fetch subscription data, using defaults:", error);
          }

          await initializeFirestoreData(user, signupData.familyName, subscriptionData);
          setSubscriptionData(subscriptionData);

          // Clean up pending signup data
          localStorage.removeItem("pendingSignup");
          localStorage.removeItem("pendingGoogleSignup");

          // Hide the modal
          setShowPostPaymentButton(false);

          // Show success and navigate to tasks
          alert('ðŸŽ‰ Welcome to Farm Fam! Your account has been created and subscription is active!');
          navigateToPage(PAGES.TASKS);

        } catch (error) {
          console.error("Post-payment signup error:", error);
          alert("There was an error creating your account. Please try again.");
          // Keep the modal open for retry
          setShowPostPaymentButton(true);
        }
      };

      // Onboarding Component
      // Onboarding Page now manages its own form state
      const OnboardingPage = ({ handleSignup, handleLogin, handleGoogleLogin, navigateToPage }) => {
        const [authMode, setAuthMode] = useState('signup');
        const [authForm, setAuthForm] = useState({
          email: '',
          password: '',
          confirmPassword: '',
          familyName: ''
        });
        const currentStepData = ONBOARDING_STEPS[onboardingStep];
        const isLastStep = onboardingStep === ONBOARDING_STEPS.length - 1;
        const isAuthStep = currentStepData && currentStepData.id === 'auth';

        // If currentStepData is undefined, show a fallback or redirect
        if (!currentStepData) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-yellow-50 flex items-center justify-center p-4">
              <div className="max-w-md w-full">
                <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100 text-center">
                  <div className="text-6xl mb-6">ðŸ”</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-4">Welcome to Farm Fam!</h1>
                  <p className="text-gray-600 mb-8">Let's get you started!</p>
                  <button
                    onClick={completeOnboarding}
                    className="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105"
                  >
                    Start Using Farm Fam! ðŸ”
                  </button>
                </div>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-yellow-50 flex items-center justify-center p-4">
            <div className="max-w-md w-full">
              {/* Progress Bar */}
              <div className="mb-8">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium text-gray-600">Step {onboardingStep + 1} of {ONBOARDING_STEPS.length}</span>
                  <span className="text-sm text-gray-500">{Math.round(((onboardingStep + 1) / ONBOARDING_STEPS.length) * 100)}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-500 ease-out"
                    style={{ width: `${((onboardingStep + 1) / ONBOARDING_STEPS.length) * 100}%` }}
                  ></div>
                </div>
              </div>

              {/* Step Content */}
              <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                {isAuthStep ? (
                  /* Authentication Step */
                  <div>
                    <div className="text-center mb-6">
                      <div className="text-6xl mb-4 animate-bounce">ðŸš€</div>
                      <h1 className="text-2xl font-bold text-gray-800 mb-2">You're All Set!</h1>
                      <p className="text-gray-600 mb-6">Create an account to save your progress, or start using Chicken Chores right away!</p>
                    </div>

                    {/* Auth Mode Toggle */}
                    <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
                      <button
                        onClick={() => setAuthMode('signup')}
                        className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                          authMode === 'signup' 
                            ? 'bg-white text-gray-800 shadow-sm' 
                            : 'text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        Sign Up
                      </button>
                      <button
                        onClick={() => setAuthMode('login')}
                        className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                          authMode === 'login' 
                            ? 'bg-white text-gray-800 shadow-sm' 
                            : 'text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        Log In
                      </button>
                    </div>

                    {/* Auth Form */}
                    <form onSubmit={(e) => authMode === 'signup' ? handleSignup(e, authForm) : handleLogin(e, authForm)} className="space-y-4">
                      {authMode === 'signup' && (
                        <div>
                          <input
                            type="text"
                            placeholder="Family Name (e.g., The Smiths)"
                            value={authForm.familyName}
                            onChange={(e) => setAuthForm({ ...authForm, familyName: e.target.value })}
                            className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                            required
                          />
                        </div>
                      )}

                      <div>
                        <input
                          type="email"
                          placeholder="Email Address"
                          value={authForm.email}
                          onChange={(e) => setAuthForm({ ...authForm, email: e.target.value })}
                          className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                          required
                        />
                      </div>

                      <div>
                        <input
                          type="password"
                          placeholder="Password"
                          value={authForm.password}
                          onChange={(e) => setAuthForm({ ...authForm, password: e.target.value })}
                          className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                          required
                        />
                      </div>

                      {authMode === 'signup' && (
                        <div>
                          <input
                            type="password"
                            placeholder="Confirm Password"
                            value={authForm.confirmPassword}
                            onChange={(e) => setAuthForm({ ...authForm, confirmPassword: e.target.value })}
                            className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                            required
                          />
                        </div>
                      )}

                      <button
                        type="submit"
                        className="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105"
                      >
                        {authMode === 'signup' ? 'Create Account' : 'Log In'}
                      </button>
                    </form>

                    {/* Google Login Button */}
                    <div className="mt-6">
                      <div className="relative">
                        <div className="absolute inset-0 flex items-center">
                          <div className="w-full border-t border-gray-300" />
                        </div>
                        <div className="relative flex justify-center text-sm">
                          <span className="px-2 bg-white text-gray-500">Or continue with</span>
                        </div>
                      </div>
                      <button
                        onClick={handleGoogleLogin}
                        className="w-full mt-4 bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:bg-gray-50 flex items-center justify-center"
                      >
                        <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24">
                          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Continue with Google
                      </button>
                    </div>

                    {/* Continue as Guest Option */}
                    <div className="text-center mt-4">
                      <button
                        onClick={completeOnboarding}
                        className="text-gray-500 hover:text-gray-700 text-sm font-medium transition-colors duration-200"
                      >
                        Continue without saving
                      </button>
                    </div>
                  </div>
                ) : (
                  /* Regular Step Content */
                  <div className="text-center">
                    <div className="text-6xl mb-6 animate-bounce">
                      {currentStepData.icon}
                    </div>
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">
                      {currentStepData.title}
                    </h1>
                    <p className="text-gray-600 mb-8 leading-relaxed">
                      {currentStepData.content}
                    </p>

                    {/* Navigation Buttons */}
                    <div className="flex gap-3">
                      {onboardingStep > 0 && (
                        <button
                          onClick={() => setOnboardingStep(prev => prev - 1)}
                          className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
                        >
                          â† Back
                        </button>
                      )}

                      <button
                        onClick={() => {
                          if (isLastStep) {
                            completeOnboarding();
                          } else {
                            setOnboardingStep(prev => prev + 1);
                          }
                        }}
                        className="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105"
                      >
                        {isLastStep ? "Continue â†’" : "Next â†’"}
                      </button>
                    </div>

                    {/* Skip Button */}
                    {!isLastStep && (
                      <button
                        onClick={completeOnboarding}
                        className="mt-4 text-sm text-gray-500 hover:text-gray-700 transition-colors duration-200"
                      >
                        Skip to app
                      </button>
                    )}
                  </div>
                )}
              </div>

              {/* Steps Indicator */}
              <div className="flex justify-center mt-6 space-x-2">
                {ONBOARDING_STEPS.map((_, index) => (
                  <button
                    key={index}
                    onClick={() => setOnboardingStep(index)}
                    className={`w-3 h-3 rounded-full transition-all duration-200 ${
                      index === onboardingStep 
                        ? "bg-green-500 scale-125" 
                        : index < onboardingStep 
                        ? "bg-blue-400" 
                        : "bg-gray-300"
                    }`}
                  />
                ))}
              </div>
            </div>
          </div>
        );
      };

      // Family Members Page Component
      const FamilyMembersPage = () => {
        const [newMemberName, setNewMemberName] = useState("");
        const [newMemberAvatar, setNewMemberAvatar] = useState("ðŸ‘¤");
        const [newMemberColor, setNewMemberColor] = useState("blue");
        const [showAddMember, setShowAddMember] = useState(false);
        const [editedProfileData, setEditedProfileData] = useState({});
        const [newMemberEmojiCategory, setNewMemberEmojiCategory] = useState("Smileys & People");

        const availableAvatars = Object.values(emojiCategories).flat();

        const colorOptions = [
          { name: "blue", bg: "bg-blue-200", text: "text-blue-800", preview: "#DBEAFE" },
          { name: "purple", bg: "bg-purple-200", text: "text-purple-800", preview: "#E9D5FF" },
          { name: "orange", bg: "bg-orange-200", text: "text-orange-800", preview: "#FED7AA" },
          { name: "pink", bg: "bg-pink-200", text: "text-pink-800", preview: "#FBCFE8" },
          { name: "green", bg: "bg-green-200", text: "text-green-800", preview: "#BBF7D0" },
          { name: "red", bg: "bg-red-200", text: "text-red-800", preview: "#FECACA" },
          { name: "yellow", bg: "bg-yellow-200", text: "text-yellow-800", preview: "#FEF08A" },
          { name: "indigo", bg: "bg-indigo-200", text: "text-indigo-800", preview: "#C7D2FE" }
        ];

        const addNewMember = (e) => {
          e.preventDefault();
          if (!newMemberName.trim()) return;

          // Check if name already exists
          if (users.some(user => user.name.toLowerCase() === newMemberName.trim().toLowerCase())) {
            alert("A family member with this name already exists!");
            return;
          }

          const newUser = {
            name: newMemberName.trim(),
            points: 0,
            badges: [],
            avatar: newMemberAvatar,
            color: newMemberColor
          };

          setUsers([...users, newUser]);
          setNewMemberName("");
          setNewMemberAvatar("ðŸ‘¤");
          setNewMemberColor("blue");
          setShowAddMember(false);
        };

        const removeMember = (memberName) => {
          if (users.length <= 1) {
            alert("You must have at least one family member!");
            return;
          }

          if (confirm(`Are you sure you want to remove ${memberName} from the family? This will also remove all their task assignments.`)) {
            const remainingUsers = users.filter(user => user.name !== memberName);
            setUsers(remainingUsers);

            if (remainingUsers.length > 0) {
              const newAssignee = remainingUsers[0].name;
              setTasks(tasks.map(task => 
                task.assignee === memberName 
                  ? { ...task, assignee: newAssignee }
                  : task
              ));
            }
          }
        };

        return (
          <div className="pb-20">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg sm:text-xl font-bold text-green-700">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Members</h2>
              <button
                onClick={() => navigateToPage(PAGES.TASKS)}
                className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
              >
                â† Back
              </button>
            </div>

            <div className="space-y-4">
              {/* Family Management */}
              <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <h3 className="text-base font-semibold text-purple-800 mb-2">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Members</h3>
                <p className="text-sm text-purple-700 mb-3">Manage your family members and their profiles.</p>

                {/* Current Family Members */}
                <div className="mb-4">
                  <h4 className="text-sm font-medium text-purple-700 mb-2">Current Members ({users.length}):</h4>
                  <div className="space-y-2">
                    {users.map((user, index) => {
                      const colorOption = colorOptions.find(c => c.name === user.color) || colorOptions[index % colorOptions.length];
                      return (
                        <div key={user.name} className={`p-3 bg-white rounded-lg border ${
                          users.length > 1 ? "border-gray-200" : "border-green-300 bg-green-50"
                        }`}>
                          {editingProfile === user.name ? (
                            // Edit Mode
                            <div>
                              <h5 className="text-sm font-medium text-purple-700 mb-3">Edit {user.name}:</h5>
                              <div className="space-y-3">
                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">Name:</label>
                                  <input
                                    type="text"
                                    value={editedProfileData.name !== undefined ? editedProfileData.name : user.name}
                                    onChange={(e) => setEditedProfileData({ ...editedProfileData, name: e.target.value })}
                                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-purple-500 focus:outline-none"
                                  />
                                </div>

                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">Avatar:</label>
                                  <div className="border border-gray-200 rounded-lg">
                                    {/* Category Tabs */}
                                    <div className="flex space-x-1 overflow-x-auto p-2 border-b border-gray-200">
                                      {Object.keys(emojiCategories).map((category) => (
                                        <button
                                          key={category}
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            setSelectedEmojiCategory(category);
                                          }}
                                          className={`px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap ${
                                            selectedEmojiCategory === category
                                              ? "bg-purple-500 text-white"
                                              : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                                          }`}
                                        >
                                          {category.split(' ')[0]}
                                        </button>
                                      ))}
                                    </div>
                                    {/* Emoji Grid */}
                                    <div className="grid grid-cols-8 gap-2 max-h-32 overflow-y-auto p-2">
                                      {emojiCategories[selectedEmojiCategory].map((avatar, avatarIndex) => (
                                        <button
                                          key={avatarIndex}
                                          type="button"
                                          onClick={() => setEditedProfileData({ ...editedProfileData, avatar })}
                                          className={`w-8 h-8 flex items-center justify-center text-lg hover:bg-gray-100 rounded-lg transition-colors ${
                                            (editedProfileData.avatar || user.avatar) === avatar
                                              ? "bg-purple-200 border-2 border-purple-500"
                                              : ""
                                          }`}
                                        >
                                          {avatar}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                </div>

                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">Color Theme:</label>
                                  <div className="grid grid-cols-4 gap-2">
                                    {colorOptions.map((color) => (
                                      <button
                                        key={color.name}
                                        type="button"
                                        onClick={() => setEditedProfileData({ ...editedProfileData, color: color.name })}
                                        className={`flex items-center p-2 rounded-lg border text-xs capitalize transition-colors ${
                                          (editedProfileData.color || user.color) === color.name
                                            ? "border-purple-500 bg-purple-100"
                                            : "border-gray-300 bg-white hover:bg-gray-50"
                                        }`}
                                      >
                                        <div 
                                          className="w-4 h-4 rounded-full mr-2" 
                                          style={{ backgroundColor: color.preview }}
                                        ></div>
                                        {color.name}
                                      </button>
                                    ))}
                                  </div>
                                </div>

                                <div className="flex space-x-2 pt-2">
                                  <button
                                    onClick={() => {
                                      // Update the user with edited data
                                      const updatedUsers = users.map(u => 
                                        u.name === user.name 
                                          ? { 
                                              ...u, 
                                              name: editedProfileData.name || u.name,
                                              avatar: editedProfileData.avatar || u.avatar,
                                              color: editedProfileData.color || u.color
                                            }
                                          : u
                                      );
                                      setUsers(updatedUsers);

                                      // Update tasks if name changed
                                      if (editedProfileData.name && editedProfileData.name !== user.name) {
                                        const updatedTasks = tasks.map(task => 
                                          task.assignee === user.name 
                                            ? { ...task, assignee: editedProfileData.name }
                                            : task
                                        );
                                        setTasks(updatedTasks);
                                      }

                                      setEditingProfile(null);
                                      setEditedProfileData({});
                                    }}
                                    className="flex-1 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm"
                                  >
                                    Save
                                  </button>
                                  <button
                                    onClick={() => {
                                      setEditingProfile(null);
                                      setEditedProfileData({});
                                    }}
                                    className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm"
                                  >
                                    Cancel
                                  </button>
                                </div>
                              </div>
                            </div>
                          ) : (
                            // View Mode
                            <div className="flex items-center justify-between">
                              <div className="flex items-center">
                                <span className="text-2xl mr-3">{user.avatar || ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"][index] || "ðŸ‘¤"}</span>
                                <div>
                                  <div className="font-medium text-gray-800">{user.name}</div>
                                  <div className="text-xs text-gray-500 mt-1">
                                    {user.color ? user.color.charAt(0).toUpperCase() + user.color.slice(1) : 'Default'} theme
                                  </div>
                                </div>
                              </div>
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => {
                                    setEditingProfile(user.name);
                                    setEditedProfileData({});
                                  }}
                                  className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs"
                                >
                                  Edit
                                </button>
                                {users.length > 1 && (
                                  <button
                                    onClick={() => removeMember(user.name)}
                                    className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs"
                                  >
                                    Remove
                                  </button>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Add New Member Button/Form */}
                {showAddMember ? (
                  <form onSubmit={addNewMember} className="bg-white p-4 rounded-lg border border-purple-300">
                    <h4 className="text-sm font-medium text-purple-700 mb-3">Add New Family Member:</h4>

                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">Name:</label>
                        <input
                          type="text"
                          value={newMemberName || ''}
                          onChange={(e) => setNewMemberName(e.target.value)}
                          placeholder="Enter family member's name"
                          className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-purple-500 focus:outline-none"
                          required
                        />
                      </div>

                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">Avatar:</label>
                        <div className="border border-gray-200 rounded-lg">
                          {/* Category Tabs */}
                          <div className="flex space-x-1 overflow-x-auto p-2 border-b border-gray-200">
                            {Object.keys(emojiCategories).map((category) => (
                              <button
                                type="button"
                                key={category}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setNewMemberEmojiCategory(category);
                                }}
                                className={`px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap ${
                                  newMemberEmojiCategory === category
                                    ? "bg-purple-500 text-white"
                                    : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                                }`}
                              >
                                {category.split(' ')[0]}
                              </button>
                            ))}
                          </div>
                          {/* Emoji Grid */}
                          <div className="grid grid-cols-8 gap-2 max-h-32 overflow-y-auto p-2">
                            {emojiCategories[newMemberEmojiCategory].map((avatar, index) => (
                              <button
                                key={index}
                                type="button"
                                onClick={() => setNewMemberAvatar(avatar)}
                                className={`w-8 h-8 flex items-center justify-center text-lg hover:bg-gray-100 rounded-lg transition-colors ${
                                  newMemberAvatar === avatar
                                    ? "bg-purple-200 border-2 border-purple-500"
                                    : ""
                                }`}
                              >
                                {avatar}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>

                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">Color Theme:</label>
                        <div className="grid grid-cols-4 gap-2">
                          {colorOptions.map((color) => (
                            <button
                              key={color.name}
                              type="button"
                              onClick={() => setNewMemberColor(color.name)}
                              className={`flex items-center p-2 rounded-lg border text-xs capitalize transition-colors ${
                                newMemberColor === color.name
                                  ? "border-purple-500 bg-purple-100"
                                  : "border-gray-300 bg-white hover:bg-gray-50"
                              }`}
                            >
                              <div 
                                className="w-4 h-4 rounded-full mr-2" 
                                style={{ backgroundColor: color.preview }}
                              ></div>
                              {color.name}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div className="flex space-x-2 pt-2">
                        <button
                          type="submit"
                          className="flex-1 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm"
                        >
                          Add Member
                        </button>
                        <button
                          type="button"
                          onClick={() => {
                            setShowAddMember(false);
                            setNewMemberName("");
                            setNewMemberAvatar("ðŸ‘¤");
                            setNewMemberColor("blue");
                          }}
                          className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </form>
                ) : (
                  <button
                    onClick={() => setShowAddMember(true)}
                    className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm"
                  >
                    + Add Family Member
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      };

      // Settings Page Component
      const SettingsPage = () => {
        return (
          <div className="pb-20">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg sm:text-xl font-bold text-green-700">âš™ï¸ Settings</h2>
              <button
                onClick={() => navigateToPage(PAGES.TASKS)}
                className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
              >
                â† Back
              </button>
            </div>

            <div className="space-y-4">
              {/* Family Members Section */}
              <button
                onClick={() => navigateToPage(PAGES.FAMILY_MEMBERS)}
                className="w-full bg-purple-50 hover:bg-purple-100 p-4 rounded-lg border border-purple-200 text-left transition-colors"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-base font-semibold text-purple-800 mb-1">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Members</h3>
                    <p className="text-sm text-purple-700">Manage family members and their profiles</p>
                    <div className="text-xs text-purple-600 mt-1">
                      {users.length} members â€¢ Edit profiles and add new members
                    </div>
                  </div>
                  <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </button>

              {/* Edit Tasks Section */}
              <button
                onClick={() => navigateToPage(PAGES.TASK_EDITOR)}
                className="w-full bg-orange-50 hover:bg-orange-100 p-4 rounded-lg border border-orange-200 text-left transition-colors"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-base font-semibold text-orange-800 mb-1">âœï¸ Add/Edit Tasks</h3>
                    <p className="text-sm text-orange-700">Create, edit, and manage all tasks</p>
                    <div className="text-xs text-orange-600 mt-1">
                      {tasks.length} tasks â€¢ {tasks.filter(t => t.active !== false).length} active
                    </div>
                  </div>
                  <svg className="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </button>

              {/* Edit Badges Section */}
              <button
                onClick={() => navigateToPage(PAGES.BADGE_EDITOR)}
                className="w-full bg-yellow-50 hover:bg-yellow-100 p-4 rounded-lg border border-yellow-200 text-left transition-colors"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-base font-semibold text-yellow-800 mb-1">ðŸŽ–ï¸ Add/Edit Badges</h3>
                    <p className="text-sm text-yellow-700">Create and manage achievement badges</p>
                    <div className="text-xs text-yellow-600 mt-1">
                      {Object.keys(badgeDefinitions).length} badges â€¢ System and custom badges
                    </div>
                  </div>
                  <svg className="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </button>

              {/* Account Section */}
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-base font-semibold text-blue-800 mb-1">ðŸ‘¤ Account</h3>
                    <p className="text-sm text-blue-700">Manage your account and authentication</p>
                  </div>
                  <div className="text-blue-600">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                  </div>
                </div>
                {currentUser ? (
                  <div className="space-y-4">
                    <div className="bg-white p-4 rounded-lg border border-blue-300">
                      <h4 className="text-sm font-semibold text-blue-800 mb-3">Account Information</h4>
                      <div className="space-y-2 text-sm">
                        {(() => {
                          const account = JSON.parse(localStorage.getItem("userAccount") || '{}');
                          return (
                            <>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Email:</span>
                                <span className="text-gray-800 font-medium">{account.email || 'Not available'}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Family Name:</span>
                                <span className="text-gray-800 font-medium">{account.familyName || 'Not set'}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Created:</span>
                                <span className="text-gray-800 font-medium">
                                  {account.createdAt ? new Date(account.createdAt).toLocaleDateString() : 'Not available'}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Status:</span>
                                <span className="text-green-800 font-medium bg-green-100 px-2 py-1 rounded-full text-xs">
                                  âœ… Active
                                </span>
                              </div>
                            </>
                          );
                        })()}
                      </div>
                    </div>

                    {/* Subscription Information */}
                    <div className="bg-white p-4 rounded-lg border border-blue-300">
                      <h4 className="text-sm font-semibold text-blue-800 mb-3">Subscription Status</h4>
                      <div className="space-y-3">
                        {/* Current Plan Status */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div>
                            <div className="font-medium text-gray-800">
                              {subscriptionData.status === 'active' ? 'Premium Plan' : 
                               subscriptionData.status === 'expired' ? 'Subscription Expired' :
                               subscriptionData.status === 'cancelled' ? 'Subscription Cancelled' : 
                               'No Active Subscription'}
                            </div>
                            <div className="text-sm text-gray-600">
                              {subscriptionData.status === 'active' ? `${subscriptionData.plan} subscription` :
                               subscriptionData.status === 'expired' ? 'Your subscription has expired. Renew to continue.' :
                               subscriptionData.status === 'cancelled' ? 'You cancelled your subscription' :
                               'Subscribe to access all features'}
                            </div>
                          </div>
                          <div className={`px-3 py-1 rounded-full text-xs font-bold ${
                            subscriptionData.status === 'active' ? 'bg-green-100 text-green-800' :
                            subscriptionData.status === 'expired' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>
                            {subscriptionData.status === 'active' ? 'âœ… ACTIVE' :
                             subscriptionData.status === 'expired' ? 'âš ï¸ EXPIRED' :
                             subscriptionData.status === 'cancelled' ? 'âŒ CANCELLED' :
                             'âŒ INACTIVE'}
                          </div>
                        </div>

                        {/* Subscription Details */}
                        {(subscriptionData.status === 'active' || subscriptionData.status === 'expired') && (
                          <div className="text-sm space-y-2">
                            <div className="flex justify-between">
                              <span className="text-gray-600">Plan:</span>
                              <span className="text-gray-800 font-medium capitalize">{subscriptionData.plan || 'N/A'}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">
                                {subscriptionData.status === 'expired' ? 'Expired on:' : 'Next billing:'}
                              </span>
                              <span className={`font-medium ${
                                subscriptionData.status === 'expired' ? 'text-red-600' : 'text-gray-800'
                              }`}>
                                {subscriptionData.subscriptionEndDate ? 
                                  new Date(subscriptionData.subscriptionEndDate).toLocaleDateString() : 
                                  'N/A'
                                }
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Price:</span>
                              <span className="text-gray-800 font-medium">
                                {subscriptionData.plan === 'yearly' ? '$29.99/year' : '$4.99/month'}
                              </span>
                            </div>
                          </div>
                        )}

                        {/* Action Buttons */}
                        <div className="space-y-2 pt-2">
                          {subscriptionData.status === 'active' ? (
                            <div className="space-y-2">
                              <button
                                onClick={async () => {
                                  if (confirm('Are you sure you want to cancel your subscription? You will lose access to premium features.')) {
                                    try {
                                      // Call backend to cancel subscription
                                      const response = await fetch('/api/cancel-subscription', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                          userId: currentUser?.uid,
                                          subscriptionId: subscriptionData.subscriptionId
                                        })
                                      });
                                      if (!response.ok) {
                                        throw new Error('Failed to cancel subscription');
                                      }
                                      // Update local state only after backend success
                                      const cancelledData = {
                                        ...subscriptionData,
                                        status: 'cancelled'
                                      };
                                      setSubscriptionData(cancelledData);
                                      alert('Subscription cancelled successfully.');
                                      try {
                                        await window.firebaseAuth.signOut(window.firebaseAuth.auth);
                                        // onAuthStateChanged will fire and reset the state to guest mode
                                        localStorage.removeItem("userAccount");
                                        navigateToPage(PAGES.LOGIN);
                                      } catch (error) {
                                        console.error("Error signing out:", error);
                                      }
                                    } catch (error) {
                                      alert('Failed to cancel subscription. Please try again.');
                                      console.error(error);
                                    }
                                  }
                                }}
                                className="w-full bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg text-sm transition-colors"
                              >
                                Cancel Subscription
                              </button>
                            </div>
                          ) : subscriptionData.status === 'expired' ? (
                            <div className="space-y-2">
                              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                                <p className="text-xs text-yellow-800 font-medium">
                                  âš ï¸ Your subscription expired on {subscriptionData.subscriptionEndDate ? 
                                    new Date(subscriptionData.subscriptionEndDate).toLocaleDateString() : 'N/A'}. 
                                  Renew now to restore access to your data and premium features.
                                </p>
                              </div>
                              <button
                                onClick={() => setShowPaywall(true)}
                                className="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-medium transition-colors"
                              >
                                ðŸ”„ Renew Subscription
                              </button>
                            </div>
                          ) : (
                            <button
                              onClick={() => setShowPaywall(true)}
                              className="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-medium transition-colors"
                            >
                              ðŸ“ Subscribe to Farm Fam
                            </button>
                          )}
                        </div>
                      </div>
                    </div>

                    <button
                      onClick={handleLogout}
                      className="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg font-medium transition-colors"
                    >
                      ðŸšª Log Out
                    </button>
                  </div>
                ) : (
                  <div className="space-y-4">
                    <div className="bg-white p-4 rounded-lg border border-orange-300">
                      <h4 className="text-sm font-semibold text-orange-800 mb-3">Guest Mode</h4>
                      <div className="flex items-center justify-between mb-3">
                        <span className="text-gray-600 text-sm">Current Status:</span>
                        <span className="text-orange-800 font-medium bg-orange-100 px-2 py-1 rounded-full text-xs">
                          ðŸ‘¤ Guest User
                        </span>
                      </div>
                      <p className="text-xs text-gray-600 mb-3">
                        You're using Farm Fam as a guest. Your data is saved locally but won't sync across devices and resets daily at midnight.
                      </p>
                      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                        <h5 className="text-xs font-semibold text-yellow-800 mb-1">Why create an account?</h5>
                        <ul className="text-xs text-yellow-700 space-y-1">
                          <li>â€¢ Save progress across devices</li>
                          <li>â€¢ Backup your family's tasks</li>
                          <li>â€¢ Access from anywhere</li>
                          <li>â€¢ Keep data permanently (no daily reset)</li>
                        </ul>
                      </div>


                    </div>

                    <div className="space-y-2">
                      <button
                        onClick={() => navigateToPage(PAGES.LOGIN)}
                        className="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg font-medium transition-colors"
                      >
                        ðŸ“ Login / Create Account
                      </button>
                      <button
                        onClick={() => navigateToPage(PAGES.ONBOARDING)}
                        className="w-full bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-medium transition-colors"
                      >
                        ðŸŽ“ View Tutorial
                      </button>
                    </div>
                  </div>
                )}
              </div>

              {/* Weekly Reset Section */}
              <div className="bg-orange-50 p-3 rounded-lg border border-orange-200">
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <h3 className="text-sm font-semibold text-orange-800">ðŸ”„ Weekly Reset</h3>
                    <p className="text-xs text-orange-700">Reset points and badges for all family members</p>
                  </div>
                </div>

                <div className="bg-white p-3 rounded-lg border border-orange-300 mb-3">
                  <div className="grid grid-cols-2 gap-2 text-xs">
                    <div className="text-center">
                      <div className="text-sm font-bold text-blue-600">
                        {users.reduce((total, user) => total + user.points, 0)}
                      </div>
                      <div className="text-xs text-gray-600">Total Points</div>
                    </div>
                    <div className="text-center">
                      <div className="text-sm font-bold text-yellow-600">
                        {users.reduce((total, user) => total + user.badges.length, 0)}
                      </div>
                      <div className="text-xs text-gray-600">Total Badges</div>
                    </div>
                  </div>
                </div>

                <button
                  onClick={() => {
                    if (confirm("Are you sure you want to reset the weekly leaderboard? This will set all family members' points to 0 and remove all their badges. This action cannot be undone!")) {
                      // Reset all users' points and badges
                      const resetUsers = users.map(user => ({ 
                        ...user, 
                        points: 0, 
                        badges: [] 
                      }));
                      setUsers(resetUsers);
                      // Also clear all task completions
                      setTaskCompletions({});
                      // Update the last weekly reset date
                      const now = new Date();
                      const currentWeekStart = getWeekStart(new Date(now));
                      setLastWeeklyReset(currentWeekStart);
                      alert("âœ… Weekly leaderboard has been reset! All points and badges have been cleared.");
                    }
                  }}
                  className="w-full bg-orange-400 hover:bg-orange-500 text-white p-2 rounded-lg text-sm font-medium transition-colors"
                >
                  ðŸ”„ Reset Weekly Leaderboard
                </button>
              </div>

              
            </div>
          </div>
        );
      };

      // Login Page Component
      const LoginPage = ({ handleSignup, handleLogin, handleGoogleLogin, navigateToPage }) => {
        const [authMode, setAuthMode] = useState('login');
        const [authForm, setAuthForm] = useState({
          email: '',
          password: '',
          confirmPassword: '',
          familyName: ''
        });
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-yellow-50 flex items-center justify-center p-4">
            <div className="max-w-md w-full">
              <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">ðŸ”</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">Welcome to Farm Fam</h1>
                  <p className="text-gray-600 mb-6">Sign in to your account or create a new one to save your progress</p>
                </div>

                {/* Auth Mode Toggle */}
                <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
                  <button
                    onClick={() => setAuthMode('login')}
                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                      authMode === 'login' 
                        ? 'bg-white text-gray-800 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-800'
                    }`}
                  >
                    Log In
                  </button>
                  <button
                    onClick={() => setAuthMode('signup')}
                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                      authMode === 'signup' 
                        ? 'bg-white text-gray-800 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-800'
                    }`}
                  >
                    Sign Up
                  </button>
                </div>

                {/* Auth Form */}
                <form onSubmit={(e) => authMode === 'signup' ? handleSignup(e, authForm) : handleLogin(e, authForm)} className="space-y-4">
                  {authMode === 'signup' && (
                    <div>
                      <input
                        type="text"
                        placeholder="Family Name (e.g., The Smiths)"
                        value={authForm.familyName || ''}
                        onChange={(e) => setAuthForm({ ...authForm, familyName: e.target.value })}
                        className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                        required
                      />
                    </div>
                  )}

                  <div>
                    <input
                      type="email"
                      placeholder="Email Address"
                      value={authForm.email || ''}
                      onChange={(e) => setAuthForm({ ...authForm, email: e.target.value })}
                      className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                      required
                    />
                  </div>

                  <div>
                    <input
                      type="password"
                      placeholder="Password"
                      value={authForm.password || ''}
                      onChange={(e) => setAuthForm({ ...authForm, password: e.target.value })}
                      className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                      required
                    />
                  </div>

                  {authMode === 'signup' && (
                    <div>
                      <input
                        type="password"
                        placeholder="Confirm Password"
                        value={authForm.confirmPassword || ''}
                        onChange={(e) => setAuthForm({ ...authForm, confirmPassword: e.target.value })}
                        className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                        required
                      />
                    </div>
                  )}

                  <button
                    type="submit"
                    className="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105"
                  >
                    {authMode === 'signup' ? 'Create Account' : 'Log In'}
                  </button>
                </form>

                {/* Google Login Button */}
                <div className="mt-6">
                  <div className="relative">
                    <div className="absolute inset-0 flex items-center">
                      <div className="w-full border-t border-gray-300" />
                    </div>
                    <div className="relative flex justify-center text-sm">
                      <span className="px-2 bg-white text-gray-500">Or continue with</span>
                    </div>
                  </div>
                  <button
                    onClick={handleGoogleLogin}
                    className="w-full mt-4 bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:bg-gray-50 flex items-center justify-center"
                  >
                    <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24">
                      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                  </button>
                </div>

                {/* Continue as Guest Option */}
                <div className="text-center mt-6">
                  <button
                    onClick={() => navigateToPage(PAGES.TASKS)}
                    className="text-gray-500 hover:text-gray-700 text-sm font-medium transition-colors"
                  >
                    Continue as Guest
                  </button>
                </div>

                {/* Back to Tasks Button for Existing Users */}
                <div className="text-center mt-4">
                  <button
                    onClick={() => navigateToPage(PAGES.TASKS)}
                    className="text-blue-500 hover:text-blue-700 text-sm font-medium transition-colors"
                  >
                    â† Back to Tasks
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Show onboarding if not completed
      if (currentPage === PAGES.ONBOARDING) {
        return (
          <div>
            <OnboardingPage 
          handleSignup={handleSignup} 
          handleLogin={handleLogin} 
          handleGoogleLogin={handleGoogleLogin} 
          navigateToPage={navigateToPage} 
            />
            {/* PaywallModal needs to be available during onboarding */}
            <PaywallModal />
          </div>
        );
      }

      // Show login page
      if (currentPage === PAGES.LOGIN) {
        return (
          <div>
            <LoginPage 
          handleSignup={handleSignup} 
          handleLogin={handleLogin} 
          handleGoogleLogin={handleGoogleLogin} 
          navigateToPage={navigateToPage} 
            />
            {/* PaywallModal needs to be available during login/signup */}
            <PaywallModal />
          </div>
        );
      }

      return (
        <div className={`transition-opacity duration-150 ${showPageTransition ? 'opacity-50' : 'opacity-100'}`}>

          {/* Emoji Picker Modal */}
          <EmojiPicker />

          {/* Paywall Modal */}
          <PaywallModal />

          {/* Mobile Footer Navigation */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
            <div className="flex justify-around items-center py-2">
              <button
                onClick={() => navigateToPage(PAGES.TASKS)}
                className={`flex flex-col items-center p-2 rounded-lg ${
                  currentPage === PAGES.TASKS ? "text-green-600" : "text-gray-500"
                }`}
              >
                <div className="text-xl mb-1">âœ…</div>
                <div className="text-xs font-medium">Tasks</div>
              </button>
              <button
                onClick={() => navigateToPage(PAGES.LEADERBOARD)}
                className={`flex flex-col items-center p-2 rounded-lg ${
                  currentPage === PAGES.LEADERBOARD ? "text-green-600" : "text-gray-500"
                }`}
              >
                <div className="text-xl mb-1">ðŸ†</div>
                <div className="text-xs font-medium">Rewards</div>
              </button>
              <button
                onClick={() => navigateToPage(PAGES.SETTINGS)}
                className={`flex flex-col items-center p-2 rounded-lg ${
                  currentPage === PAGES.SETTINGS ? "text-green-600" : "text-gray-500"
                }`}
              >
                <div className="text-xl mb-1">âš™ï¸</div>
                <div className="text-xs font-medium">Settings</div>
              </button>
            </div>
          </div>

          {/* Expired Subscription Banner */}
          {currentUser && subscriptionData.status === 'expired' && currentPage === PAGES.TASKS && (
            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4" data-expired-banner>
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  <span className="text-yellow-400 text-xl">âš ï¸</span>
                </div>
                <div className="ml-3 flex-1">
                  <p className="text-sm font-medium text-yellow-800">
                    Your subscription has expired
                  </p>
                  <p className="text-xs text-yellow-700 mt-1">
                    You can continue using Farm Fam, but your data is only saved locally and won't sync across devices. 
                    <button 
                      onClick={() => setShowPaywall(true)}
                      className="underline hover:no-underline font-medium ml-1"
                    >
                      Renew subscription
                    </button> to restore cloud sync.
                  </p>
                </div>
                <div className="flex-shrink-0">
                  <button 
                    onClick={() => {
                      // Hide banner for this session
                      const banner = document.querySelector('[data-expired-banner]');
                      if (banner) banner.style.display = 'none';
                    }}
                    className="text-yellow-700 hover:text-yellow-900 text-sm"
                  >
                    âœ•
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Tasks View - New Mobile-Inspired Layout */}
          {currentPage === PAGES.TASKS && (
            <div className="relative pb-24">
              {/* Profile Selector - Top Left */}
              <div className="mb-4">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center">
                    <div className="flex items-center rounded-lg px-2 py-1 border border-gray-300 shadow-sm" style={{ backgroundColor: '#F0F8F0' }}>
                      <div className="text-lg mr-1">
                        {(() => {
                          if (!selectedProfile || selectedProfile === "Family") {
                            return "";
                          }
                          const user = users.find(u => u.name === selectedProfile);
                          if (user && user.avatar) {
                            return user.avatar;
                          }
                          // Fallback to default avatars if no custom avatar is set
                          const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                          const userIndex = users.findIndex(u => u.name === selectedProfile);
                          return avatarEmojis[userIndex] || "ðŸ‘¤";
                        })()}
                      </div>
                      <div className="relative">
                        <select
                          value={selectedProfile || "Family"}
                          onChange={(e) => {
                            if (e.target.value === "Add Profile") {
                              navigateToPage(PAGES.FAMILY_MEMBERS);
                            } else {
                              setSelectedProfile(e.target.value === "Family" ? null : e.target.value);
                            }
                          }}
                          className="bg-transparent text-sm font-medium text-gray-800 border-none outline-none cursor-pointer pr-4 appearance-none"
                        >
                          <option value="Family">ðŸšœ Family</option>
                          {users.map((user, index) => {
                            return (
                              <option key={user.name} value={user.name}>
                                {user.name}
                              </option>
                            );
                          })}
                          <option value="Add Profile">âœï¸ Edit Profiles</option>
                        </select>
                        <div className="absolute right-0 top-1/2 transform -translate-y-1/2 pointer-events-none">
                          <svg className="w-3 h-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center bg-gradient-to-r from-yellow-100 to-orange-100 rounded-full px-3 py-1 shadow-sm border border-yellow-200">
                    <span className="text-lg mr-1 filter drop-shadow-sm">â­</span>
                    <span className="font-bold text-sm text-orange-800">
                      {(() => {
                        if (!selectedProfile || selectedProfile === "Family") {
                          return users.reduce((total, user) => total + user.points, 0);
                        }
                        return users.find(u => u.name === selectedProfile)?.points || 0;
                      })()}
                    </span>
                  </div>
                </div>
              </div>

              {/* Calendar Section */}
              <div className="mb-4">
                <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                  <div className="flex items-center justify-between mb-4">
                    <button
                      onClick={() => {
                        const newDate = new Date(selectedDate);
                        newDate.setDate(selectedDate.getDate() - 7);
                        setSelectedDate(newDate);
                      }}
                      className="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-600 transition-colors"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                      </svg>
                    </button>

                    <div className="text-center">
                      <h3 className="text-lg font-bold text-gray-800">
                        {selectedDate.toDateString() === new Date().toDateString() ? 
                          `Today, ${selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}` : 
                          selectedDate.toLocaleDateString('en-US', { 
                            weekday: 'short',
                            month: 'short', 
                            day: 'numeric' 
                          })
                        }
                      </h3>
                    </div>

                    <button
                      onClick={() => {
                        const newDate = new Date(selectedDate);
                        newDate.setDate(selectedDate.getDate() + 7);
                        setSelectedDate(newDate);
                      }}
                      className="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-600 transition-colors"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                      </svg>
                    </button>
                  </div>

                  <div className="flex justify-between items-center text-center">
                    {(() => {
                      const weekDays = [];
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());

                      const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const isToday = day.toDateString() === new Date().toDateString();
                        const isSelected = day.toDateString() === selectedDate.toDateString();
                        const dayNumber = day.getDate();

                        weekDays.push(
                          <button
                            key={i}
                            onClick={() => setSelectedDate(new Date(day))}
                            className={`flex flex-col items-center p-2 rounded-xl min-w-[40px] ${
                              isSelected 
                                ? "text-white" 
                                : isToday 
                                ? "text-green-600 hover:bg-gray-100" 
                                : "text-gray-500 hover:bg-gray-100"
                            }`}
                            style={isSelected ? { backgroundColor: '#4A90E2' } : {}}
                          >
                            <div className="text-xs font-medium mb-1">{dayNames[i]}</div>
                            <div className="text-lg font-bold">{dayNumber}</div>
                          </button>
                        );
                      }
                      return weekDays;
                    })()}
                  </div>
                </div>
              </div>

              {/* Tasks Section */}
              <div className="mb-4">
                {(() => {
                  const allTodayTasks = getTasksForDay(getCurrentDayName());
                  const filteredTasks = !selectedProfile || selectedProfile === "Family" 
                    ? allTodayTasks 
                    : allTodayTasks.filter(t => t.assignee === selectedProfile);

                  if (filteredTasks.length === 0) {
                    return (
                      <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center text-gray-500">
                        <div className="text-3xl mb-2">ðŸŽ‰</div>
                        <p>No tasks for today!</p>
                      </div>
                    );
                  }

                  // Group tasks by time of day
                  const tasksByTime = {
                    "Morning": filteredTasks.filter(t => t.timeOfDay === "Morning"),
                    "Afternoon": filteredTasks.filter(t => t.timeOfDay === "Afternoon"),
                    "Evening": filteredTasks.filter(t => t.timeOfDay === "Evening"),
                    "Anytime": filteredTasks.filter(t => !t.timeOfDay || t.timeOfDay === "Anytime")
                  };
                  const timeIcons = { "Morning": "", "Afternoon": "", "Evening": "", "Anytime": "" };
                  return (
                    <div className="space-y-6">
                      {Object.entries(tasksByTime).map(([timeOfDay, tasks]) => {
                        if (tasks.length === 0) return null;

                        return (
                          <div key={timeOfDay}>
                            {/* Time Section Header */}
                            <div className="flex items-center mb-3">
                              <span className="text-2xl mr-2">{timeIcons[timeOfDay]}</span>
                              <h3 className="text-sm font-medium text-gray-500">{timeOfDay}</h3>
                              <div className="flex-1 h-px bg-gray-200 ml-3"></div>
                              <span className="text-xs text-gray-400 ml-3">
                                {tasks.filter(t => isTaskCompleted(t.id, selectedDate)).length}/{tasks.length}
                              </span>
                            </div>

                            {/* Tasks in this time period */}
                            <div className="space-y-3">
                              {tasks.sort((a, b) => a.assignee.localeCompare(b.assignee)).map(task => {
                                const isCompleted = isTaskCompleted(task.id, selectedDate);
                                const isPastDay = selectedDate < new Date() && !isTaskCompleted(task.id, selectedDate) && selectedDate.toDateString() !== new Date().toDateString();
                                
                                return (
                                  <div key={task.id} className={`rounded-2xl shadow-sm border p-4 ${
                                    isCompleted 
                                      ? "bg-green-100 border-green-300" 
                                      : isPastDay
                                      ? "bg-red-50 border-red-300"
                                      : "bg-white border-gray-100"
                                  }`}>
                                    <div className="flex items-center">
                                      <button
                                        onClick={() => toggleTask(task)}
                                        disabled={isNotToday(selectedDate)}
                                        className={`w-8 h-8 rounded-full mr-4 flex items-center justify-center ${
                                          isCompleted
                                            ? "bg-green-500 text-white"
                                            : isPastDay
                                            ? "bg-red-400 text-white"
                                            : "bg-gray-200 text-gray-400"
                                        } ${isNotToday(selectedDate) ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                                      >
                                        {isCompleted ? "âœ“" : isPastDay ? "âœ—" : ""}
                                      </button>

                                      <div className="flex items-center flex-1">
                                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                          <span className="text-lg">{getTaskEmoji(task.name, task.emoji)}</span>
                                        </div>
                                        <div className="flex-1">
                                          <div className={`font-medium ${
                                            isCompleted ? "text-green-800 line-through" : 
                                            isPastDay ? "text-red-800 line-through" : 
                                            "text-gray-800"
                                          }`}>
                                            {task.name}
                                          </div>
                                          <div className="text-xs mt-1 flex items-center gap-2">
                                            {(!selectedProfile || selectedProfile === "Family") && (
                                              <span className={`px-2 py-1 rounded-full text-xs font-medium ${getPersonColor(task.assignee)}`}>
                                                {task.assignee}
                                              </span>
                                            )}
                                          </div>
                                        </div>
                                        <div className="flex items-center bg-gradient-to-r from-yellow-100 to-orange-100 rounded-full px-3 py-1 shadow-sm border border-yellow-200">
                                          <span className="text-lg mr-1 filter drop-shadow-sm">â­</span>
                                          <span className="font-bold text-orange-800 text-sm">{task.points}</span>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>

              {/* Profile Header for Individual Members - Bottom Section */}
              {selectedProfile && selectedProfile !== "Family" && (
                <div className="mt-6">
                  {(() => {
                    const user = users.find(u => u.name === selectedProfile);
                    if (!user) return null;

                    const userIndex = users.findIndex(u => u.name === selectedProfile);
                    const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                    const userTasks = tasks.filter(t => t.assignee === selectedProfile);
                    const todayTasks = userTasks.filter(t => getTasksForDay(getCurrentDayName()).includes(t));
                    const completedTasks = todayTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                    const completionRate = todayTasks.length ? Math.round((completedTasks.length / todayTasks.length) * 100) : 0;
                    
                    // Calculate points earned only on the selected day
                    const pointsEarnedToday = completedTasks.reduce((sum, task) => sum + task.points, 0);

                    const userColor = user?.color;
                    let colorClass = "bg-gray-50 border-gray-200";
                    if(userColor) {
                        const colorMap = {
                            blue: "bg-blue-50 border-blue-200",
                            purple: "bg-purple-50 border-purple-200",
                            orange: "bg-orange-50 border-orange-200",
                            pink: "bg-pink-50 border-pink-200",
                            green: "bg-green-50 border-green-200",
                            red: "bg-red-50 border-red-200",
                            yellow: "bg-yellow-50 border-yellow-200",
                            indigo: "bg-indigo-50 border-indigo-200",
                        };
                        colorClass = colorMap[userColor] || colorClass;
                    }

                    return (
                      <div className={`${colorClass} border-2 p-4 rounded-2xl shadow-lg mb-4`}>
                        <div className="grid grid-cols-3 gap-3 mb-4">
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-2xl font-bold text-green-600">{completionRate}%</div>
                            <div className="text-xs text-gray-600">Today's Progress</div>
                          </div>
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-2xl font-bold text-blue-600">{todayTasks.length}</div>
                            <div className="text-xs text-gray-600">Today's Tasks</div>
                          </div>
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-2xl font-bold text-yellow-600">{pointsEarnedToday}</div>
                            <div className="text-xs text-gray-600">Points Today</div>
                          </div>
                        </div>

                        {/* Progress Bar */}
                        <div className="mb-4">
                          <div className="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Today's Progress</span>
                            <span>{completedTasks.length}/{todayTasks.length}</span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-3">
                            <div 
                              className="bg-green-500 h-3 rounded-full transition-all duration-500" 
                              style={{ width: `${completionRate}%` }}
                            ></div>
                          </div>
                        </div>

                        {/* Recent Badges */}
                        {user.badges.length > 0 && (
                          <div>
                            <div className="text-sm font-semibold text-gray-700 mb-2">ðŸ† Recent Badges:</div>
                            <div className="flex flex-wrap gap-2">
                              {user.badges.slice(0, 4).map((badge, badgeIndex) => (
                                <span key={badgeIndex} className="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full border border-yellow-300">
                                  <span className="mr-1">{badgeDefinitions[badge]?.emoji || "ðŸ…"}</span>
                                  <span>{badge}</span>
                                </span>
                              ))}
                              {user.badges.length > 4 && (
                                <span className="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full">
                                  +{user.badges.length - 4} more
                                </span>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </div>
              )}

              {/* Family Summary Section */}
              {(!selectedProfile || selectedProfile === "Family") && (
                <div className="mt-6 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-2xl border-2 border-green-200 shadow-lg mb-4">
                  <h3 className="text-lg font-bold text-green-800 mb-3 text-center">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Summary</h3>
                  <div className="grid grid-cols-3 gap-3 mb-4">
                    {(() => {
                      const todayTasks = getTasksForDay(getCurrentDayName());
                      const completedTasks = todayTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                      const completionRate = todayTasks.length ? Math.round((completedTasks.length / todayTasks.length) * 100) : 0;
                      const tasksRemaining = todayTasks.length - completedTasks.length;
                      
                      return (
                        <>
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-xl font-bold text-green-600">{completionRate}%</div>
                            <div className="text-xs text-gray-600">Progress</div>
                          </div>
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-xl font-bold text-blue-600">{todayTasks.length}</div>
                            <div className="text-xs text-gray-600">Today's Tasks</div>
                          </div>
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-xl font-bold text-purple-600">{tasksRemaining}</div>
                            <div className="text-xs text-gray-600">Tasks Remaining</div>
                          </div>
                        </>
                      );
                    })()}
                  </div>

                  {/* Progress Bar */}
                  {(() => {
                    const todayTasks = getTasksForDay(getCurrentDayName());
                    const completedTasks = todayTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                    const completionRate = todayTasks.length ? Math.round((completedTasks.length / todayTasks.length) * 100) : 0;
                    
                    return (
                      <div className="mb-4">
                        <div className="flex justify-between text-sm text-gray-600 mb-2">
                          <span>Family Progress Today</span>
                          <span>{completedTasks.length}/{todayTasks.length}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                          <div 
                            className="bg-green-500 h-3 rounded-full transition-all duration-500" 
                            style={{ width: `${completionRate}%` }}
                          ></div>
                        </div>
                      </div>
                    );
                  })()}

                  {/* Top Performers Today */}
                  {(() => {
                    const todayUserStats = users.map(user => {
                      const userTasks = getTasksForDay(getCurrentDayName()).filter(t => t.assignee === user.name);
                      const completedTasks = userTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                      const pointsEarned = completedTasks.reduce((sum, task) => sum + task.points, 0);
                      const completionRate = userTasks.length ? Math.round((completedTasks.length / userTasks.length) * 100) : 0;
                      return { ...user, pointsEarned, completionRate, tasksCompleted: completedTasks.length, totalTasks: userTasks.length };
                    }).sort((a, b) => b.pointsEarned - a.pointsEarned || b.completionRate - a.completionRate);

                    return (
                      <div>
                        <div className="text-sm font-semibold text-gray-700 mb-2">ðŸ† Today's Leaders:</div>
                        <div className="space-y-2">
                          {todayUserStats.map((user, index) => {
                            const medals = ["ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰"];
                            const medal = medals[index] || "ðŸ…";
                            return (
                              <div key={user.name} className="flex items-center justify-between bg-white rounded-lg p-2 shadow-sm">
                                <div className="flex items-center">
                                  <span className="text-lg mr-2">{medal}</span>
                                  <span className="text-sm font-medium">{user.name}</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                  <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">
                                    â­ {user.pointsEarned}
                                  </span>
                                  <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                                    {user.tasksCompleted}/{user.totalTasks}
                                  </span>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}

              {/* Edit Tasks Button */}
              <div className="mt-6 mb-4">
                <button
                  onClick={() => navigateToPage(PAGES.TASK_EDITOR)}
                  className="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg"
                >
                  âœï¸ Edit Tasks
                </button>
              </div>

            </div>
          )}

          {/* Calendar View */}
          {view === "calendar" && (
            <div className="pb-20">
              <div className="text-center mb-4">
                <h2 className="text-lg sm:text-xl font-bold mb-2 text-green-700">ðŸ“… Family Calendar</h2>
                <p className="text-xs sm:text-sm text-gray-600">Navigate through days</p>
              </div>
              <div className="bg-blue-50 p-3 rounded-lg mb-4">
                <div className="flex items-center justify-between mb-3">
                  <button 
                    onClick={() => {
                      const newDate = new Date(selectedDate);
                      newDate.setDate(selectedDate.getDate() - selectedDate.getDay() -1);
                      setSelectedDate(newDate);
                    }}
                    className="bg-green-500 text-white px-3 py-1 rounded-lg text-xs sm:text-sm min-h-[40px]"
                  >
                    â† Prev
                  </button>
                  <div className="text-center">
                    <h3 className="text-sm font-bold text-green-800">
                      {selectedDate.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' })}
                    </h3>
                    <p className="text-xs text-green-600">
                      {selectedDate.toDateString() === new Date().toDateString() ? 
                        "Today" : 
                        selectedDate < new Date() ? "Past" : "Future"}
                    </p>
                  </div>
                  <button 
                    onClick={() => {
                      const newDate = new Date(selectedDate);
                      newDate.setDate(selectedDate.getDate() + 1);
                      setSelectedDate(newDate);
                    }}
                    className="bg-green-500 text-white px-3 py-1 rounded-lg text-xs sm:text-sm min-h-[40px]"
                  >
                    Next â†’
                  </button>
                </div>
                <div className="flex justify-center gap-1 flex-wrap">
                  <button 
                    onClick={() => setSelectedDate(new Date())}
                    className="bg-blue-500 text-white px-2 py-1 rounded text-xs min-h-[40px]"
                  >
                    Today
                  </button>
                  <button 
                    onClick={() => {
                      const yesterday = new Date();
                      yesterday.setDate(yesterday.getDate() - 1);
                      setSelectedDate(yesterday);
                    }}
                    className="bg-gray-500 text-white px-2 py-1 rounded text-xs min-h-[40px]"
                  >
                    Yesterday
                  </button>
                  <button 
                    onClick={() => {
                      const tomorrow = new Date();
                      tomorrow.setDate(tomorrow.getDate() + 1);
                      setSelectedDate(tomorrow);
                    }}
                    className="bg-orange-500 text-white px-2 py-1 rounded text-xs min-h-[40px]"
                  >
                    Tomorrow
                  </button>
                </div>
              </div>
              <div className="bg-white p-3 rounded-lg mb-4 border-2 border-green-200 overflow-x-auto">
                <h3 className="text-sm font-bold text-green-800 mb-2 text-center">Week Overview</h3>
                <div className="grid grid-cols-7 gap-1 min-w-[200px]">
                  {(() => {
                    const weekDays = [];
                    const startOfWeek = new Date(selectedDate);
                    startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                    for (let i = 0; i < 7; i++) {
                      const day = new Date(startOfWeek);
                      day.setDate(startOfWeek.getDate() + i);
                      const isToday = day.toDateString() === new Date().toDateString();
                      const isSelected = day.toDateString() === selectedDate.toDateString();
                      const dayName = day.toLocaleDateString('en-US', { weekday: 'short' });
                      const dayNumber = day.getDate();
                      weekDays.push(
                        <button
                          key={i}
                          onClick={() => setSelectedDate(new Date(day))}
                          className={`p-1 rounded-lg text-center text-xs ${
                            isSelected 
                              ? "bg-green-500 text-white" 
                              : isToday 
                                ? "bg-blue-100 border-2 border-blue-300" 
                                : "bg-gray-50 hover:bg-gray-100"
                          }`}
                        >
                          <div>{dayName}</div>
                          <div className="font-bold">{dayNumber}</div>
                        </button>
                      );
                    }
                    return weekDays;
                  })()}
                </div>
              </div>

              <div className="mt-6 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl border-2 border-green-200">
                <h3 className="text-base sm:text-lg font-bold text-green-800 mb-3 text-center">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Summary</h3>
                <div className="grid grid-cols-2 gap-2 text-center text-xs sm:text-sm">
                  <div className="bg-white p-2 rounded-lg">
                    <div className="text-lg sm:text-xl font-bold text-blue-600">{(() => {
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                      let totalWeeklyTasks = 0;
                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                        totalWeeklyTasks += getTasksForDay(dayName).length;
                      }
                      return totalWeeklyTasks;
                    })()}</div>
                    <div className="text-xs text-gray-600">Total Tasks</div>
                  </div>
                  <div className="bg-white p-2 rounded-lg">
                    <div className="text-lg sm:text-xl font-bold text-green-600">{(() => {
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                      let completedWeeklyTasks = 0;
                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                        const dayTasks = getTasksForDay(dayName);
                        completedWeeklyTasks += dayTasks.filter(t => isTaskCompleted(t.id, day)).length;
                      }
                      return completedWeeklyTasks;
                    })()}</div>
                    <div className="text-xs text-gray-600">Completed</div>
                  </div>
                  <div className="bg-white p-2 rounded-lg">
                    <div className="text-lg sm:text-xl font-bold text-yellow-600">{(() => {
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                      let weeklyPoints = 0;
                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                        const dayTasks = getTasksForDay(dayName);
                        dayTasks.forEach(task => {
                          if (isTaskCompleted(task.id, day)) {
                            weeklyPoints += task.points;
                          }
                        });
                      }
                      return weeklyPoints;
                    })()}</div>
                    <div className="text-xs text-gray-600">Total Points</div>
                  </div>
                  <div className="bg-white p-2 rounded-lg">
                    <div className="text-lg sm:text-xl font-bold text-purple-600">{(() => {
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                      let totalWeeklyTasks = 0;
                      let completedWeeklyTasks = 0;
                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                        const dayTasks = getTasksForDay(dayName);
                        totalWeeklyTasks += dayTasks.length;
                        completedWeeklyTasks += dayTasks.filter(t => isTaskCompleted(t.id, day)).length;
                      }
                      return totalWeeklyTasks ? Math.round((completedWeeklyTasks / totalWeeklyTasks) * 100) : 0;
                    })()}%</div>
                    <div className="text-xs text-gray-600">Progress</div>
                  </div>
                </div>
              </div>
              <div className="bg-blue-50 p-3 rounded-lg mb-4 text-center text-xs">
                <div className="text-blue-600 mb-1">
                  {selectedDate.toDateString() === new Date().toDateString() ? 
                    "ðŸ“ Current Day" :
                    selectedDate < new Date() ? 
                    "ðŸ“… Past Day" : 
                    "ðŸ”® Future Day"}
                </div>
                <div className="text-gray-600">
                  {selectedDate < new Date() ? 
                    "Showing past tasks" :
                    selectedDate.toDateString() === new Date().toDateString() ?
                    "Complete tasks today" :
                    "Plan upcoming tasks"}
                </div>
              </div>
              <div className="grid grid-cols-1 gap-4">
                {users.map((user, index) => {
                  const userTasks = tasks.filter(t => t.assignee === user.name);
                  const completedTasks = userTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                  const dailyTasks = userTasks.filter(t => t.frequency === "Daily");
                  const customTasks = userTasks.filter(t => t.frequency !== "Daily");
                  const completedDaily = dailyTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                  const completedCustom = customTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                  const colors = ["bg-blue-50 border-blue-200", "bg-purple-50 border-purple-200", "bg-orange-50 border-orange-200", "bg-pink-50 border-pink-200"];
                  const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                  const dateContext = selectedDate.toDateString() === new Date().toDateString() ? 
                    "" : selectedDate < new Date() ? " (Past)" : " (Future)";

                  return (
                    <div key={user.name} className={`${colors[index]} border-2 p-4 rounded-xl shadow-lg`}>
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center">
                          <div className="text-2xl sm:text-3xl mr-2">{avatarEmojis[index]}</div>
                          <div>
                            <h4 className="text-base sm:text-lg font-semibold text-gray-800">{user.name}{dateContext}</h4>
                            <p className="text-xs text-gray-600">{user.points} pts</p>
                          </div>
                        </div>
                        <div className="text-center">
                          <div className="text-lg font-bold text-green-600">{userTasks.length ? Math.round((completedTasks.length / userTasks.length) * 100) : 0}%</div>
                          <div className="text-xs text-gray-500">Complete</div>
                        </div>
                      </div>
                      <div className="mb-3">
                        <div className="flex justify-between text-xs sm:text-sm text-gray-600 mb-1">
                          <span>Progress</span>
                          <span>{completedTasks.length}/{userTasks.length}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div 
                            className="bg-green-500 h-2 rounded-full transition-all duration-500" 
                            style={{ width: `${userTasks.length ? (completedTasks.length / userTasks.length) * 100 : 0}%` }}
                          ></div>
                        </div>
                      </div>
                      {dailyTasks.length > 0 && (
                        <div className="mb-3">
                          <div className="flex items-center justify-between mb-1">
                            <h4 className="font-semibold text-blue-700 text-sm">ðŸŒ… Daily Tasks</h4>
                            <span className="text-xs bg-blue-200 px-1 py-0.5 rounded-full">{completedDaily.length}/{dailyTasks.length}</span>
                          </div>
                          <div className="space-y-1">
                            {dailyTasks.map(task => (
                              <div key={task.id} className={`flex items-center p-2 rounded-lg text-xs sm:text-sm min-h-[48px] ${
                                isTaskCompleted(task.id, selectedDate)
                                  ? "bg-green-100 text-green-800" 
                                  : "bg-white border border-blue-100"
                              }`}>
                                <div className={`w-4 h-4 rounded-full mr-2 flex items-center justify-center text-xs ${
                                  isTaskCompleted(task.id, selectedDate) ? "bg-green-500 text-white" : "bg-gray-200"
                                }`}>
                                  {isTaskCompleted(task.id, selectedDate) ? "âœ“" : ""}
                                </div>
                                <span className="mr-1">{getTaskEmoji(task.name, task.emoji)}</span>
                                <span className={isTaskCompleted(task.id, selectedDate) ? "line-through" : ""}>{task.name}</span>
                                <span className="ml-auto text-yellow-600">{task.points}pts</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {customTasks.length > 0 && (
                        <div>
                          <div className="flex items-center justify-between mb-1">
                            <h4 className="font-semibold text-purple-700 text-sm">ðŸ“… Custom Tasks</h4>
                            <span className="text-xs bg-purple-200 px-1 py-0.5 rounded-full">{completedCustom.length}/{customTasks.length}</span>
                          </div>
                          <div className="space-y-1">
                            {customTasks.map(task => (
                              <div key={task.id} className={`flex items-center p-2 rounded-lg text-xs sm:text-sm min-h-[48px] ${
                                isTaskCompleted(task.id, selectedDate)
                                  ? "bg-green-100 text-green-800" 
                                  : "bg-white border border-purple-100"
                              }`}>
                                <div className={`w-4 h-4 rounded-full mr-2 flex items-center justify-center text-xs ${
                                  isTaskCompleted(task.id, selectedDate) ? "bg-green-500 text-white" : "bg-gray-200"
                                }`}>
                                  {isTaskCompleted(task.id, selectedDate) ? "âœ“" : ""}
                                </div>
                                <span className="mr-1">{getTaskEmoji(task.name, task.emoji)}</span>
                                <span className={isTaskCompleted(task.id, selectedDate) ? "line-through" : ""}>{task.name}</span>
                                <span className="ml-auto text-yellow-600">{task.points}pts</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {userTasks.length === 0 && (
                        <div className="text-center py-3 text-gray-500">
                          <div className="text-lg mb-1">ðŸŽ‰</div>
                          <p className="text-xs">No tasks assigned!</p>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
              <div className="mt-4 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl border-2 border-green-200">
                <h3 className="text-base sm:text-lg font-semibold text-green-800 mb-2 text-center">Family Summary</h3>
                <div className="grid grid-cols-2 gap-2 text-center text-xs sm:text-sm">
                  <div className="bg-white p-1 rounded-lg">
                    <div className="text-sm sm:text-lg font-bold text-blue-600">{tasks.length}</div>
                    <div className="text-xs">Total</div>
                  </div>
                  <div className="bg-white p-1 rounded-lg">
                    <div className="text-sm sm:text-lg font-bold text-green-600">{tasks.filter(t => isTaskCompleted(t.id, selectedDate)).length}</div>
                    <div className="text-xs">Done</div>
                  </div>
                  <div className="bg-white p-1 rounded-lg">
                    <div className="text-sm sm:text-lg font-bold text-yellow-600">{tasks.reduce((sum, task) => sum + (isTaskCompleted(task.id, selectedDate) ? task.points : 0), 0)}</div>
                    <div className="text-xs">Points</div>
                  </div>
                  <div className="bg-white p-1 rounded-lg">
                    <div className="text-sm sm:text-lg font-bold text-purple-600">{completionRate()}%</div>
                    <div className="text-xs">Progress</div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Leaderboard View */}
          {currentPage === PAGES.LEADERBOARD && (
            <div className="pb-20">
              <div className="text-center mb-4">
                <h2 className="text-lg sm:text-xl font-bold text-green-700">ðŸ† Rewards</h2>
                <div className="text-sm text-gray-600 mt-1">
                  {(() => {
                    const startOfWeek = new Date();
                    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    return `Week of ${startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                  })()}
                </div>
              </div>
              <div className="mb-6">
                <ul className="grid grid-cols-1 gap-2">
                  {users
                    .sort((a, b) => b.points - a.points)
                    .map((user, index) => (
                      <li key={user.name} className="border-2 p-3 rounded-lg bg-gradient-to-r from-white to-green-50">
                        <div className="flex flex-col sm:flex-row justify-between">
                          <div className="flex-1">
                            <div className="flex items-center mb-2">
                              <span className="text-lg sm:text-xl mr-2">
                                {index === 0 ? "ðŸ¥‡" : index === 1 ? "ðŸ¥ˆ" : index === 2 ? "ðŸ¥‰" : "ðŸŽ¯"}
                              </span>
                              <span className="font-bold text-sm sm:text-base">{user.name}</span>
                              <div className="ml-2 flex items-center bg-gradient-to-r from-yellow-100 to-orange-100 rounded-full px-2 py-1 shadow-sm border border-yellow-200">
                                <span className="text-lg mr-1 filter drop-shadow-sm">â­</span>
                                <span className="font-bold text-orange-800 text-xs sm:text-sm">{user.points}</span>
                              </div>
                            </div>

                            <div>
                              <span className="text-xs font-semibold text-gray-700">Badges ({user.badges.length}):</span>
                              <div className="flex flex-wrap gap-1 mt-1">
                                {user.badges.length ? user.badges.map(badge => (
                                  <span key={badge} className="inline-flex items-center px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full border border-yellow-300">
                                    <span className="mr-1">{badgeDefinitions[badge]?.emoji || "ðŸ…"}</span>
                                    <span>{badge}</span>
                                  </span>
                                )) : (
                                  <span className="text-gray-400 text-xs">No badges yet</span>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      </li>
                    ))}
                </ul>
              </div>




            </div>
          )}

          {/* Badge Editor View */}
          {currentPage === PAGES.BADGE_EDITOR && (
            <div className="pb-20">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg sm:text-xl font-bold text-green-700">ðŸŽ–ï¸ Add/Edit Badges</h2>
                <button
                  onClick={() => navigateToPage(PAGES.LEADERBOARD)}
                  className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
                >
                  â† Back
                </button>
              </div>
              <div className="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                <h3 className="text-base sm:text-lg font-semibold text-yellow-800 mb-3">âž• New Badge</h3>
                <form onSubmit={addCustomBadge} className="space-y-2">
                  <div className="grid grid-cols-1 gap-2">
                    <input
                      type="text"
                      placeholder="Badge Name"
                      value={newCustomBadge.name || ''}
                      onChange={(e) => setNewCustomBadge({ ...newCustomBadge, name: e.target.value })}
                      className="w-full border border-gray-200 p-2 rounded-lg focus:border-yellow-400 text-sm"
                      required
                    />
                    <input
                      type="text"
                      placeholder="Description"
                      value={newCustomBadge.description || ''}
                      onChange={(e) => setNewCustomBadge({ ...newCustomBadge, description: e.target.value })}
                      className="w-full border border-gray-200 p-2 rounded-lg focus:border-yellow-400 text-sm"
                      required
                    />                    <div>
                      <label className="block text-xs font-semibold mb-1">Stars:</label>
                      <input
                        type="number"
                        placeholder="0"
                        min="0"
                        value={newCustomBadge.points || 0}
                        onChange={(e) => setNewCustomBadge({ ...newCustomBadge, points: e.target.value === '' ? 0 : Number(e.target.value) })}
                        className="w-full border border-gray-200 p-2 rounded-lg focus:border-yellow-400 text-sm"
                      />
                      <div className="text-xs text-yellow-700 mt-1">Set to 0 if no stars required</div>
                    </div>
                    <div>
                      <label className="block text-xs font-semibold mb-1">Emoji:</label>
                      <button
                        type="button"
                        onClick={() => openEmojiPicker('newBadge')}
                        className="w-full border border-gray-200 p-2 rounded-lg focus:border-yellow-400 text-sm flex items-center justify-between"
                      >
                        <div className="flex items-center">
                          {newCustomBadge.emoji && <span className="text-lg mr-2">{newCustomBadge.emoji}</span>}
                          <span className={newCustomBadge.emoji ? "text-gray-800" : "text-gray-500"}>
                            {newCustomBadge.emoji ? "Change Emoji" : "Choose Emoji"}
                          </span>
                        </div>
                        <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>
                    </div>
                    <button 
                      type="submit" 
                      className="w-full bg-yellow-500 text-white p-2 rounded-lg text-sm font-semibold min-h-[48px]"
                    >
                      Create Badge
                    </button>
                  </div>
                </form>
              </div>
              <div className="bg-white p-4 rounded-lg border border-gray-200">
                <h3 className="text-base sm:text-lg font-semibold text-gray-800 mb-3">All Badges</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs sm:text-sm">
                  {Object.entries(badgeDefinitions).map(([badgeName, badgeInfo]) => (
                    <div key={badgeName} className={`border ${badgeInfo.isCustom ? "bg-blue-50 border-blue-200" : "bg-white border-gray-200"}`}>
                      {editingBadge === badgeName ? (
                        <div className="p-3 space-y-2">
                          <div className="grid grid-cols-1 gap-2">
                            <input
                              key={`${badgeName}-emoji`}
                              type="text"
                              value={badgeInfo.emoji || ''}
                              onChange={(e) => updateBadge(badgeName, { ...badgeInfo, emoji: e.target.value })}
                              className="w-full border p-2 rounded text-lg text-center"
                              maxLength="4"
                            />
                            <input
                              key={`${badgeName}-description`}
                              type="text"
                              value={badgeInfo.description || ''}
                              onChange={(e) => updateBadge(badgeName, { ...badgeInfo, description: e.target.value })}
                              className="w-full border p-2 rounded text-sm"
                            />
                            <input
                              key={`${badgeName}-points`}
                              type="number"
                              min="0"
                              value={badgeInfo.points || 0}
                              onChange={(e) => updateBadge(badgeName, { ...badgeInfo, points: e.target.value === '' ? 0 : Number(e.target.value) })}
                              className="w-full border p-2 rounded text-sm"
                              placeholder="0"
                            />
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => setEditingBadge(null)}
                              className="flex-1 bg-gray-500 text-white px-2 py-1 rounded text-xs"
                            >
                              Cancel
                            </button>
                            <button
                              onClick={() => saveBadgeChanges(badgeName, badgeInfo)}
                              className="flex-1 bg-green-500 text-white px-2 py-1 rounded text-xs"
                            >
                              Save
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="flex items-center p-2 rounded relative">
                          <span className="text-base sm:text-lg mr-2">{badgeInfo.emoji}</span>
                          <div className="flex-1">
                            <div className="font-semibold text-xs">{badgeName}</div>
                            <div className="text-gray-600 text-xs">{badgeInfo.description}</div>
                            {badgeInfo.points > 0 && (
                              <div className="text-yellow-600 text-xs">{badgeInfo.points} â­</div>
                            )}
                          </div>
                          <div className="absolute top-1 right-1 flex gap-1">
                            <button
                              onClick={() => setEditingBadge(badgeName)}
                              className="bg-blue-500 text-white px-1 py-1 rounded text-xs min-h-[24px] min-w-[24px]"
                            >
                              âœï¸
                            </button>
                            <button
                              onClick={() => deleteBadge(badgeName)}
                              className="bg-red-500 text-white px-1 py-1 rounded text-xs min-h-[24px] min-w-[24px]"
                            >
                              ðŸ—‘ï¸
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Profile View */}
          {currentPage === PAGES.PROFILE && selectedProfile && (
            <div className="pb-20">
              {(() => {
                const user = users.find(u => u.name === selectedProfile);
                const userIndex = users.findIndex(u => u.name === selectedProfile);
                const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                const colors = ["bg-blue-50 border-blue-200", "bg-purple-50 border-purple-200", "bg-orange-50 border-orange-200", "bg-pink-50 border-pink-200"];
                const userTasks = tasks.filter(t => t.assignee === selectedProfile);
                const todayTasks = userTasks.filter(t => getTasksForDay(getCurrentDayName()).includes(t));
                const completedTasks = todayTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                const completionRate = todayTasks.length ? Math.round((completedTasks.length / todayTasks.length) * 100) : 0;

                if (!user) return <div>Profile not found</div>;

                return (
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h2 className="text-lg sm:text-xl font-bold text-green-700">ðŸ‘¤ {user.name}'s Profile</h2>
                      <button
                        onClick={() => navigateToPage(PAGES.TASKS)}
                        className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
                      >
                        â† Back
                      </button>
                    </div>

                    {/* Profile Card */}
                    <div className={`${colors[userIndex]} border-2 p-6 rounded-xl shadow-lg mb-6`}>
                      {editingProfile ? (
                        <div className="space-y-4">
                          <div className="text-center">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Edit Profile</h3>
                            <div className="mb-4">
                              <label className="block text-sm font-semibold mb-2">Avatar Emoji:</label>
                              <div className="relative">
                                <select
                                  value={avatarEmojis[userIndex]}
                                  onChange={(e) => {
                                    // This would require updating the avatar system
                                    alert("Avatar customization coming soon!");
                                  }}
                                  className="w-full sm:w-32 border border-gray-200 p-2 rounded-lg text-center text-xl pr-8 appearance-none"
                                >
                                  {["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦", "ðŸ‘§", "ðŸ§’", "ðŸ™‹â€â™€ï¸", "ðŸ™‹â€â™‚ï¸", "ðŸ¤·â€â™€ï¸", "ðŸ¤·â€â™‚ï¸"].map((emoji, idx) => (
                                    <option key={idx} value={emoji}>{emoji}</option>
                                  ))}
                                </select>
                                <div className="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                  <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                  </svg>
                                </div>
                              </div>
                            </div>
                            <div className="mb-4">
                              <label className="block text-sm font-semibold mb-2">Name:</label>
                              <input
                                type="text"
                                value={user.name}
                                onChange={(e) => {
                                  const updatedUsers = users.map(u => 
                                    u.name === selectedProfile ? { ...u, name: e.target.value } : u
                                  );
                                  setUsers(updatedUsers);
                                  setSelectedProfile(e.target.value);
                                }}
                                className="w-full sm:w-48 border border-gray-200 p-2 rounded-lg text-center"
                              />
                            </div>
                            <div className="flex gap-2 justify-center">
                              <button
                                onClick={() => setEditingProfile(false)}
                                className="bg-green-500 text-white px-4 py-2 rounded-lg text-sm"
                              >
                                âœ… Save
                              </button>
                              <button
                                onClick={() => setEditingProfile(false)}
                                className="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm"
                              >
                                âŒ Cancel
                              </button>
                            </div>
                          </div>
                        </div>
                      ) : (
                        <div>
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center">
                              <div className="text-4xl mr-4">{user.avatar || avatarEmojis[userIndex]}</div>
                              <div>
                                <h3 className="text-xl font-bold text-gray-800">{user.name}</h3>
                                <p className="text-gray-600">{user.points} points this week</p>
                              </div>
                            </div>
                            <button
                              onClick={() => navigateToPage(PAGES.FAMILY_MEMBERS)}
                              className="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm"
                            >
                              âœï¸ Edit
                            </button>
                          </div>

                          <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-white p-3 rounded-lg text-center">
                              <div className="text-2xl font-bold text-green-600">{completionRate}%</div>
                              <div className="text-xs text-gray-600">Today's Progress</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg text-center">
                              <div className="text-2xl font-bold text-yellow-600">{user.badges.length}</div>
                              <div className="text-xs text-gray-600">Badges Earned</div>
                            </div>
                          </div>

                          {user.badges.length > 0 && (
                            <div className="mb-4">
                              <h4 className="text-sm font-semibold text-gray-700 mb-2">ðŸ† Badges:</h4>
                              <div className="flex flex-wrap gap-2">
                                {user.badges.map((badge, badgeIndex) => (
                                  <span key={badgeIndex} className="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full border border-yellow-300">
                                    <span className="mr-1">{badgeDefinitions[badge]?.emoji || "ðŸ…"}</span>
                                    {badge}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* User's Tasks */}
                    <div className="bg-white p-4 rounded-lg border border-gray-200">
                      <h3 className="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ My Tasks</h3>

                      {/* Today's Tasks */}
                      <div className="mb-6">
                        <h4 className="text-md font-semibold text-blue-700 mb-3">
                          ðŸŒ… Today ({selectedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })})
                        </h4>
                        {todayTasks.length > 0 ? (
                          <div className="space-y-2">
                            {todayTasks.map(task => (
                              <div key={task.id} className={`flex items-center p-3 rounded-lg border-2 ${
                                isTaskCompleted(task.id, selectedDate)
                                  ? "bg-green-100 border-green-300 text-green-800" 
                                  : "bg-white border-gray-200"
                              }`}>
                                <div className={`w-5 h-5 rounded-full mr-3 flex items-center justify-center text-sm ${
                                  isTaskCompleted(task.id, selectedDate) ? "bg-green-500 text-white" : "bg-gray-200"
                                }`}>
                                  {isTaskCompleted(task.id, selectedDate) ? "âœ“" : ""}
                                </div>
                                <div className="flex items-center flex-1">
                                  <span className="text-lg mr-2">{getTaskEmoji(task.name, task.emoji)}</span>
                                  <div className="flex-1">
                                    <div className={`font-semibold text-sm ${isTaskCompleted(task.id, selectedDate) ? "line-through" : ""}`}>
                                      {task.name}
                                    </div>
                                    <div className="text-xs text-gray-600">
                                      <span className="text-yellow-600 font-medium">{task.points} pts</span>
                                      {task.daysOfWeek && task.daysOfWeek.length < 7 && (
                                        <span className="ml-2 text-blue-600">
                                          {task.daysOfWeek.map(d => d.slice(0, 3)).join(", ")}
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div className="text-center py-4 text-gray-500">
                            <div className="text-2xl mb-2">ðŸŽ‰</div>
                            <p className="text-sm">No tasks for today!</p>
                          </div>
                        )}
                      </div>

                      {/* Weekly Tasks */}
                      <div className="mb-6">
                        <h4 className="text-md font-semibold text-green-700 mb-3">ðŸ“… This Week's Tasks</h4>
                        <div className="space-y-3">
                          {(() => {
                            const weekDays = [];
                            const startOfWeek = new Date(selectedDate);
                            startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());

                            for (let i = 0; i < 7; i++) {
                              const day = new Date(startOfWeek);
                              day.setDate(startOfWeek.getDate() + i);
                              const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                              const dayTasks = userTasks.filter(t => {
                                if (!t.daysOfWeek) return t.frequency === "Daily";
                                return t.daysOfWeek.includes(dayName);
                              });

                              const isToday = day.toDateString() === new Date().toDateString();
                              const isPast = day < new Date() && !isToday;
                              const isFuture = day > new Date();

                              let dayStatus = "Today";
                              let dayColor = "bg-blue-50 border-blue-200";
                              if (isPast) {
                                dayStatus = "Past";
                                dayColor = "bg-gray-50 border-gray-200";
                              } else if (isFuture) {
                                dayStatus = "Future";
                                dayColor = "bg-yellow-50 border-yellow-200";
                              }

                              const completedCount = dayTasks.filter(t => isTaskCompleted(t.id, day)).length;
                              const completionRate = dayTasks.length ? Math.round((completedCount / dayTasks.length) * 100) : 0;

                              weekDays.push(
                                <div key={i} className={`${dayColor} border-2 p-3 rounded-lg`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center">
                                      <h5 className="font-semibold text-sm">
                                        {day.toLocaleDateString('en-US', { 
                                          weekday: 'short', 
                                          month: 'short', 
                                          day: 'numeric' 
                                        })}
                                      </h5>
                                      <span className={`ml-2 px-2 py-0.5 rounded-full text-xs ${
                                        isToday ? "bg-blue-200 text-blue-800" :
                                        isPast ? "bg-gray-200 text-gray-700" :
                                        "bg-yellow-200 text-yellow-800"
                                      }`}>
                                        {dayStatus}
                                      </span>
                                    </div>
                                    <div className="text-right">
                                      <div className="text-sm font-bold text-green-600">{completionRate}%</div>
                                      <div className="text-xs text-gray-500">{completedCount}/{dayTasks.length}</div>
                                    </div>
                                  </div>

                                  {dayTasks.length > 0 ? (
                                    <div className="space-y-1">
                                      {dayTasks.map(task => (
                                        <div key={`${task.id}-${i}`} className={`flex items-center p-2 rounded text-xs ${
                                          isTaskCompleted(task.id, day)
                                            ? "bg-green-100 text-green-800" 
                                            : "bg-white border border-gray-100"
                                        }`}>
                                          <div className={`w-3 h-3 rounded-full mr-2 flex items-center justify-center text-xs ${
                                            isTaskCompleted(task.id, day) ? "bg-green-500 text-white" : "bg-gray-300"
                                          }`}>
                                            {isTaskCompleted(task.id, day) ? "âœ“" : ""}
                                          </div>
                                          <span className="mr-1">{getTaskEmoji(task.name, task.emoji)}</span>
                                          <span className={`flex-1 ${isTaskCompleted(task.id, day) ? "line-through" : ""}`}>
                                            {task.name}
                                          </span>
                                          <span className="text-yellow-600 font-medium">{task.points}pts</span>
                                        </div>
                                      ))}
                                    </div>
                                  ) : (
                                    <div className="text-center py-2 text-gray-500">
                                      <span className="text-xs">No tasks</span>
                                    </div>
                                  )}
                                </div>
                              );
                            }
                            return weekDays;
                          })()}
                        </div>
                      </div>

                    </div>

                    {/* Profile Summary Section */}
                    {(() => {
                      const user = users.find(u => u.name === selectedProfile);
                      const userIndex = users.findIndex(u => u.name === selectedProfile);
                      const userColor = user?.color;

                      // Get color based on user's theme color
                      let colorClass = "bg-gray-50 border-gray-200";
                      if (userColor) {
                        switch (userColor) {
                          case "blue": colorClass = "bg-blue-50 border-blue-200"; break;
                          case "purple": colorClass = "bg-purple-50 border-purple-200"; break;
                          case "orange": colorClass = "bg-orange-50 border-orange-200"; break;
                          case "pink": colorClass = "bg-pink-50 border-pink-200"; break;
                          case "green": colorClass = "bg-green-50 border-green-200"; break;
                          case "red": colorClass = "bg-red-50 border-red-200"; break;
                          case "yellow": colorClass = "bg-yellow-50 border-yellow-200"; break;
                          case "indigo": colorClass = "bg-indigo-50 border-indigo-200"; break;
                          default: colorClass = "bg-gray-50 border-gray-200"; break;
                        }
                      } else {
                        // Fallback to index-based colors for backward compatibility
                        const colors = ["bg-blue-50 border-blue-200", "bg-purple-50 border-purple-200", "bg-orange-50 border-orange-200", "bg-pink-50 border-pink-200"];
                        colorClass = colors[userIndex] || "bg-gray-50 border-gray-200";
                      }

                      const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                      const userTasks = tasks.filter(t => t.assignee === selectedProfile);
                      const todayTasks = userTasks.filter(t => getTasksForDay(getCurrentDayName()).includes(t));
                      const completedTasks = todayTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                      const completionRate = todayTasks.length ? Math.round((completedTasks.length / todayTasks.length) * 100) : 0;

                      return (
                        <div className={`${colorClass} border-2 p-6 rounded-xl shadow-lg mb-6 mt-6`}>
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center">
                              <div className="text-4xl mr-4">{user.avatar || avatarEmojis[userIndex] || "ðŸ‘¤"}</div>
                              <div>
                                <h3 className="text-xl font-bold text-gray-800">{user.name}</h3>
                                <p className="text-gray-600">{user.points} points this week</p>
                              </div>
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-white p-3 rounded-lg text-center">
                              <div className="text-2xl font-bold text-green-600">{completionRate}%</div>
                              <div className="text-xs text-gray-600">Today's Progress</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg text-center">
                              <div className="text-2xl font-bold text-yellow-600">{user.badges.length}</div>
                              <div className="text-xs text-gray-600">Badges Earned</div>
                            </div>
                          </div>

                          {user.badges.length > 0 && (
                            <div className="mb-4">
                              <h4 className="text-sm font-semibold text-gray-700 mb-2">ðŸ† Badges:</h4>
                              <div className="flex flex-wrap gap-2">
                                {user.badges.map((badge, badgeIndex) => (
                                  <span key={badgeIndex} className="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full border border-yellow-300">
                                    <span className="mr-1">{badgeDefinitions[badge]?.emoji || "ðŸ…"}</span>
                                    {badge}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })()}

                    {/* Weekly Stats */}
                    <div className="mt-6 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl border-2 border-green-200">
                      <h3 className="text-lg font-bold text-green-800 mb-3 text-center">ðŸ“Š Weekly Stats</h3>
                      <div className="grid grid-cols-2 gap-4 text-center text-sm">
                        <div className="bg-white p-3 rounded-lg">
                          <div className="text-xl font-bold text-blue-600">{(() => {
                            const startOfWeek = new Date(selectedDate);
                            startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                            let weeklyTotalTasks = 0;
                            for (let i = 0; i < 7; i++) {
                              const day = new Date(startOfWeek);
                              day.setDate(startOfWeek.getDate() + i);
                              const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                              const dayTasks = userTasks.filter(t => {
                                if (!t.daysOfWeek) return t.frequency === "Daily";
                                return t.daysOfWeek.includes(dayName);
                              });
                              weeklyTotalTasks += dayTasks.length;
                            }
                            return weeklyTotalTasks;
                          })()}</div>
                          <div className="text-xs text-gray-600">Total Tasks This Week</div>
                        </div>
                        <div className="bg-white p-3 rounded-lg">
                          <div className="text-xl font-bold text-green-600">{(() => {
                            const startOfWeek = new Date(selectedDate);
                            startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                            let weeklyCompleted = 0;
                            for (let i = 0; i < 7; i++) {
                              const day = new Date(startOfWeek);
                              day.setDate(startOfWeek.getDate() + i);
                              const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                              const dayTasks = userTasks.filter(t => {
                                if (!t.daysOfWeek) return t.frequency === "Daily";
                                return t.daysOfWeek.includes(dayName);
                              });
                              weeklyCompleted += dayTasks.filter(t => isTaskCompleted(t.id, day)).length;
                            }
                            return weeklyCompleted;
                          })()}</div>
                          <div className="text-xs text-gray-600">Completed This Week</div>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>
          )}

          {/* Task Editor View */}
          {currentPage === PAGES.TASK_EDITOR && (
            <div className="pb-20">
              {/* Header */}
              <div className="flex items-center justify-between mb-6">
                <button
                  onClick={() => {
                    setShowPresets(false);
                    navigateToPage(PAGES.TASKS);
                  }}
                  className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
                >
                  â† Back
                </button>
              </div>

              {/* Add New Task Section */}
              <div className="bg-orange-50 rounded-lg p-4 sm:p-6 border border-orange-200 mb-6">
                <div className="mb-4">
                  <h3 className="text-lg font-semibold text-gray-800 flex items-center mb-3">
                    <span className="mr-2">âž•</span>
                    Add New Task
                  </h3>
                </div>

                {showPresets ? (
                  /* Preset Tasks List */
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-semibold text-gray-800">Choose a Preset</h3>
                      <button
                        onClick={() => setShowPresets(false)}
                        className="text-gray-500 text-sm"
                      >
                        Cancel
                      </button>
                    </div>
                    <div className="space-y-3">
                      {presetTasks.map((preset, index) => (
                        <button
                          key={index}
                          onClick={() => selectPresetTask(preset)}
                          className="w-full bg-white border border-gray-200 rounded-lg p-4 text-left hover:border-orange-500 hover:bg-orange-50 transition-colors"
                        >
                          <div className="flex items-center">
                            <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                              <span className="text-lg">{preset.emoji}</span>
                            </div>
                            <div className="flex-1">
                              <div className="font-medium text-gray-800">{preset.name}</div>
                              <div className="text-sm text-gray-600">{preset.notes}</div>
                              <div className="flex items-center mt-1">
                                <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full mr-2">
                                  â­ {preset.points} pts
                                </span>
                                <span className="text-xs text-gray-500">
                                  {preset.frequency === "Daily" ? "Daily" : `${preset.daysOfWeek?.join(", ") || "Custom"}`}
                                </span>
                              </div>
                            </div>
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div>
                    <div className="space-y-6">
                      {/* Task Name */}
                      <div>
                        <input
                          type="text"
                          placeholder="Task Name"
                          value={newTask.name || ''}
                          onChange={(e) => setNewTask({ ...newTask, name: e.target.value })}
                          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                          required
                        />
                        <div className="flex justify-end mt-2">
                          <button 
                            onClick={() => setShowPresets(true)}
                            className="text-orange-500 text-sm font-medium flex items-center"
                          >
                            <span className="mr-1">ðŸŽ¯</span>
                            Use Preset
                          </button>
                        </div>
                      </div>

                      {/* Notes */}
                      <div>
                        <input
                          type="text"
                          placeholder="Notes"
                          value={newTask.notes || ''}
                          onChange={(e) => setNewTask({ ...newTask, notes: e.target.value })}
                          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                        />
                      </div>

                      {/* Emoji Selection */}
                      <div>
                        <button
                          type="button"
                          onClick={() => openEmojiPicker('newTask')}
                          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:border-orange-500 focus:outline-none flex items-center justify-between"
                        >
                          <div className="flex items-center">
                            {newTask.emoji && <span className="text-2xl mr-2">{newTask.emoji}</span>}
                            <span className={newTask.emoji ? "text-gray-800" : "text-gray-500"}>
                              {newTask.emoji ? "Change Emoji" : "Choose Emoji"}
                            </span>
                          </div>
                          <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </button>
                      </div>

                      {/* Stars per completion */}
                      <div>
                        <label className="block text-gray-600 text-sm font-medium mb-3">STARS PER COMPLETION</label>
                        <div className="flex items-center justify-center space-x-4">
                          <button
                            onClick={() => setNewTask({ ...newTask, points: Math.max(0, (newTask.points || 0) - 1) })}
                            className="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center text-gray-800 text-xl"
                            type="button"
                          >
                            âˆ’
                          </button>
                          <input
                            type="number"
                            min="0"
                            value={newTask.points || 0}
                            onChange={e => setNewTask({ ...newTask, points: Math.max(0, Number(e.target.value)) })}
                            className="w-24 text-center bg-gray-100 rounded-lg px-2 py-3 text-2xl font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-400"
                          />
                            <span className="text-2xl">â­</span>
                          <button
                            onClick={() => setNewTask({ ...newTask, points: (newTask.points || 0) + 1 })}
                            className="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center text-white text-xl"
                            type="button"
                          >
                            +
                          </button>
                        </div>
                      </div>

                      {/* Start Date */}
                      <div className="flex items-center justify-between">
                        <span className="text-gray-800 font-medium">Start Date</span>
                        <input
                          type="date"
                          value={newTask.startDate}
                          onChange={(e) => setNewTask({ ...newTask, startDate: e.target.value })}
                          className="bg-transparent text-gray-600 border-none outline-none text-right"
                        />
                      </div>

                      {/* Repeat */}
                      <div className="flex items-center justify-between">
                        <span className="text-gray-800 font-medium">Repeat</span>
                        <div className="flex items-center">
                          <select
                            value={newTask.frequency}
                            onChange={(e) => {
                              const freq = e.target.value;
                              setNewTask({ 
                                ...newTask, 
                                frequency: freq,
                                daysOfWeek: freq === "Daily" ? ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] : 
                                          freq === "Once" ? [] : ["Monday"] 
                              });
                            }}
                            className="bg-transparent text-gray-600 border-none outline-none pr-6 appearance-none"
                          >
                            <option value="Daily" className="bg-white">Every Day</option>
                            <option value="Specific" className="bg-white">Specific Days</option>
                            <option value="Once" className="bg-white">Once</option>
                          </select>
                          <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </div>

                      {/* Specific Days Selection */}
                      {newTask.frequency === "Specific" && (
                        <div>
                          <label className="block text-gray-600 text-sm font-medium mb-3">SELECT DAYS</label>
                          <div className="grid grid-cols-7 gap-2">
                            {["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map((day, index) => {
                              const fullDay = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"][index];
                              return (
                                <button
                                  key={day}
                                  type="button"
                                  onClick={() => {
                                    if (newTask.daysOfWeek.includes(fullDay)) {
                                      setNewTask({ 
                                        ...newTask, 
                                        daysOfWeek: newTask.daysOfWeek.filter(d => d !== fullDay)
                                      });
                                    } else {
                                      setNewTask({ 
                                        ...newTask, 
                                        daysOfWeek: [...newTask.daysOfWeek, fullDay]
                                      });
                                    }
                                  }}
                                  className={`py-2 px-2 rounded-lg text-sm font-medium ${
                                    newTask.daysOfWeek.includes(fullDay)
                                      ? "bg-orange-500 text-white"
                                      : "bg-gray-200 text-gray-700"
                                  }`}
                                >
                                  {day}
                                </button>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* Time of Day */}
                      <div className="flex items-center justify-between">
                        <span className="text-gray-800 font-medium">Time of Day</span>
                        <div className="flex items-center">
                          <select
                            value={newTask.timeOfDay || "Anytime"}
                            onChange={(e) => setNewTask({ ...newTask, timeOfDay: e.target.value })}
                            className="bg-transparent text-gray-600 border-none outline-none pr-6 appearance-none"
                          >
                            <option value="Anytime" className="bg-white">Anytime</option>
                            <option value="Morning" className="bg-white">Morning</option>
                            <option value="Afternoon" className="bg-white">Afternoon</option>
                            <option value="Evening" className="bg-white">Evening</option>
                          </select>
                          <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </div>

                      {/* Assignee */}
                      <div className="flex items-center justify-between">
                        <span className="text-gray-800 font-medium">Assigned To</span>
                        <div className="flex items-center">
                          <select
                            value={newTask.assignee}
                            onChange={(e) => setNewTask({ ...newTask, assignee: e.target.value })}
                            className="bg-transparent text-gray-600 border-none outline-none pr-6 appearance-none"
                          >
                            {users.map((u, index) => {
                              const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                              const userAvatar = u.avatar || avatarEmojis[index] || "ðŸ‘¤";
                              return (
                                <option key={u.name} value={u.name} className="bg-white">
                                  {userAvatar} {u.name}
                                </option>
                              );
                            })}
                          </select>
                          <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </div>

                      {/* Add Button */}
                      <div className="pt-4">
                        <button
                          onClick={addTask}
                          disabled={!newTask.name || (newTask.frequency !== 'Once' && newTask.daysOfWeek.length === 0)}
                          className={`w-full px-4 py-3 rounded-lg font-medium text-base ${
                            !newTask.name || (newTask.frequency !== 'Once' && newTask.daysOfWeek.length === 0)
                              ? "bg-gray-300 text-gray-500 cursor-not-allowed" 
                              : "bg-blue-600 text-white hover:bg-blue-700 shadow-lg transform hover:scale-105 transition-all duration-200"
                          }`}
                        >
                          Add Task
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Existing Tasks List */}
              <div className="bg-blue-50 rounded-lg p-4 sm:p-6 border border-blue-200">
                <div className="mb-4">
                  <h3 className="text-lg font-semibold text-gray-800 flex items-center mb-3">
                    <span className="mr-2">ðŸ“‹</span>
                    All Tasks
                  </h3>
                  <div className="flex flex-wrap gap-2">
                    <span className="text-xs sm:text-sm text-gray-500 bg-white px-2 sm:px-3 py-1 rounded-full border">
                      {tasks.length} total
                    </span>
                    <span className="text-xs sm:text-sm text-green-700 bg-green-100 px-2 sm:px-3 py-1 rounded-full border border-green-300">
                      {tasks.filter(t => t.active !== false).length} active
                    </span>
                    {tasks.filter(t => t.active === false).length > 0 && (
                      <span className="text-xs sm:text-sm text-red-700 bg-red-100 px-2 sm:px-3 py-1 rounded-full border border-red-300">
                        {tasks.filter(t => t.active === false).length} inactive
                      </span>
                    )}
                  </div>
                </div>
                {tasks.length > 0 ? (
                  <div className="space-y-3">
                    {tasks.map((task) => (
                      <div key={task.id} className={`bg-white border rounded-lg p-3 sm:p-4 shadow-sm hover:shadow-md transition-shadow ${
                        task.active === false 
                          ? "border-red-300 bg-red-50 opacity-75" 
                          : "border-gray-300"
                      }`}>
                        {editingTask === task.id ? (
                          // Edit Mode
                          <div className="space-y-4">
                            <input
                              type="text"
                              value={editedTaskData.name !== undefined ? editedTaskData.name : task.name || ''}
                              onChange={(e) => setEditedTaskData({ ...editedTaskData, name: e.target.value })}
                              className="w-full bg-white border border-gray-300 rounded-lg px-3 sm:px-4 py-3 text-gray-800 focus:border-orange-500 focus:outline-none text-sm sm:text-base"
                              placeholder="Task Name"
                            />

                            <textarea
                              value={editedTaskData.notes !== undefined ? editedTaskData.notes : task.notes || ''}
                              onChange={(e) => setEditedTaskData({ ...editedTaskData, notes: e.target.value })}
                              className="w-full bg-white border border-gray-300 rounded-lg px-3 sm:px-4 py-3 text-gray-800 focus:border-orange-500 focus:outline-none h-20 resize-none text-sm sm:text-base"
                              placeholder="Notes"
                            />

                            {/* Emoji Selection */}
                            <div>
                              <button
                                type="button"
                                onClick={() => openEmojiPicker('editTask')}
                                className="w-full bg-white border border-gray-300 rounded-lg px-3 sm:px-4 py-3 text-gray-800 focus:border-orange-500 focus:outline-none flex items-center justify-between text-sm sm:text-base min-h-[48px]"
                              >
                                <div className="flex items-center">
                                  {(editedTaskData.emoji !== undefined ? editedTaskData.emoji : task.emoji) && (
                                    <span className="text-2xl mr-2">
                                      {editedTaskData.emoji !== undefined ? editedTaskData.emoji : task.emoji}
                                    </span>
                                  )}
                                  <span className={(editedTaskData.emoji !== undefined ? editedTaskData.emoji : task.emoji) ? "text-gray-800" : "text-gray-500"}>
                                    {(editedTaskData.emoji !== undefined ? editedTaskData.emoji : task.emoji) ? "Change Emoji" : "Choose Emoji"}
                                  </span>
                                </div>
                                <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                              </button>
                            </div>

                            {/* Points */}
                            <div>
                              <label className="block text-gray-600 text-sm font-medium mb-3">STARS PER COMPLETION</label>
                              <div className="flex items-center justify-center space-x-3 sm:space-x-4">
                                <button
                                  onClick={() => setEditedTaskData({ 
                                    ...editedTaskData, 
                                    points: Math.max(0, (editedTaskData.points !== undefined ? editedTaskData.points : task.points) - 1) 
                                  })}
                                  className="w-12 h-12 sm:w-14 sm:h-14 bg-gray-200 rounded-lg flex items-center justify-center text-gray-800 text-xl sm:text-2xl min-h-[48px]"
                                  type="button"
                                >
                                  âˆ’
                                </button>
                                <input
                                  type="number"
                                  min="0"
                                  value={editedTaskData.points !== undefined ? editedTaskData.points : task.points}
                                  onChange={e => setEditedTaskData({ ...editedTaskData, points: Math.max(0, Number(e.target.value)) })}
                                  className="w-24 text-center bg-gray-100 rounded-lg px-2 py-3 text-xl sm:text-2xl font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-400"
                                />
                                  <span className="text-xl sm:text-2xl">â­</span>
                                <button
                                  onClick={() => setEditedTaskData({ 
                                    ...editedTaskData, 
                                    points: (editedTaskData.points !== undefined ? editedTaskData.points : task.points) + 1 
                                  })}
                                  className="w-12 h-12 sm:w-14 sm:h-14 bg-green-600 rounded-lg flex items-center justify-center text-white text-xl sm:text-2xl min-h-[48px]"
                                  type="button"
                                >
                                  +
                                </button>
                              </div>
                            </div>

                            {/* Frequency */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                              <span className="text-gray-800 font-medium text-sm sm:text-base">Repeat</span>
                              <div className="flex items-center">
                                <select
                                  value={editedTaskData.frequency || task.frequency}
                                  onChange={(e) => {
                                    const freq = e.target.value;
                                    setEditedTaskData({ 
                                      ...editedTaskData, 
                                      frequency: freq,
                                      daysOfWeek: freq === "Daily" ? 
                                        ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] : 
                                        freq === "Once" ? [] :
                                        (editedTaskData.daysOfWeek || task.daysOfWeek || ["Monday"])
                                    });
                                  }}
                                  className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-600 pr-8 appearance-none text-sm sm:text-base min-h-[40px]"
                                >
                                  <option value="Daily" className="bg-white">Every Day</option>
                                  <option value="Specific" className="bg-white">Specific Days</option>
                                  <option value="Once" className="bg-white">Once</option>
                                </select>
                                <svg className="w-4 h-4 text-gray-600 -ml-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                              </div>
                            </div>

                            {/* Specific Days Selection */}
                            {(editedTaskData.frequency || task.frequency) === "Specific" && (
                              <div>
                                <label className="block text-gray-600 text-sm font-medium mb-3">SELECT DAYS</label>
                                <div className="grid grid-cols-7 gap-1 sm:gap-2">
                                  {["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map((day, index) => {
                                    const fullDay = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"][index];
                                    const currentDaysOfWeek = editedTaskData.daysOfWeek || task.daysOfWeek || [];
                                    return (
                                      <button
                                        key={day}
                                        type="button"
                                        onClick={() => {
                                          if (currentDaysOfWeek.includes(fullDay)) {
                                            setEditedTaskData({ 
                                              ...editedTaskData, 
                                              daysOfWeek: currentDaysOfWeek.filter(d => d !== fullDay)
                                            });
                                          } else {
                                            setEditedTaskData({ 
                                              ...editedTaskData, 
                                              daysOfWeek: [...currentDaysOfWeek, fullDay]
                                            });
                                          }
                                        }}
                                        className={`py-2 px-1 sm:px-2 rounded-lg text-xs sm:text-sm font-medium min-h-[40px] ${
                                          currentDaysOfWeek.includes(fullDay)
                                            ? "bg-orange-500 text-white"
                                            : "bg-gray-200 text-gray-700"
                                        }`}
                                      >
                                        {day}
                                      </button>
                                    );
                                  })}
                                </div>
                              </div>
                            )}

                            {/* Time of Day */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                              <span className="text-gray-800 font-medium text-sm sm:text-base">Time of Day</span>
                              <div className="flex items-center">
                                <select
                                  value={editedTaskData.timeOfDay || task.timeOfDay || "Anytime"}
                                  onChange={(e) => setEditedTaskData({ ...editedTaskData, timeOfDay: e.target.value })}
                                  className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-600 pr-8 appearance-none text-sm sm:text-base min-h-[40px]"
                                >
                                  <option value="Anytime" className="bg-white">Anytime</option>
                                  <option value="Morning" className="bg-white">Morning</option>
                                  <option value="Afternoon" className="bg-white">Afternoon</option>
                                  <option value="Evening" className="bg-white">Evening</option>
                                </select>
                                <svg className="w-4 h-4 text-gray-600 -ml-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                              </div>
                            </div>

                            {/* Assignee */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                              <span className="text-gray-800 font-medium text-sm sm:text-base">Assigned To</span>
                              <div className="flex items-center">
                                <select
                                  value={editedTaskData.assignee || task.assignee}
                                  onChange={(e) => setEditedTaskData({ ...editedTaskData, assignee: e.target.value })}
                                  className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-600 pr-8 appearance-none text-sm sm:text-base min-h-[40px]"
                                >
                                  {users.map((u, index) => {
                                    const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                                    const userAvatar = u.avatar || avatarEmojis[index] || "ðŸ‘¤";
                                    return (
                                      <option key={u.name} value={u.name} className="bg-white">
                                        {userAvatar} {u.name}
                                      </option>
                                    );
                                  })}
                                </select>
                                <svg className="w-4 h-4 text-gray-600 -ml-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                              </div>
                            </div>

                            {/* Active/Inactive Toggle */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                              <span className="text-gray-800 font-medium text-sm sm:text-base">Task Status</span>
                              <div className="flex items-center">
                                <button
                                  onClick={() => setEditedTaskData({ 
                                    ...editedTaskData, 
                                    active: editedTaskData.active !== undefined ? !editedTaskData.active : !(task.active !== false) 
                                  })}
                                  className={`flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors min-h-[44px] ${
                                    (editedTaskData.active !== undefined ? editedTaskData.active : (task.active !== false))
                                      ? "bg-green-100 text-green-800 border border-green-300"
                                      : "bg-red-100 text-red-800 border border-red-300"
                                  }`}
                                >
                                  <span className="mr-2">
                                    {(editedTaskData.active !== undefined ? editedTaskData.active : (task.active !== false)) ? "âœ…" : "âŒ"}
                                  </span>
                                  {(editedTaskData.active !== undefined ? editedTaskData.active : (task.active !== false)) ? "Active" : "Inactive"}
                                </button>
                              </div>
                            </div>

                            {/* Save/Cancel Buttons */}
                            <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
                              <button
                                onClick={() => updateTask(task.id, editedTaskData)}
                                className="flex-1 bg-green-500 text-white py-3 px-4 rounded-lg font-medium text-sm sm:text-base min-h-[48px]"
                              >
                                Save Changes
                              </button>
                              <button
                                onClick={() => {
                                  setEditingTask(null);
                                  setEditedTaskData({});
                                }}
                                className="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg font-medium text-sm sm:text-base min-h-[48px]"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        ) : (
                          // View Mode
                          <div>
                            <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-3 space-y-3 sm:space-y-0">
                              <div className="flex items-center flex-1 min-w-0">
                                <div className="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                  <span className="text-lg sm:text-xl">{getTaskEmoji(task.name, task.emoji)}</span>
                                </div>
                                <div className="flex-1 min-w-0">
                                  <h4 className="font-medium text-gray-800 text-sm sm:text-base truncate">{task.name}</h4>
                                  <div className="flex flex-wrap gap-1 sm:gap-2 mt-1">
                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${getPersonColor(task.assignee)}`}>
                                      {task.assignee}
                                    </span>
                                    <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full whitespace-nowrap">
                                      â­ {task.points} pts
                                    </span>
                                    <span className={`text-xs px-2 py-1 rounded-full font-medium whitespace-nowrap ${
                                      task.active === false 
                                        ? "bg-red-100 text-red-800" 
                                        : "bg-green-100 text-green-800"
                                    }`}>
                                      {task.active === false ? "Inactive" : "Active"}
                                    </span>
                                  </div>
                                </div>
                              </div>
                              <div className="flex space-x-2 flex-shrink-0">
                                <button
                                  onClick={() => {
                                    setEditingTask(task.id);
                                    setEditedTaskData({});
                                  }}
                                  className="bg-blue-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px] flex items-center justify-center"
                                >
                                  Edit
                                </button>
                                <button
                                  onClick={() => duplicateTask(task)}
                                  className="bg-green-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px] flex items-center justify-center"
                                >
                                  Duplicate
                                </button>
                                <button
                                  onClick={() => deleteTask(task.id)}
                                  className="bg-red-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px] flex items-center justify-center"
                                >
                                  Delete
                                </button>
                              </div>
                            </div>

                            <div className="text-xs sm:text-sm text-gray-600 mb-2 bg-gray-50 p-2 rounded-lg">
                              <div className="font-medium text-gray-700 mb-1">Schedule</div>
                              <div>
                                {task.frequency === "Once" ? "Once" :
                                 task.frequency === "Daily" ? "Every day" : 
                                 `${task.daysOfWeek?.join(", ") || "Specific days"}`}
                                {task.timeOfDay && task.timeOfDay !== "Anytime" && (
                                  <span className="ml-2">â€¢ {task.timeOfDay}</span>
                                )}
                              </div>
                            </div>

                            {task.notes && (
                              <div className="text-xs sm:text-sm text-gray-600 bg-blue-50 p-2 rounded-lg">
                                <div className="font-medium text-gray-700 mb-1">Notes</div>
                                <div className="break-words">{task.notes}</div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <div className="text-4xl mb-3">ðŸ“</div>
                    <p className="text-lg font-medium mb-1">No tasks yet</p>
                    <p className="text-sm">Create your first task using the form above</p>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Family Members View */}
          {currentPage === PAGES.FAMILY_MEMBERS && <FamilyMembersPage />}

          {/* Settings View */}
          {currentPage === PAGES.SETTINGS && <SettingsPage />}

          {/*
          // {showPostPaymentButton && (
          //   <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[9999]" data-post-payment="true">
          //     <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 flex flex-col items-center">
          //       <h2 className="text-xl font-bold mb-4">Finish Account Setup</h2>
          //       <p className="mb-4 text-gray-700">Click the button below to complete your account creation.</p>
          //       <button
          //         className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold text-lg transition-colors"
          //         onClick={async () => {
          //           setShowPostPaymentButton(false);
          //           await handlePostPaymentSignup();
          //         }}
          //       >
          //         Finish Account Setup
          //       </button>
          //     </div>
          //   </div>
          // )}
          */}

          {showPostPaymentButton && (
            <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999] p-4" data-post-payment="true">
              <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 flex flex-col items-center">
                {/* Success Icon */}
                <div className="text-6xl mb-4 animate-bounce">ðŸŽ‰</div>
                
                {/* Title */}
                <h2 className="text-2xl font-bold mb-4 text-center text-gray-900">
                  Payment Successful!
                </h2>
                
                {/* Description */}
                <div className="text-center mb-6">
                  <p className="text-gray-700 mb-2">
                    Your subscription is active! Now let's finish setting up your account.
                  </p>
                  <p className="text-sm text-gray-600">
                    {(() => {
                      const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
                      if (pendingGoogleSignup) {
                        const signupData = JSON.parse(pendingGoogleSignup);
                        return `Please sign in with your Google account: ${signupData.email}`;
                      }
                      return "Complete your account setup to start using Farm Fam.";
                    })()}
                  </p>
                </div>

                {/* Action Button */}
                <button
                  className="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white px-6 py-4 rounded-xl font-semibold text-lg transition-all duration-200 transform hover:scale-105 shadow-lg mb-4"
                  onClick={async () => {
                    await handlePostPaymentSignup();
                  }}
                >
                  {(() => {
                    const pendingGoogleSignup = localStorage.getItem("pendingGoogleSignup");
                    return pendingGoogleSignup ? "Sign in with Google" : "Complete Setup";
                  })()}
                </button>

                {/* Help Text */}
                <div className="text-center">
                  <p className="text-xs text-gray-500 mb-2">
                    Having trouble? Make sure you're using the same account you signed up with.
                  </p>
                  <button
                    onClick={() => {
                      if (confirm("Are you sure you want to cancel? You can always complete setup later from the login page.")) {
                        setShowPostPaymentButton(false);
                        // Don't clear the pending signup data in case they want to try again
                      }
                    }}
                    className="text-sm text-gray-400 hover:text-gray-600 underline"
                  >
                    Skip for now
                </button>
                </div>
              </div>
            </div>
          )}

        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
