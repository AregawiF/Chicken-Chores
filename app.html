<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chicken Chores</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel CDN for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js CDN for Insights -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js"; 

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBDaxMSn6CGiSfYho92FFZieTjLND8I4BM",
      authDomain: "chicken-chores.firebaseapp.com",
      projectId: "chicken-chores",
      storageBucket: "chicken-chores.appspot.com",
      messagingSenderId: "804974041900",
      appId: "1:804974041900:web:b37a3d768f1771f35aea89"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // Initialize Firebase Authentication and get a reference to the service
    const auth = getAuth(app); 
    const googleProvider = new GoogleAuthProvider();

    // *** FIX: Attach Firebase services to the global window object ***
    window.firebaseAuth = {
      auth,
      googleProvider,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    };

  </script>
</head>
<body class="bg-green-50 min-h-screen">
  <div id="root" class="container mx-auto p-2 sm:p-4"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // App pages/routes
    const PAGES = {
      ONBOARDING: 'onboarding',
      LOGIN: 'login',
      TASKS: 'tasks',
      LEADERBOARD: 'leaderboard',
      PROFILE: 'profile',
      TASK_EDITOR: 'task-editor',
      BADGE_EDITOR: 'badge-editor',
      SETTINGS: 'settings',
      FAMILY_MEMBERS: 'family-members'
    };

    // Onboarding steps
    const ONBOARDING_STEPS = [
      {
        id: 'welcome',
        title: 'Welcome to Chicken Chores! ðŸ”',
        content: 'Transform your family\'s chicken care routine into a fun, rewarding experience!',
        icon: 'ðŸ '
      },
      {
        id: 'tasks',
        title: 'Assign Tasks ðŸ“‹',
        content: 'Get kids excited about caring for their chickens.',
        icon: 'ðŸ”'
      },
      {
        id: 'rewards',
        title: 'Earn Rewards â­',
        content: 'Complete tasks to earn points, compete on the leaderboard, and unlock special badges like "Egg Expert" and "Feed Master".',
        icon: 'ðŸ†'
      },
      {
        id: 'auth',
        title: 'You\'re All Set! ðŸŽ‰',
        content: 'Create an account to save your progress, or skip to start using Chicken Chores right away!',
        icon: 'ðŸš€'
      }
    ];

    // Initial data for tasks and users
    const initialTasks = [
      { id: 1, name: "Feed Chickens", frequency: "Daily", assignee: "Kid 1", points: 10, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Fill feeders with chicken feed", emoji: "ðŸŒ¾", active: true },
      { id: 2, name: "Collect Eggs", frequency: "Daily", assignee: "Kid 2", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Gather fresh eggs from nesting boxes", emoji: "ðŸ¥š", active: true },
      { id: 3, name: "Clean Coop", frequency: "Custom", assignee: "Dad", points: 10, daysOfWeek: ["Saturday"], notes: "Deep clean chicken coop and replace bedding", emoji: "ðŸ§¹", active: true },
      { id: 4, name: "Refill Water", frequency: "Daily", assignee: "Kid 2", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Check and refill water containers", emoji: "ðŸ’§", active: true },
      { id: 5, name: "Clean Water Bowl", frequency: "Custom", assignee: "Mom", points: 5, daysOfWeek: ["Sunday"], notes: "Scrub and sanitize water containers", emoji: "ðŸ§½", active: true },
      { id: 6, name: "Check Feed Storage", frequency: "Custom", assignee: "Dad", points: 5, daysOfWeek: ["Friday"], notes: "Verify feed levels and quality", emoji: "ðŸ“¦", active: true },
      { id: 7, name: "Supervised Free Range", frequency: "Daily", assignee: "Kid 1", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Let chickens roam in yard with supervision", emoji: "ðŸ“", active: true },
      { id: 8, name: "Check for Illness", frequency: "Daily", assignee: "Mom", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Observe chickens for signs of illness", emoji: "ðŸ”", active: true },
      { id: 9, name: "Secure Coop at Night", frequency: "Daily", assignee: "Dad", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Close and lock coop doors for safety", emoji: "ðŸ”’", active: true },
      { id: 10, name: "Replace Bedding", frequency: "Custom", assignee: "Mom", points: 5, daysOfWeek: ["Wednesday"], notes: "Add fresh bedding material to coop", emoji: "ðŸ›ï¸", active: true },
      { id: 11, name: "Feed Dogs", frequency: "Daily", assignee: "Kid 2", points: 5, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "Fill dog food bowls", emoji: "ðŸ•", active: true }
    ];

    const initialUsers = [
      { name: "Mom", points: 0, badges: [], avatar: "ðŸ‘©", color: "blue" },
      { name: "Dad", points: 0, badges: [], avatar: "ðŸ‘¨", color: "purple" },
      { name: "Kid 1", points: 0, badges: [], avatar: "ðŸ§‘", color: "orange" },
      { name: "Kid 2", points: 0, badges: [], avatar: "ðŸ‘¦", color: "pink" },
    ];

    const presetTasks = [
        { name: "Feed Chickens", points: 10, frequency: "Daily", notes: "Fill feeders with chicken feed", emoji: "ðŸŒ¾", active: true, assignee: "Kid 1" },
        { name: "Collect Eggs", points: 5, frequency: "Daily", notes: "Gather fresh eggs from nesting boxes", emoji: "ðŸ¥š", active: true, assignee: "Kid 2" },
        { name: "Clean Coop", points: 10, frequency: "Custom", daysOfWeek: ["Saturday"], notes: "Deep clean chicken coop and replace bedding", emoji: "ðŸ§¹", active: true, assignee: "Dad" },
        { name: "Refill Water", points: 5, frequency: "Daily", notes: "Check and refill water containers", emoji: "ðŸ’§", active: true, assignee: "Kid 2" },
        { name: "Clean Water Bowl", points: 5, frequency: "Custom", daysOfWeek: ["Sunday"], notes: "Scrub and sanitize water containers", emoji: "ðŸ§½", active: true, assignee: "Mom" },
        { name: "Check Feed Storage", points: 5, frequency: "Custom", daysOfWeek: ["Friday"], notes: "Verify feed levels and quality", emoji: "ðŸ“¦", active: true, assignee: "Dad" },
        { name: "Supervised Free Range", points: 5, frequency: "Daily", notes: "Let chickens roam in yard with supervision", emoji: "ðŸ“", active: true, assignee: "Kid 1" },
        { name: "Check for Illness", points: 5, frequency: "Daily", notes: "Observe chickens for signs of illness", emoji: "ðŸ”", active: true, assignee: "Mom" },
        { name: "Secure Coop at Night", points: 5, frequency: "Daily", notes: "Close and lock coop doors for safety", emoji: "ðŸ”’", active: true, assignee: "Dad" },
        { name: "Replace Bedding", points: 5, frequency: "Custom", daysOfWeek: ["Wednesday"], notes: "Add fresh bedding material to coop", emoji: "ðŸ›ï¸", active: true, assignee: "Mom" },
        { name: "Feed Dogs", points: 5, frequency: "Daily", notes: "Fill dog food bowls", emoji: "ðŸ•", active: true, assignee: "Kid 2" }
      ];

    // Comprehensive categorized emoji system
    const emojiCategories = {
      "Smileys & People": [
        "ðŸ˜Š", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ™‚", "ðŸ˜‰", "ðŸ˜", "ðŸ¤—", "ðŸ˜Ž", "ðŸ¤”", "ðŸ˜´", "ðŸ˜‹", "ðŸ˜œ", "ðŸ¤©", "ðŸ¥³",
        "ðŸ‘", "ðŸ‘", "ðŸ’ª", "ðŸ™Œ", "ðŸ‘‹", "âœ‹", "ðŸ‘Œ", "âœŒï¸", "ðŸ¤ž", "ðŸ¤Ÿ", "ðŸ¤", "ðŸ‘Š", "âœŠ", "ðŸ™",
        "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦", "ðŸ‘ª", "ðŸ‘¶", "ðŸ‘§", "ðŸ‘¦", "ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘´", "ðŸ‘µ", "ðŸ™‹â€â™€ï¸", "ðŸ™‹â€â™‚ï¸", "ðŸ’â€â™€ï¸", "ðŸ’â€â™‚ï¸"
      ],
      "Animals & Nature": [
        "ðŸ”", "ðŸ“", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¶", "ðŸ•", "ðŸ±", "ðŸˆ", "ðŸ­", "ðŸ¹", "ðŸ°", "ðŸ‡", "ðŸ¦Š", "ðŸº", "ðŸ·", "ðŸ½",
        "ðŸ®", "ðŸ„", "ðŸ´", "ðŸŽ", "ðŸ¦„", "ðŸ¸", "ðŸ¢", "ðŸ", "ðŸ¦Ž", "ðŸ™", "ðŸ¦‘", "ðŸ ", "ðŸŸ", "ðŸ¡", "ðŸ¦ˆ", "ðŸ³", "ðŸ‹",
        "ðŸ¦‹", "ðŸ›", "ðŸ", "ðŸž", "ðŸ•·ï¸", "ðŸ¦—", "ðŸœ", "ðŸª²", "ðŸ¦Ÿ", "ðŸª°", "ðŸª±", "ðŸ¦ ",
        "ðŸŒ³", "ðŸŒ²", "ðŸŒ´", "ðŸŒµ", "ðŸŒ¿", "ðŸŒ±", "ðŸŒ¾", "ðŸŒ¸", "ðŸŒº", "ðŸŒ»", "ðŸŒ¹", "ðŸŒ·", "ðŸŒ¼", "ðŸŒµ", "ðŸƒ", "ðŸ‚", "ðŸ",
        "ðŸŒ¤ï¸", "â˜€ï¸", "ðŸŒž", "ðŸŒ", "ðŸŒ›", "ðŸŒœ", "ðŸŒš", "ðŸŒ•", "ðŸŒ–", "ðŸŒ—", "ðŸŒ˜", "ðŸŒ‘", "â­", "ðŸŒŸ", "ðŸ’«", "âœ¨", "â˜„ï¸",
        "ðŸŒˆ", "â˜”", "â›ˆï¸", "ðŸŒ©ï¸", "â„ï¸", "â˜ƒï¸", "â›„", "ðŸŒŠ", "ðŸ’§", "ðŸ’¦"
      ],
      "Food & Drink": [
        "ðŸ¥š", "ðŸ³", "ðŸ§ˆ", "ðŸ¥“", "ðŸ¥ž", "ðŸ§‡", "ðŸž", "ðŸ¥–", "ðŸ¥¨", "ðŸ§€", "ðŸ¥—", "ðŸ¥™", "ðŸ¥ª", "ðŸŒ®", "ðŸŒ¯", "ðŸ•", "ðŸ”", "ðŸŸ",
        "ðŸŒ­", "ðŸ¥©", "ðŸ—", "ðŸ–", "ðŸ¦´", "ðŸŒ¶ï¸", "ðŸ¥•", "ðŸŒ½", "ðŸ¥¬", "ðŸ¥’", "ðŸ§„", "ðŸ§…", "ðŸ„", "ðŸ¥”", "ðŸ ", "ðŸ«", "ðŸ‡",
        "ðŸˆ", "ðŸ‰", "ðŸŠ", "ðŸ‹", "ðŸŒ", "ðŸ", "ðŸ¥­", "ðŸ‘", "ðŸ’", "ðŸ“", "ðŸ«–", "â˜•", "ðŸµ", "ðŸ§ƒ", "ðŸ¥¤", "ðŸ§‹", "ðŸ¶", "ðŸ¾",
        "ðŸ·", "ðŸ¸", "ðŸ¹", "ðŸº", "ðŸ»", "ðŸ¥‚", "ðŸ¥ƒ", "ðŸ§Š", "ðŸ¥›", "ðŸ¼", "ðŸ¯", "ðŸ§‚", "ðŸ’§"
      ],
      "Activities & Sports": [
        "âš½", "ðŸ€", "ðŸˆ", "âš¾", "ðŸ¥Ž", "ðŸŽ¾", "ðŸ", "ðŸ‰", "ðŸ¥", "ðŸŽ±", "ðŸª€", "ðŸ“", "ðŸ¸", "ðŸ’", "ðŸ‘", "ðŸ¥", "ðŸ",
        "ðŸªƒ", "ðŸ¥…", "â›³", "ðŸª", "ðŸ¹", "ðŸŽ£", "ðŸ¤¿", "ðŸ¥Š", "ðŸ¥‹", "ðŸŽ½", "ðŸ›¹", "ðŸ›¼", "ðŸ›´", "â›·ï¸", "ðŸ‚", "ðŸª‚", "ðŸ‹ï¸â€â™€ï¸",
        "ðŸ‹ï¸â€â™‚ï¸", "ðŸ¤¼â€â™€ï¸", "ðŸ¤¼â€â™‚ï¸", "ðŸ¤¸â€â™€ï¸", "ðŸ¤¸â€â™‚ï¸", "â›¹ï¸â€â™€ï¸", "â›¹ï¸â€â™‚ï¸", "ðŸ¤º", "ðŸ¤¾â€â™€ï¸", "ðŸ¤¾â€â™‚ï¸", "ðŸŒï¸â€â™€ï¸", "ðŸŒï¸â€â™‚ï¸",
        "ðŸ‡", "ðŸ§˜â€â™€ï¸", "ðŸ§˜â€â™‚ï¸", "ðŸ„â€â™€ï¸", "ðŸ„â€â™‚ï¸", "ðŸŠâ€â™€ï¸", "ðŸŠâ€â™‚ï¸", "ðŸ¤½â€â™€ï¸", "ðŸ¤½â€â™‚ï¸", "ðŸš£â€â™€ï¸", "ðŸš£â€â™‚ï¸", "ðŸ§—â€â™€ï¸", "ðŸ§—â€â™‚ï¸",
        "ðŸšµâ€â™€ï¸", "ðŸšµâ€â™‚ï¸", "ðŸš´â€â™€ï¸", "ðŸš´â€â™‚ï¸", "ðŸŽ¯", "ðŸŽª", "ðŸŽ¨", "ðŸŽ¬", "ðŸŽ¤", "ðŸŽ§", "ðŸŽ¼", "ðŸŽµ", "ðŸŽ¶", "ðŸŽ¹", "ðŸ¥", "ðŸª˜",
        "ðŸŽ·", "ðŸŽº", "ðŸª—", "ðŸŽ¸", "ðŸª•", "ðŸŽ»", "ðŸŽ²", "â™ ï¸", "â™¥ï¸", "â™¦ï¸", "â™£ï¸", "â™Ÿï¸", "ðŸƒ", "ðŸ€„", "ðŸŽ´", "ðŸŽ­", "ðŸ–¼ï¸", "ðŸŽ¨"
      ],
      "Travel & Places": [
        "ðŸ ", "ðŸ¡", "ðŸ˜ï¸", "ðŸšï¸", "ðŸ—ï¸", "ðŸ­", "ðŸ¢", "ðŸ¬", "ðŸ£", "ðŸ¤", "ðŸ¥", "ðŸ¦", "ðŸ¨", "ðŸª", "ðŸ«", "ðŸ©", "ðŸ’’",
        "ðŸ›ï¸", "â›ª", "ðŸ•Œ", "ðŸ•", "ðŸ›•", "ðŸ•‹", "â›©ï¸", "ðŸ›¤ï¸", "ðŸ›£ï¸", "ðŸ—¾", "ðŸžï¸", "ðŸŸï¸", "ðŸ›ï¸", "ðŸ—ï¸", "ðŸ§±", "ðŸª¨", "ðŸªµ",
        "ðŸ›–", "ðŸ˜ï¸", "ðŸ™ï¸", "ðŸŒ†", "ðŸŒ‡", "ðŸŒƒ", "ðŸ—¼", "ðŸ—ï¸", "ðŸŽ¡", "ðŸŽ¢", "ðŸŽ ", "â›±ï¸", "ðŸ–ï¸", "ðŸœï¸", "ðŸï¸", "ðŸžï¸",
        "ðŸš—", "ðŸš•", "ðŸš™", "ðŸšŒ", "ðŸšŽ", "ðŸŽï¸", "ðŸš“", "ðŸš‘", "ðŸš’", "ðŸš", "ðŸ›»", "ðŸšš", "ðŸš›", "ðŸšœ", "ðŸï¸", "ðŸ›µ", "ðŸš²",
        "ðŸ›´", "ðŸ›¹", "ðŸ›¼", "ðŸš", "ðŸ›¸", "âœˆï¸", "ðŸ›©ï¸", "ðŸ›«", "ðŸ›¬", "ðŸª‚", "ðŸ’º", "ðŸš€", "ðŸ›°ï¸", "ðŸš‰", "ðŸšž", "ðŸš", "ðŸš„",
        "ðŸš…", "ðŸšˆ", "ðŸš‚", "ðŸš†", "ðŸš‡", "ðŸšŠ", "ðŸšŸ", "ðŸš ", "ðŸš¡", "ðŸ›³ï¸", "â›µ", "ðŸš¤", "ðŸ›¥ï¸", "ðŸ›¶", "â›´ï¸", "ðŸš¢", "âš“",
        "ðŸª", "â›½", "ðŸš§", "ðŸš¦", "ðŸš¥", "ðŸ—ºï¸", "ðŸ›ï¸", "ðŸ›‹ï¸", "ðŸª‘", "ðŸšª", "ðŸªŸ", "ðŸ›", "ðŸ›€"
      ],
      "Objects & Tools": [
        "ðŸ§¹", "ðŸ§½", "ðŸª£", "ðŸ§´", "ðŸ§¼", "ðŸª’", "ðŸ§³", "âŒš", "ðŸ“±", "ðŸ“²", "ðŸ’»", "âŒ¨ï¸", "ðŸ–¥ï¸", "ðŸ–¨ï¸", "ðŸ–±ï¸", "ðŸ–²ï¸", "ðŸ•¹ï¸",
        "ðŸ—œï¸", "ðŸ’¾", "ðŸ’¿", "ðŸ“€", "ðŸ“¼", "ðŸ“·", "ðŸ“¸", "ðŸ“¹", "ðŸŽ¥", "ðŸ“½ï¸", "ðŸŽžï¸", "ðŸ“ž", "â˜Žï¸", "ðŸ“Ÿ", "ðŸ“ ", "ðŸ“º", "ðŸ“»",
        "ðŸŽ™ï¸", "ðŸŽšï¸", "ðŸŽ›ï¸", "ðŸ§­", "â±ï¸", "â²ï¸", "â°", "ðŸ•°ï¸", "âŒ›", "â³", "ðŸ“¡", "ðŸ”‹", "ðŸª«", "ðŸ”Œ", "ðŸ’¡", "ðŸ”¦", "ðŸ•¯ï¸",
        "ðŸª”", "ðŸ§¯", "ðŸ›¢ï¸", "ðŸ’¸", "ðŸ’µ", "ðŸ’´", "ðŸ’¶", "ðŸ’·", "ðŸª™", "ðŸ’°", "ðŸ’³", "ðŸ’Ž", "âš–ï¸", "ðŸªœ", "ðŸ§°", "ðŸª›", "ðŸ”§",
        "ðŸ”¨", "âš’ï¸", "ðŸ› ï¸", "â›ï¸", "ðŸªš", "ðŸ”©", "âš™ï¸", "ðŸª¤", "ðŸ§²", "ðŸ”«", "ðŸ’£", "ðŸ§¨", "ðŸª“", "ðŸ”ª", "ðŸ—¡ï¸", "âš”ï¸", "ðŸ›¡ï¸",
        "ðŸš¬", "âš°ï¸", "ðŸª¦", "âš±ï¸", "ðŸº", "ðŸ”®", "ðŸ“¿", "ðŸ§¿", "ðŸª¬", "ðŸ’ˆ", "âš—ï¸", "ðŸ”­", "ðŸ”¬", "ðŸ•³ï¸", "ðŸ©¹", "ðŸ©º", "ðŸ’Š",
        "ðŸ’‰", "ðŸ§¬", "ðŸ¦ ", "ðŸ§«", "ðŸ§ª", "ðŸŒ¡ï¸", "ðŸ§¹", "ðŸ§º", "ðŸ§»", "ðŸª£", "ðŸ§´", "ðŸ§¼", "ðŸª¥", "ðŸª’", "ðŸ§½", "ðŸª£", "ðŸ§°",
        "ðŸ“¦", "ðŸ“‹", "ðŸ“Œ", "ðŸ“", "ðŸ“Ž", "ðŸ–‡ï¸", "ðŸ“", "ðŸ“", "âœ‚ï¸", "ðŸ—ƒï¸", "ðŸ—„ï¸", "ðŸ—‘ï¸", "ðŸ”’", "ðŸ”“", "ðŸ”", "ðŸ”", "ðŸ”‘",
        "ðŸ—ï¸", "ðŸ”¨", "ðŸª“", "â›ï¸", "âš’ï¸", "ðŸ› ï¸", "ðŸ—¡ï¸", "ðŸ”«", "ðŸªƒ", "ðŸ¹", "ðŸ›¡ï¸", "ðŸªš", "ðŸ”§", "ðŸª›", "ðŸ”©", "âš™ï¸", "ðŸ—œï¸",
        "âš–ï¸", "ðŸ¦¯", "ðŸ”—", "â›“ï¸", "ðŸª", "ðŸ§°", "ðŸ§²", "ðŸªœ", "ðŸŽ¯", "ðŸ†", "ðŸ…", "ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰", "ðŸŽ–ï¸", "ðŸŽ—ï¸", "ðŸŽ«",
        "ðŸŽŸï¸", "ðŸŽª", "ðŸŽ­", "ðŸŽ¨", "ðŸŽ¬", "ðŸŽ¤", "ðŸŽ§", "ðŸŽ¼", "ðŸŽµ", "ðŸŽ¶", "ðŸŽ¹", "ðŸ¥", "ðŸª˜", "ðŸŽ·", "ðŸŽº", "ðŸª—", "ðŸŽ¸",
        "ðŸª•", "ðŸŽ»", "ðŸŽ²", "â™ ï¸", "â™¥ï¸", "â™¦ï¸", "â™£ï¸", "â™Ÿï¸", "ðŸƒ", "ðŸ€„", "ðŸŽ´", "ðŸŽ‰", "ðŸŽŠ", "ðŸŽˆ", "ðŸŽ", "ðŸŽ€", "ðŸª…",
        "ðŸª†", "ðŸ””", "ðŸ”•", "ðŸ“¯", "ðŸ“¢", "ðŸ“£", "ðŸ“»", "ðŸ”Š", "ðŸ”‰", "ðŸ”ˆ", "ðŸ”‡", "ðŸ”•", "ðŸ“¯", "ðŸ“¢", "ðŸ“£", "ðŸ“ª", "ðŸ“«",
        "ðŸ“¬", "ðŸ“­", "ðŸ“®", "ðŸ—³ï¸", "âœï¸", "âœ’ï¸", "ðŸ–‹ï¸", "ðŸ–Šï¸", "ðŸ–Œï¸", "ðŸ–ï¸", "ðŸ“", "ðŸ’¼", "ðŸ“", "ðŸ“‚", "ðŸ—‚ï¸", "ðŸ“…", "ðŸ“†",
        "ðŸ—’ï¸", "ðŸ—“ï¸", "ðŸ“‡", "ðŸ“ˆ", "ðŸ“‰", "ðŸ“Š", "ðŸ“‹", "ðŸ“Œ", "ðŸ“", "ðŸ“Ž", "ðŸ–‡ï¸", "ðŸ“", "ðŸ“", "âœ‚ï¸", "ðŸ—ƒï¸", "ðŸ—„ï¸", "ðŸ—‘ï¸"
      ]
    };

    // Simple flat array for backwards compatibility
    const taskEmojis = Object.values(emojiCategories).flat();

    // Main App Component
    const App = () => {
      const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem("tasks")) || initialTasks);
      const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem("users")) || initialUsers);
      const [newTask, setNewTask] = useState({ name: "", frequency: "Daily", assignee: "Mom", points: 0, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "", startDate: new Date().toISOString().split('T')[0], emoji: "", active: true });
      const [showPresets, setShowPresets] = useState(false);

      // Page routing and onboarding state
      const [currentPage, setCurrentPage] = useState(() => {
        const hasCompletedOnboarding = localStorage.getItem("hasCompletedOnboarding");
        return hasCompletedOnboarding ? PAGES.TASKS : PAGES.ONBOARDING;
      });
      const [onboardingStep, setOnboardingStep] = useState(0);

      // Authentication state
      const [isAuthenticated, setIsAuthenticated] = useState(false); // Let onAuthStateChanged handle the initial state
      // const [authMode, setAuthMode] = useState('signup'); // 'signup' or 'login'
      // const [authForm, setAuthForm] = useState({
      //   email: '',
      //   password: '',
      //   confirmPassword: '',
      //   familyName: ''
      // });
      const [showPageTransition, setShowPageTransition] = useState(false);

      // Legacy view state for backward compatibility
      const [view, setView] = useState("tasks");
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [customBadges, setCustomBadges] = useState(() => JSON.parse(localStorage.getItem("customBadges")) || {});
      const [editingBadge, setEditingBadge] = useState(null);
      const [newCustomBadge, setNewCustomBadge] = useState({ name: "", emoji: "ðŸ…", description: "", points: 0 });
      const [editingTask, setEditingTask] = useState(null);
      const [editedTaskData, setEditedTaskData] = useState({});
      const [lastResetDate, setLastResetDate] = useState(() => localStorage.getItem("lastResetDate") || new Date().toDateString());
      const [taskCompletions, setTaskCompletions] = useState(() => JSON.parse(localStorage.getItem("taskCompletions")) || {});
      const [lastWeeklyReset, setLastWeeklyReset] = useState(() => localStorage.getItem("lastWeeklyReset") || null);
      const [badgeNotifications, setBadgeNotifications] = useState({});
      const [showMenu, setShowMenu] = useState(false);
      const [selectedProfile, setSelectedProfile] = useState(null);
      const [editingProfile, setEditingProfile] = useState(null);

      // Emoji picker states
      const [showEmojiPicker, setShowEmojiPicker] = useState(false);
      const [emojiPickerTarget, setEmojiPickerTarget] = useState(null); // 'newTask', 'editTask', 'newBadge'
      const [selectedEmojiCategory, setSelectedEmojiCategory] = useState("Smileys & People");

      const getDateKey = (date) => date.toDateString();

      const isFutureDate = (date) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const inputDate = new Date(date);
        inputDate.setHours(0, 0, 0, 0);
        return inputDate > today;
      };

      const isNotToday = (date) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const inputDate = new Date(date);
        inputDate.setHours(0, 0, 0, 0);
        return inputDate.getTime() !== today.getTime();
      };

      // Close menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (showMenu && !event.target.closest('nav')) {
            setShowMenu(false);
          }
        };

        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showMenu]);

      useEffect(() => {
        const checkMidnightReset = () => {
          const now = new Date();
          const today = now.toDateString();
          const storedLastReset = localStorage.getItem("lastResetDate");

          if (storedLastReset && storedLastReset !== today) {
            // For guest users, reset everything at midnight
            if (!isAuthenticated) {
              // Clear all guest data
              localStorage.removeItem("tasks");
              localStorage.removeItem("users");
              localStorage.removeItem("customBadges");
              localStorage.removeItem("taskCompletions");
              localStorage.removeItem("lastWeeklyReset");
              
              // Reset to initial state
              setTasks(initialTasks);
              setUsers(initialUsers);
              setCustomBadges({});
              setTaskCompletions({});
              setLastWeeklyReset(null);
              
              console.log("Guest mode data reset at midnight");
            } else {
              // For authenticated users, only reset daily task completions
              const dateKey = getDateKey(new Date());
              setTaskCompletions(prev => ({ ...prev, [dateKey]: {} }));
            }
            
            setLastResetDate(today);
            localStorage.setItem("lastResetDate", today);
          }
        };

        checkMidnightReset();
        const now = new Date();
        const midnight = new Date();
        midnight.setHours(24, 0, 0, 0);
        const msUntilMidnight = midnight.getTime() - now.getTime();

        const midnightTimeout = setTimeout(() => {
          checkMidnightReset();
          const dailyInterval = setInterval(checkMidnightReset, 24 * 60 * 60 * 1000);
          return () => clearInterval(dailyInterval);
        }, msUntilMidnight);

        return () => clearTimeout(midnightTimeout);
      }, [tasks, isAuthenticated]);

      const getWeekStart = (date) => {
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(date.setDate(diff)).toDateString();
      };

      useEffect(() => {
        const checkWeeklyReset = () => {
          const now = new Date();
          const currentWeekStart = getWeekStart(now);
          const storedLastWeeklyReset = localStorage.getItem("lastWeeklyReset");

          if (!storedLastWeeklyReset || storedLastWeeklyReset !== currentWeekStart) {
            const resetUsers = users.map(user => ({ ...user, points: 0, badges: [] }));
            setUsers(resetUsers);
            setLastWeeklyReset(currentWeekStart);
            localStorage.setItem("lastWeeklyReset", currentWeekStart);
          }
        };

        checkWeeklyReset();
        const dailyInterval = setInterval(checkWeeklyReset, 24 * 60 * 60 * 1000);
        return () => clearInterval(dailyInterval);
      }, [users]);

      useEffect(() => {
        localStorage.setItem("tasks", JSON.stringify(tasks));
        localStorage.setItem("users", JSON.stringify(users));
        localStorage.setItem("customBadges", JSON.stringify(customBadges));
        localStorage.setItem("taskCompletions", JSON.stringify(taskCompletions));
      }, [tasks, users, customBadges, taskCompletions]);

      const addTask = (e) => {
        if (e) e.preventDefault();
        if (!newTask.name || newTask.daysOfWeek.length === 0) return;
        setTasks([...tasks, { id: Date.now(), ...newTask }]);
        setNewTask({ name: "", frequency: "Daily", assignee: "Mom", points: 0, daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], notes: "", startDate: new Date().toISOString().split('T')[0], emoji: "", active: true });
        setShowPresets(false);
        navigateToPage(PAGES.TASKS);
      };

      const selectPresetTask = (preset) => {
        setNewTask({
          ...newTask,
          name: preset.name,
          points: preset.points,
          frequency: preset.frequency,
          notes: preset.notes,
          emoji: preset.emoji,
          active: preset.active,
          daysOfWeek: preset.daysOfWeek || (preset.frequency === "Daily" ? ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] : ["Monday"])
        });
        setShowPresets(false);
      };

      const getTasksForDay = (dayOfWeek) => {
        return tasks.filter(task => {
          // Only include active tasks
          if (task.active === false) return false;

          if (!task.daysOfWeek) {
            return task.frequency === "Daily" || dayOfWeek === selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
          }
          return task.daysOfWeek.includes(dayOfWeek);
        });
      };

      const getCurrentDayName = () => selectedDate.toLocaleDateString('en-US', { weekday: 'long' });

      const deleteTask = (id) => setTasks(tasks.filter(task => task.id !== id));

      const updateTask = (taskId, updatedTask) => {
        setTasks(tasks.map(task => task.id === taskId ? { ...task, ...updatedTask } : task));
        setEditingTask(null);
        setEditedTaskData({});
      };

      const systemBadges = {
        "First Timer": { emoji: "ðŸ£", description: "Complete your first task", points: 0, isCustom: false },
        "Daily Hero": { emoji: "â­", description: "Complete 5 daily tasks", points: 0, isCustom: false },
        "Century Club": { emoji: "ðŸ’¯", description: "Earn 100 points", points: 100, isCustom: false },
        "Egg Expert": { emoji: "ðŸ¥š", description: "Complete 'Collect Eggs' 5 times", points: 0, isCustom: false },
        "Feed Master": { emoji: "ðŸŒ¾", description: "Complete 'Feed Chickens' 7 times", points: 0, isCustom: false },
        "Clean Machine": { emoji: "ðŸ§¹", description: "Complete any cleaning task 3 times", points: 0, isCustom: false },
        "Streak Master": { emoji: "ðŸ”¥", description: "Complete all your daily tasks", points: 0, isCustom: false },
        "Team Player": { emoji: "ðŸ¤", description: "Family completes all tasks in a day", points: 0, isCustom: false }
      };

      const badgeDefinitions = {
        ...Object.fromEntries(Object.entries(systemBadges).filter(([badgeName]) => !customBadges[badgeName]?.deleted)),
        ...Object.fromEntries(Object.entries(customBadges).filter(([_, badgeInfo]) => !badgeInfo.deleted))
      };

      const addCustomBadge = (e) => {
        e.preventDefault();
        if (!newCustomBadge.name || !newCustomBadge.description) return;
        const updatedCustomBadges = {
          ...customBadges,
          [newCustomBadge.name]: {
            emoji: newCustomBadge.emoji,
            description: newCustomBadge.description,
            points: newCustomBadge.points,
            isCustom: true
          }
        };
        setCustomBadges(updatedCustomBadges);
        localStorage.setItem("customBadges", JSON.stringify(updatedCustomBadges));
        setNewCustomBadge({ name: "", emoji: "ðŸ…", description: "", points: 0 });
      };

      const updateBadge = (badgeName, updatedInfo) => {
        const updatedCustomBadges = {
          ...customBadges,
          [badgeName]: { ...updatedInfo, isCustom: badgeDefinitions[badgeName]?.isCustom }
        };
        setCustomBadges(updatedCustomBadges);
        localStorage.setItem("customBadges", JSON.stringify(updatedCustomBadges));
        setEditingBadge(null);
      };

      const deleteBadge = (badgeName) => {
        if (!badgeDefinitions[badgeName]?.isCustom) {
          const updatedCustomBadges = {
            ...customBadges,
            [badgeName]: { ...badgeDefinitions[badgeName], deleted: true }
          };
          setCustomBadges(updatedCustomBadges);
          localStorage.setItem("customBadges", JSON.stringify(updatedCustomBadges));
        } else {
          const updatedCustomBadges = { ...customBadges };
          delete updatedCustomBadges[badgeName];
          setCustomBadges(updatedCustomBadges);
          localStorage.setItem("customBadges", JSON.stringify(updatedCustomBadges));
        }
        setUsers(users.map(user => ({
          ...user,
          badges: user.badges.filter(badge => badge !== badgeName)
        })));
      };

      const awardCustomBadge = (userName, badgeName) => {
        setUsers(users.map(user => 
          user.name === userName && !user.badges.includes(badgeName) ? { ...user, badges: [...user.badges, badgeName] } : user
        ));
      };

      const checkBadges = (user, userTasks, allTasks, allUsers) => {
        return checkBadgesWithCompletions(user, userTasks, allTasks, allUsers, taskCompletions);
      };

      const checkBadgesWithCompletions = (user, userTasks, allTasks, allUsers, completions) => {
        let newBadges = [];

        // Helper function to check if task is completed with given completions
        const isTaskCompletedInState = (taskId, date, completionsState) => {
          const dateKey = getDateKey(date);
          const dateCompletions = completionsState[dateKey];
          return dateCompletions ? dateCompletions[taskId] || false : false;
        };

        // Get all completed tasks for this user across all time (for cumulative badges)
        const allCompletedTasks = [];
        Object.keys(completions).forEach(dateKey => {
          const dayCompletions = completions[dateKey];
          Object.keys(dayCompletions).forEach(taskId => {
            if (dayCompletions[taskId]) {
              const task = userTasks.find(t => t.id === parseInt(taskId));
              if (task) {
                allCompletedTasks.push(task);
              }
            }
          });
        });

        // Today's completed tasks using current completion state
        const todayCompletedTasks = userTasks.filter(t => isTaskCompletedInState(t.id, selectedDate, completions));
        const todayDailyTasks = todayCompletedTasks.filter(t => t.frequency === "Daily");

        // Badge checks - only add if conditions are met
        if (allCompletedTasks.length >= 1) {
          newBadges.push("First Timer");
        }

        if (todayDailyTasks.length >= 5) {
          newBadges.push("Daily Hero");
        }

        if (user.points >= 100) {
          newBadges.push("Century Club");
        }

        const eggTasks = allCompletedTasks.filter(t => t.name.toLowerCase().includes("egg"));
        if (eggTasks.length >= 5) {
          newBadges.push("Egg Expert");
        }

        const feedTasks = allCompletedTasks.filter(t => t.name.toLowerCase().includes("feed"));
        if (feedTasks.length >= 7) {
          newBadges.push("Feed Master");
        }

        const cleanTasks = allCompletedTasks.filter(t => t.name.toLowerCase().includes("clean"));
        if (cleanTasks.length >= 3) {
          newBadges.push("Clean Machine");
        }

        // Streak Master: Complete all daily tasks for today
        const userDailyTasks = userTasks.filter(t => {
          if (!t.daysOfWeek) return t.frequency === "Daily";
          const currentDay = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
          return t.daysOfWeek.includes(currentDay);
        });
        const completedDailyTasks = userDailyTasks.filter(t => isTaskCompletedInState(t.id, selectedDate, completions));
        if (userDailyTasks.length > 0 && completedDailyTasks.length === userDailyTasks.length) {
          newBadges.push("Streak Master");
        }

        // Team Player: All family members complete their tasks today
        const todayTasks = allTasks.filter(t => {
          if (!t.daysOfWeek) return t.frequency === "Daily";
          const currentDay = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
          return t.daysOfWeek.includes(currentDay);
        });
        const allTasksCompleted = todayTasks.length > 0 && todayTasks.every(t => isTaskCompletedInState(t.id, selectedDate, completions));
        if (allTasksCompleted) {
          newBadges.push("Team Player");
        }

        // Add any custom badges that the user still has
        const customBadgesEarned = user.badges.filter(badge => badgeDefinitions[badge]?.isCustom);
        newBadges = [...newBadges, ...customBadgesEarned];

        // Remove duplicates
        return [...new Set(newBadges)];
      };

      const isTaskCompleted = (taskId, date) => {
        const dateKey = getDateKey(date);
        const dateCompletions = taskCompletions[dateKey];
        return dateCompletions ? dateCompletions[taskId] || false : false;
      };

      const completeTask = (task) => {
        const dateKey = getDateKey(selectedDate);
        setTaskCompletions(prev => ({
          ...prev,
          [dateKey]: {
            ...prev[dateKey],
            [task.id]: true
          }
        }));

        setUsers(prevUsers => {
          return prevUsers.map(u => {
            if (u.name === task.assignee) {
              const newPoints = u.points + task.points;
              const userTasks = tasks.filter(t => t.assignee === u.name);
              const updatedUser = { ...u, points: newPoints };
              const newBadges = checkBadges(updatedUser, userTasks, tasks, prevUsers);
              return { ...updatedUser, badges: newBadges };
            } else {
              const userTasks = tasks.filter(t => t.assignee === u.name);
              const newBadges = checkBadges(u, userTasks, tasks, prevUsers);
              return { ...u, badges: newBadges };
            }
          });
        });
      };

      const toggleTask = (task) => {
        const dateKey = getDateKey(selectedDate);
        const wasCompleted = isTaskCompleted(task.id, selectedDate);
        const newCompletionStatus = !wasCompleted;

        // Update task completions first
        setTaskCompletions(prev => {
          const currentDateCompletions = prev[dateKey] || {};
          const newCompletions = {
            ...prev,
            [dateKey]: {
              ...currentDateCompletions,
              [task.id]: newCompletionStatus
            }
          };

          // Update users with the new completion state
          setUsers(prevUsers => {
            return prevUsers.map(u => {
              let newPoints = u.points;
              if (task.assignee === u.name) {
                newPoints = wasCompleted ? u.points - task.points : u.points + task.points;
              }

              const userTasks = tasks.filter(t => t.assignee === u.name);
              const updatedUser = { ...u, points: newPoints };

              // Check badges with the updated completion state
              const newBadges = checkBadgesWithCompletions(updatedUser, userTasks, tasks, prevUsers, newCompletions);
              return { ...updatedUser, badges: newBadges };
            });
          });

          return newCompletions;
        });
      };

      const getPersonColor = (assignee) => {
        const user = users.find(u => u.name === assignee);
        const userColor = user?.color;

        switch (userColor) {
          case "blue": return "bg-blue-200 text-blue-800";
          case "purple": return "bg-purple-200 text-purple-800";
          case "orange": return "bg-orange-200 text-orange-800";
          case "pink": return "bg-pink-200 text-pink-800";
          case "green": return "bg-green-200 text-green-800";
          case "red": return "bg-red-200 text-red-800";
          case "yellow": return "bg-yellow-200 text-yellow-800";
          case "indigo": return "bg-indigo-200 text-indigo-800";
          default:
            // Fallback to original logic for backward compatibility
            switch (assignee) {
              case "Mom": return "bg-blue-200 text-blue-800";
              case "Dad": return "bg-purple-200 text-purple-800";
              case "Kid 1": return "bg-orange-200 text-orange-800";
              case "Kid 2": return "bg-pink-200 text-pink-800";
              default: return "bg-gray-200 text-gray-800";
            }
        }
      };

      const getPersonTextColor = (assignee) => {
        const user = users.find(u => u.name === assignee);
        const userColor = user?.color;

        switch (userColor) {
          case "blue": return "text-blue-600";
          case "purple": return "text-purple-600";
          case "orange": return "text-orange-600";
          case "pink": return "text-pink-600";
          case "green": return "text-green-600";
          case "red": return "text-red-600";
          case "yellow": return "text-yellow-600";
          case "indigo": return "text-indigo-600";
          default:
            // Fallback to original logic for backward compatibility
            switch (assignee) {
              case "Mom": return "text-blue-600";
              case "Dad": return "text-purple-600";
              case "Kid 1": return "text-orange-600";
              case "Kid 2": return "text-pink-600";
              default: return "text-gray-600";
            }
        }
      };

      // Page navigation with smooth transitions
      const navigateToPage = (page, additionalState = {}) => {
        setShowPageTransition(true);
        setTimeout(() => {
          setCurrentPage(page);
          if (page === PAGES.TASKS) {
            setView("tasks");
            setSelectedProfile(null);
          } else if (page === PAGES.LEADERBOARD) {
            setView("leaderboard");
            setSelectedProfile(null);
          } else if (page === PAGES.PROFILE && additionalState.profile) {
            setView("profile");
            setSelectedProfile(additionalState.profile);
          } else if (page === PAGES.TASK_EDITOR) {
            setView("task-editor");
            setSelectedProfile(null);
          } else if (page === PAGES.BADGE_EDITOR) {
            setView("badge-editor");
            setSelectedProfile(null);
          }

          // Apply any additional state
          Object.keys(additionalState).forEach(key => {
            if (key !== 'profile') {
              // Handle other state updates if needed
            }
          });

          setShowPageTransition(false);
        }, 150);
      };

      // Complete onboarding
      const completeOnboarding = () => {
        localStorage.setItem("hasCompletedOnboarding", "true");
        navigateToPage(PAGES.TASKS);
      };

      // Reset onboarding (for settings)
      const resetOnboarding = () => {
        localStorage.removeItem("hasCompletedOnboarding");
        setOnboardingStep(0);
        navigateToPage(PAGES.ONBOARDING);
      };

      // *** AUTHENTICATION FUNCTIONS - CORRECTED ***
      const handleSignup = async (e, authForm) => {
        e.preventDefault();
        if (authForm.password !== authForm.confirmPassword) {
          alert("Passwords don't match!");
          return;
        }
        if (!authForm.email || !authForm.password || !authForm.familyName) {
          alert("Please fill in all fields!");
          return;
        }

        try {
          const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(
            window.firebaseAuth.auth,
            authForm.email,
            authForm.password
          );

          const user = userCredential.user;

          const userAccount = {
              uid: user.uid,
              email: user.email,
              familyName: authForm.familyName,
              createdAt: new Date().toISOString()
          };
          localStorage.setItem("userAccount", JSON.stringify(userAccount));

          if (authForm.familyName && authForm.familyName !== "Family") {
            const updatedUsers = users.map(user => ({
              ...user,
              familyName: authForm.familyName
            }));
            setUsers(updatedUsers);
          }

          navigateToPage(PAGES.TASKS);

        } catch (error) {
          console.error("Signup error:", error);
          alert(error.message);
        }
      };

      const handleLogin = async (e, authForm) => {
        e.preventDefault();
        if (!authForm.email || !authForm.password) {
          alert("Please fill in all fields!");
          return;
        }

        try {
          await window.firebaseAuth.signInWithEmailAndPassword(
            window.firebaseAuth.auth,
            authForm.email,
            authForm.password
          );

          navigateToPage(PAGES.TASKS);

        } catch (error) {
          console.error("Login error:", error);
          if (error.code === "auth/invalid-login-credentials") {
            alert("Invalid email or password")
          } else {
            alert(error.message);
          }
        }
      };

      const handleGoogleLogin = async () => {
        try {
          console.log("ðŸ”„ Starting Google login process...");
          const result = await window.firebaseAuth.signInWithPopup(
            window.firebaseAuth.auth,
            window.firebaseAuth.googleProvider
          );

          const user = result.user;
          console.log("âœ… Google login successful for:", user.email);

          // Check if this user's data already exists in localStorage.
          const isReturningUser = localStorage.getItem("userAccount") && JSON.parse(localStorage.getItem("userAccount")).uid === user.uid;

          if (!isReturningUser) {
            console.log("ðŸ‘¤ New user detected. Prompting for family name.");
            let familyName = "";
            while (!familyName || familyName.trim() === "") {
              familyName = prompt("Welcome! Please enter your Family Name to continue:");
              if (familyName === null) { // User clicked "Cancel"
                console.log("âŒ User cancelled sign-up. Signing out.");
                await window.firebaseAuth.signOut(window.firebaseAuth.auth);
                return; // Stop the function
              }
            }

            const userAccount = {
              uid: user.uid,
              email: user.email,
              familyName: familyName.trim(),
              createdAt: new Date().toISOString()
            };
            localStorage.setItem("userAccount", JSON.stringify(userAccount));

            localStorage.removeItem("tasks");
            localStorage.removeItem("users");
            localStorage.removeItem("customBadges");
            localStorage.removeItem("taskCompletions");

            setTasks(initialTasks);
            setUsers(initialUsers);

            console.log("âœ… New account configured for:", familyName);
          } else {
            console.log("âœ… Returning user logged in.");
          }

          navigateToPage(PAGES.TASKS);

        } catch (error) {
          if (error.code === 'auth/popup-closed-by-user') {
            console.log("Login popup closed by user.");
            return;
          }
          console.error("âŒ Google login error:", error);
          alert(error.message);
        }
      };

      const handleLogout = async () => {
        if (confirm("Are you sure you want to log out? This will clear your local data and you will need to log in again.")) {
          try {
            await window.firebaseAuth.signOut(window.firebaseAuth.auth);
            navigateToPage(PAGES.LOGIN);

            console.log("âœ… Logged out successfully");
          } catch (error) {
            console.error("Logout error:", error);
            alert(error.message);
          }
        }
      };

      // Check authentication state on app load
      useEffect(() => {
        if (!window.firebaseAuth) return;
        const unsubscribe = window.firebaseAuth.onAuthStateChanged(window.firebaseAuth.auth, (user) => {
          if (user) {
            // User is signed in
            setIsAuthenticated(true);
          } else {
            // User is signed out or a guest
            setIsAuthenticated(false);
          }
        });

        // Cleanup the listener when the component unmounts
        return () => unsubscribe();
      }, []);

      const getTaskEmoji = (taskName, taskEmoji) => {
        if (taskEmoji) return taskEmoji;
        const name = taskName.toLowerCase();
        if (name.includes('feed') && name.includes('chicken')) return "ðŸŒ¾";
        if (name.includes('egg')) return "ðŸ¥š";
        if (name.includes('clean') && name.includes('coop')) return "ðŸ§¹";
        if (name.includes('water') && name.includes('refill')) return "ðŸ’§";
        if (name.includes('water') && name.includes('clean')) return "ðŸ§½";
        if (name.includes('feed') && name.includes('storage')) return "ðŸ“¦";
        if (name.includes('free range') || name.includes('supervised')) return "ðŸ“";
        if (name.includes('clean')) return "ðŸ§¹";
        if (name.includes('feed')) return "ðŸŒ¾";
        if (name.includes('water')) return "ðŸ’§";
        if (name.includes('egg')) return "ðŸ¥š";
        return "ðŸ“‹";
      };

      // Emoji picker functions
      const openEmojiPicker = (target) => {
        setEmojiPickerTarget(target);
        setShowEmojiPicker(true);
      };

      const closeEmojiPicker = () => {
        setShowEmojiPicker(false);
        setEmojiPickerTarget(null);
      };

      const selectEmoji = (emoji) => {
        if (emojiPickerTarget === 'newTask') {
          setNewTask({ ...newTask, emoji });
        } else if (emojiPickerTarget === 'editTask') {
          setEditedTaskData({ ...editedTaskData, emoji });
        } else if (emojiPickerTarget === 'newBadge') {
          setNewCustomBadge({ ...newCustomBadge, emoji });
        }
        closeEmojiPicker();
      };

      // Emoji Picker Component
      const EmojiPicker = () => {
        if (!showEmojiPicker) return null;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-md w-full max-h-96 overflow-hidden">
              <div className="p-4 border-b border-gray-200">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-lg font-semibold text-gray-800">Choose Emoji</h3>
                  <button
                    onClick={closeEmojiPicker}
                    className="text-gray-500 hover:text-gray-700 text-xl"
                  >
                    Ã—
                  </button>
                </div>

                {/* Category Tabs */}
                <div className="flex space-x-1 overflow-x-auto">
                  {Object.keys(emojiCategories).map((category) => (
                    <button
                      key={category}
                      onClick={(e) => {
                        e.stopPropagation();
                        setSelectedEmojiCategory(category);
                      }}
                      className={`px-3 py-1 rounded-lg text-xs font-medium whitespace-nowrap ${
                        selectedEmojiCategory === category
                          ? "bg-blue-500 text-white"
                          : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                      }`}
                    >
                      {category.split(' ')[0]}
                    </button>
                  ))}
                </div>
              </div>

              <div className="p-4 overflow-y-auto max-h-64">
                <div className="grid grid-cols-8 gap-2">
                  {emojiCategories[selectedEmojiCategory].map((emoji, index) => (
                    <button
                      key={index}
                      onClick={() => selectEmoji(emoji)}
                      className="w-8 h-8 flex items-center justify-center text-lg hover:bg-gray-100 rounded-lg transition-colors"
                    >
                      {emoji}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Click outside handler for emoji picker
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (showEmojiPicker && !event.target.closest('.fixed')) {
            closeEmojiPicker();
          }
        };

        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showEmojiPicker]);

      const resetDaily = () => {
        const dateKey = getDateKey(selectedDate);
        setTaskCompletions(prev => ({ ...prev, [dateKey]: {} }));
        const today = new Date().toDateString();
        setLastResetDate(today);
        localStorage.setItem("lastResetDate", today);
      };

      const completionRate = () => {
        const total = tasks.length;
        let completed = 0;
        for (let i = 0; i < tasks.length; i++) {
          if (isTaskCompleted(tasks[i].id, selectedDate)) {
            completed++;
          }
        }
        return total ? Math.round((completed / total) * 100) : 0;
      };

      const getUserCompletionRates = () => {
        return users.map(user => {
          const userTasks = tasks.filter(t => t.assignee === user.name);
          let completedTasks = 0;
          for (let i = 0; i < userTasks.length; i++) {
            if (isTaskCompleted(userTasks[i].id, selectedDate)) {
              completedTasks++;
            }
          }
          const rate = userTasks.length ? Math.round((completedTasks / userTasks.length) * 100) : 0;
          return { name: user.name, rate };
        });
      };

      useEffect(() => {
        if (view === "insights") {
          const ctx = document.getElementById("completionChart")?.getContext("2d");
          if (ctx) {
            const userRates = getUserCompletionRates();
            const colors = ["#4CAF50", "#2196F3", "#FF9800", "#E91E63"];
            new Chart(ctx, {
              type: "bar",
              data: {
                labels: userRates.map(u => u.name),
                datasets: [{
                  label: "Completion Rate (%)",
                  data: userRates.map(u => u.rate),
                  backgroundColor: colors.slice(0, userRates.length),
                  borderColor: colors.slice(0, userRates.length),
                  borderWidth: 1,
                }],
              },
              options: {
                scales: { y: { beginAtZero: true, max: 100 } },
                plugins: { 
                  title: { display: true, text: "Task Completion Rate by Person" },
                  legend: { display: false }
                },
                responsive: true,
                maintainAspectRatio: false
              },
            });
          }
        }
      }, [view, tasks, taskCompletions, selectedDate]);

      // Onboarding Component
      // Onboarding Page now manages its own form state
      const OnboardingPage = ({ handleSignup, handleLogin, handleGoogleLogin, navigateToPage }) => {
        const [authMode, setAuthMode] = useState('signup'); // 'signup' or 'login'
        const [authForm, setAuthForm] = useState({
          email: '',
          password: '',
          confirmPassword: '',
          familyName: ''
        });
        const currentStepData = ONBOARDING_STEPS[onboardingStep];
        const isLastStep = onboardingStep === ONBOARDING_STEPS.length - 1;
        const isAuthStep = currentStepData && currentStepData.id === 'auth';

        // If currentStepData is undefined, show a fallback or redirect
        if (!currentStepData) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-yellow-50 flex items-center justify-center p-4">
              <div className="max-w-md w-full">
                <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100 text-center">
                  <div className="text-6xl mb-6">ðŸ”</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-4">Welcome to Chicken Chores!</h1>
                  <p className="text-gray-600 mb-8">Let's get you started!</p>
                  <button
                    onClick={completeOnboarding}
                    className="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105"
                  >
                    Start Using Chicken Chores! ðŸ”
                  </button>
                </div>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-yellow-50 flex items-center justify-center p-4">
            <div className="max-w-md w-full">
              {/* Progress Bar */}
              <div className="mb-8">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium text-gray-600">Step {onboardingStep + 1} of {ONBOARDING_STEPS.length}</span>
                  <span className="text-sm text-gray-500">{Math.round(((onboardingStep + 1) / ONBOARDING_STEPS.length) * 100)}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-500 ease-out"
                    style={{ width: `${((onboardingStep + 1) / ONBOARDING_STEPS.length) * 100}%` }}
                  ></div>
                </div>
              </div>

              {/* Step Content */}
              <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                {isAuthStep ? (
                  /* Authentication Step */
                  <div>
                    <div className="text-center mb-6">
                      <div className="text-6xl mb-4 animate-bounce">ðŸš€</div>
                      <h1 className="text-2xl font-bold text-gray-800 mb-2">You're All Set!</h1>
                      <p className="text-gray-600 mb-6">Create an account to save your progress, or start using Chicken Chores right away!</p>
                    </div>

                    {/* Auth Mode Toggle */}
                    <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
                      <button
                        onClick={() => setAuthMode('signup')}
                        className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                          authMode === 'signup' 
                            ? 'bg-white text-gray-800 shadow-sm' 
                            : 'text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        Sign Up
                      </button>
                      <button
                        onClick={() => setAuthMode('login')}
                        className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                          authMode === 'login' 
                            ? 'bg-white text-gray-800 shadow-sm' 
                            : 'text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        Log In
                      </button>
                    </div>

                    {/* Auth Form */}
                    <form onSubmit={(e) => authMode === 'signup' ? handleSignup(e, authForm) : handleLogin(e, authForm)} className="space-y-4">
                      {authMode === 'signup' && (
                        <div>
                          <input
                            type="text"
                            placeholder="Family Name (e.g., The Smiths)"
                            value={authForm.familyName}
                            onChange={(e) => setAuthForm({ ...authForm, familyName: e.target.value })}
                            className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                            required
                          />
                        </div>
                      )}

                      <div>
                        <input
                          type="email"
                          placeholder="Email Address"
                          value={authForm.email}
                          onChange={(e) => setAuthForm({ ...authForm, email: e.target.value })}
                          className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                          required
                        />
                      </div>

                      <div>
                        <input
                          type="password"
                          placeholder="Password"
                          value={authForm.password}
                          onChange={(e) => setAuthForm({ ...authForm, password: e.target.value })}
                          className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                          required
                        />
                      </div>

                      {authMode === 'signup' && (
                        <div>
                          <input
                            type="password"
                            placeholder="Confirm Password"
                            value={authForm.confirmPassword}
                            onChange={(e) => setAuthForm({ ...authForm, confirmPassword: e.target.value })}
                            className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                            required
                          />
                        </div>
                      )}

                      <button
                        type="submit"
                        className="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105"
                      >
                        {authMode === 'signup' ? 'Create Account' : 'Log In'}
                      </button>
                    </form>

                    {/* Google Login Button */}
                    <div className="mt-6">
                      <div className="relative">
                        <div className="absolute inset-0 flex items-center">
                          <div className="w-full border-t border-gray-300" />
                        </div>
                        <div className="relative flex justify-center text-sm">
                          <span className="px-2 bg-white text-gray-500">Or continue with</span>
                        </div>
                      </div>
                      <button
                        onClick={handleGoogleLogin}
                        className="w-full mt-4 bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:bg-gray-50 flex items-center justify-center"
                      >
                        <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24">
                          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Continue with Google
                      </button>
                    </div>

                    {/* Continue as Guest Option */}
                    <div className="text-center mt-4">
                      <button
                        onClick={completeOnboarding}
                        className="text-gray-500 hover:text-gray-700 text-sm font-medium transition-colors duration-200"
                      >
                        Continue without saving
                      </button>
                    </div>
                  </div>
                ) : (
                  /* Regular Step Content */
                  <div className="text-center">
                    <div className="text-6xl mb-6 animate-bounce">
                      {currentStepData.icon}
                    </div>
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">
                      {currentStepData.title}
                    </h1>
                    <p className="text-gray-600 mb-8 leading-relaxed">
                      {currentStepData.content}
                    </p>

                    {/* Navigation Buttons */}
                    <div className="flex gap-3">
                      {onboardingStep > 0 && (
                        <button
                          onClick={() => setOnboardingStep(prev => prev - 1)}
                          className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-colors duration-200"
                        >
                          â† Back
                        </button>
                      )}

                      <button
                        onClick={() => {
                          if (isLastStep) {
                            completeOnboarding();
                          } else {
                            setOnboardingStep(prev => prev + 1);
                          }
                        }}
                        className="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105"
                      >
                        {isLastStep ? "Continue â†’" : "Next â†’"}
                      </button>
                    </div>

                    {/* Skip Button */}
                    {!isLastStep && (
                      <button
                        onClick={completeOnboarding}
                        className="mt-4 text-sm text-gray-500 hover:text-gray-700 transition-colors duration-200"
                      >
                        Skip to app
                      </button>
                    )}
                  </div>
                )}
              </div>

              {/* Steps Indicator */}
              <div className="flex justify-center mt-6 space-x-2">
                {ONBOARDING_STEPS.map((_, index) => (
                  <button
                    key={index}
                    onClick={() => setOnboardingStep(index)}
                    className={`w-3 h-3 rounded-full transition-all duration-200 ${
                      index === onboardingStep 
                        ? "bg-green-500 scale-125" 
                        : index < onboardingStep 
                        ? "bg-blue-400" 
                        : "bg-gray-300"
                    }`}
                  />
                ))}
              </div>
            </div>
          </div>
        );
      };

      // Family Members Page Component (copy of Settings)
      const FamilyMembersPage = () => {
        const [newMemberName, setNewMemberName] = useState("");
        const [newMemberAvatar, setNewMemberAvatar] = useState("ðŸ‘¤");
        const [newMemberColor, setNewMemberColor] = useState("blue");
        const [showAddMember, setShowAddMember] = useState(false);
        const [editedProfileData, setEditedProfileData] = useState({});

        const availableAvatars = Object.values(emojiCategories).flat();

        const colorOptions = [
          { name: "blue", bg: "bg-blue-200", text: "text-blue-800", preview: "#DBEAFE" },
          { name: "purple", bg: "bg-purple-200", text: "text-purple-800", preview: "#E9D5FF" },
          { name: "orange", bg: "bg-orange-200", text: "text-orange-800", preview: "#FED7AA" },
          { name: "pink", bg: "bg-pink-200", text: "text-pink-800", preview: "#FBCFE8" },
          { name: "green", bg: "bg-green-200", text: "text-green-800", preview: "#BBF7D0" },
          { name: "red", bg: "bg-red-200", text: "text-red-800", preview: "#FECACA" },
          { name: "yellow", bg: "bg-yellow-200", text: "text-yellow-800", preview: "#FEF08A" },
          { name: "indigo", bg: "bg-indigo-200", text: "text-indigo-800", preview: "#C7D2FE" }
        ];

        const addNewMember = (e) => {
          e.preventDefault();
          if (!newMemberName.trim()) return;

          // Check if name already exists
          if (users.some(user => user.name.toLowerCase() === newMemberName.trim().toLowerCase())) {
            alert("A family member with this name already exists!");
            return;
          }

          const newUser = {
            name: newMemberName.trim(),
            points: 0,
            badges: [],
            avatar: newMemberAvatar,
            color: newMemberColor
          };

          setUsers([...users, newUser]);
          setNewMemberName("");
          setNewMemberAvatar("ðŸ‘¤");
          setNewMemberColor("blue");
          setShowAddMember(false);
        };

        const removeMember = (memberName) => {
          if (users.length <= 1) {
            alert("You must have at least one family member!");
            return;
          }

          if (confirm(`Are you sure you want to remove ${memberName} from the family? This will also remove all their task assignments.`)) {
            // Remove user
            setUsers(users.filter(user => user.name !== memberName));

            // Reassign their tasks to the first remaining user
            const remainingUsers = users.filter(user => user.name !== memberName);
            if (remainingUsers.length > 0) {
              const newAssignee = remainingUsers[0].name;
              setTasks(tasks.map(task => 
                task.assignee === memberName 
                  ? { ...task, assignee: newAssignee }
                  : task
              ));
            }
          }
        };

        return (
          <div className="pb-20">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg sm:text-xl font-bold text-green-700">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Members</h2>
              <button
                onClick={() => navigateToPage(PAGES.TASKS)}
                className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
              >
                â† Back
              </button>
            </div>

            <div className="space-y-4">
              {/* Family Management */}
              <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <h3 className="text-base font-semibold text-purple-800 mb-2">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Members</h3>
                <p className="text-sm text-purple-700 mb-3">Manage your family members and their profiles.</p>

                {/* Current Family Members */}
                <div className="mb-4">
                  <h4 className="text-sm font-medium text-purple-700 mb-2">Current Members ({users.length}):</h4>
                  <div className="space-y-2">
                    {users.map((user, index) => {
                      const colorOption = colorOptions.find(c => c.name === user.color) || colorOptions[index % colorOptions.length];
                      return (
                        <div key={user.name} className={`p-3 bg-white rounded-lg border ${
                          users.length > 1 ? "border-gray-200" : "border-green-300 bg-green-50"
                        }`}>
                          {editingProfile === user.name ? (
                            // Edit Mode
                            <div>
                              <h5 className="text-sm font-medium text-purple-700 mb-3">Edit {user.name}:</h5>
                              <div className="space-y-3">
                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">Name:</label>
                                  <input
                                    type="text"
                                    value={editingProfile === user.name ? (editedProfileData.name || user.name) : user.name}
                                    onChange={(e) => setEditedProfileData({ ...editedProfileData, name: e.target.value })}
                                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-purple-500 focus:outline-none"
                                  />
                                </div>

                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">Avatar:</label>
                                  <div className="border border-gray-200 rounded-lg">
                                    {/* Category Tabs */}
                                    <div className="flex space-x-1 overflow-x-auto p-2 border-b border-gray-200">
                                      {Object.keys(emojiCategories).map((category) => (
                                        <button
                                          key={category}
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            setSelectedEmojiCategory(category);
                                          }}
                                          className={`px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap ${
                                            selectedEmojiCategory === category
                                              ? "bg-purple-500 text-white"
                                              : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                                          }`}
                                        >
                                          {category.split(' ')[0]}
                                        </button>
                                      ))}
                                    </div>
                                    {/* Emoji Grid */}
                                    <div className="grid grid-cols-8 gap-2 max-h-32 overflow-y-auto p-2">
                                      {emojiCategories[selectedEmojiCategory].map((avatar, avatarIndex) => (
                                        <button
                                          key={avatarIndex}
                                          type="button"
                                          onClick={() => setEditedProfileData({ ...editedProfileData, avatar })}
                                          className={`text-2xl p-2 rounded-lg transition-colors ${
                                            (editedProfileData.avatar || user.avatar) === avatar
                                              ? "bg-purple-200 border-2 border-purple-500"
                                              : "bg-gray-100 hover:bg-gray-200 border border-gray-300"
                                          }`}
                                        >
                                          {avatar}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                </div>

                                <div>
                                  <label className="block text-xs font-medium text-gray-700 mb-1">Color Theme:</label>
                                  <div className="grid grid-cols-4 gap-2">
                                    {colorOptions.map((color) => (
                                      <button
                                        key={color.name}
                                        type="button"
                                        onClick={() => setEditedProfileData({ ...editedProfileData, color: color.name })}
                                        className={`flex items-center p-2 rounded-lg border text-xs capitalize transition-colors ${
                                          (editedProfileData.color || user.color) === color.name
                                            ? "border-purple-500 bg-purple-100"
                                            : "border-gray-300 bg-white hover:bg-gray-50"
                                        }`}
                                      >
                                        <div 
                                          className="w-4 h-4 rounded-full mr-2" 
                                          style={{ backgroundColor: color.preview }}
                                        ></div>
                                        {color.name}
                                      </button>
                                    ))}
                                  </div>
                                </div>

                                <div className="flex space-x-2 pt-2">
                                  <button
                                    onClick={() => {
                                      // Update the user with edited data
                                      const updatedUsers = users.map(u => 
                                        u.name === user.name 
                                          ? { 
                                              ...u, 
                                              name: editedProfileData.name || u.name,
                                              avatar: editedProfileData.avatar || u.avatar,
                                              color: editedProfileData.color || u.color
                                            }
                                          : u
                                      );
                                      setUsers(updatedUsers);

                                      // Update tasks if name changed
                                      if (editedProfileData.name && editedProfileData.name !== user.name) {
                                        const updatedTasks = tasks.map(task => 
                                          task.assignee === user.name 
                                            ? { ...task, assignee: editedProfileData.name }
                                            : task
                                        );
                                        setTasks(updatedTasks);
                                      }

                                      setEditingProfile(null);
                                      setEditedProfileData({});
                                    }}
                                    className="flex-1 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm"
                                  >
                                    Save
                                  </button>
                                  <button
                                    onClick={() => {
                                      setEditingProfile(null);
                                      setEditedProfileData({});
                                    }}
                                    className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm"
                                  >
                                    Cancel
                                  </button>
                                </div>
                              </div>
                            </div>
                          ) : (
                            // View Mode
                            <div className="flex items-center justify-between">
                              <div className="flex items-center">
                                <span className="text-2xl mr-3">{user.avatar || ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"][index] || "ðŸ‘¤"}</span>
                                <div>
                                  <div className="font-medium text-gray-800">{user.name}</div>
                                  <div className="text-xs text-gray-500 mt-1">
                                    {user.color ? user.color.charAt(0).toUpperCase() + user.color.slice(1) : 'Default'} theme
                                  </div>
                                </div>
                              </div>
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => {
                                    setEditingProfile(user.name);
                                    setEditedProfileData({});
                                  }}
                                  className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs"
                                >
                                  Edit
                                </button>
                                {users.length > 1 && (
                                  <button
                                    onClick={() => removeMember(user.name)}
                                    className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs"
                                  >
                                    Remove
                                  </button>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Add New Member Button/Form */}
                {showAddMember ? (
                  <form onSubmit={addNewMember} className="bg-white p-4 rounded-lg border border-purple-300">
                    <h4 className="text-sm font-medium text-purple-700 mb-3">Add New Family Member:</h4>

                    <div className="space-y-3">
                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">Name:</label>
                        <input
                          type="text"
                          value={newMemberName}
                          onChange={(e) => setNewMemberName(e.target.value)}
                          placeholder="Enter family member's name"
                          className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-purple-500 focus:outline-none"
                          required
                        />
                      </div>

                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">Avatar:</label>
                        <div className="border border-gray-200 rounded-lg">
                          {/* Category Tabs */}
                          <div className="flex space-x-1 overflow-x-auto p-2 border-b border-gray-200">
                            {Object.keys(emojiCategories).map((category) => (
                              <button
                                key={category}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setSelectedEmojiCategory(category);
                                }}
                                className={`px-2 py-1 rounded-lg text-xs font-medium whitespace-nowrap ${
                                  selectedEmojiCategory === category
                                    ? "bg-purple-500 text-white"
                                    : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                                }`}
                              >
                                {category.split(' ')[0]}
                              </button>
                            ))}
                          </div>
                          {/* Emoji Grid */}
                          <div className="grid grid-cols-8 gap-2 max-h-32 overflow-y-auto p-2">
                            {emojiCategories[selectedEmojiCategory].map((avatar, index) => (
                              <button
                                key={index}
                                type="button"
                                onClick={() => setNewMemberAvatar(avatar)}
                                className={`text-2xl p-2 rounded-lg transition-colors ${
                                  newMemberAvatar === avatar
                                    ? "bg-purple-200 border-2 border-purple-500"
                                    : "bg-gray-100 hover:bg-gray-200 border border-gray-300"
                                }`}
                              >
                                {avatar}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>

                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">Color Theme:</label>
                        <div className="grid grid-cols-4 gap-2">
                          {colorOptions.map((color) => (
                            <button
                              key={color.name}
                              type="button"
                              onClick={() => setNewMemberColor(color.name)}
                              className={`flex items-center p-2 rounded-lg border text-xs capitalize transition-colors ${
                                newMemberColor === color.name
                                  ? "border-purple-500 bg-purple-100"
                                  : "border-gray-300 bg-white hover:bg-gray-50"
                              }`}
                            >
                              <div 
                                className="w-4 h-4 rounded-full mr-2" 
                                style={{ backgroundColor: color.preview }}
                              ></div>
                              {color.name}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div className="flex space-x-2 pt-2">
                        <button
                          type="submit"
                          className="flex-1 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm"
                        >
                          Add Member
                        </button>
                        <button
                          type="button"
                          onClick={() => {
                            setShowAddMember(false);
                            setNewMemberName("");
                            setNewMemberAvatar("ðŸ‘¤");
                            setNewMemberColor("blue");
                          }}
                          className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </form>
                ) : (
                  <button
                    onClick={() => setShowAddMember(true)}
                    className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm"
                  >
                    + Add Family Member
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      };

      // Settings Page Component
      const SettingsPage = () => {
        return (
          <div className="pb-20">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg sm:text-xl font-bold text-green-700">âš™ï¸ Settings</h2>
              <button
                onClick={() => navigateToPage(PAGES.TASKS)}
                className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
              >
                â† Back
              </button>
            </div>

            <div className="space-y-4">
              {/* Family Members Section */}
              <button
                onClick={() => navigateToPage(PAGES.FAMILY_MEMBERS)}
                className="w-full bg-purple-50 hover:bg-purple-100 p-4 rounded-lg border border-purple-200 text-left transition-colors"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-base font-semibold text-purple-800 mb-1">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Members</h3>
                    <p className="text-sm text-purple-700">Manage family members and their profiles</p>
                    <div className="text-xs text-purple-600 mt-1">
                      {users.length} members â€¢ Edit profiles and add new members
                    </div>
                  </div>
                  <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </button>

              {/* Edit Tasks Section */}
              <button
                onClick={() => navigateToPage(PAGES.TASK_EDITOR)}
                className="w-full bg-orange-50 hover:bg-orange-100 p-4 rounded-lg border border-orange-200 text-left transition-colors"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-base font-semibold text-orange-800 mb-1">âœï¸ Add/Edit Tasks</h3>
                    <p className="text-sm text-orange-700">Create, edit, and manage all tasks</p>
                    <div className="text-xs text-orange-600 mt-1">
                      {tasks.length} tasks â€¢ {tasks.filter(t => t.active !== false).length} active
                    </div>
                  </div>
                  <svg className="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </button>

              {/* Edit Badges Section */}
              <button
                onClick={() => navigateToPage(PAGES.BADGE_EDITOR)}
                className="w-full bg-yellow-50 hover:bg-yellow-100 p-4 rounded-lg border border-yellow-200 text-left transition-colors"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-base font-semibold text-yellow-800 mb-1">ðŸŽ–ï¸ Add/Edit Badges</h3>
                    <p className="text-sm text-yellow-700">Create and manage achievement badges</p>
                    <div className="text-xs text-yellow-600 mt-1">
                      {Object.keys(badgeDefinitions).length} badges â€¢ System and custom badges
                    </div>
                  </div>
                  <svg className="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </button>

              {/* Account Section */}
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-base font-semibold text-blue-800 mb-1">ðŸ‘¤ Account</h3>
                    <p className="text-sm text-blue-700">Manage your account and authentication</p>
                  </div>
                  <div className="text-blue-600">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                  </div>
                </div>

                {isAuthenticated ? (
                  /* Authenticated User Information */
                  <div className="space-y-4">
                    <div className="bg-white p-4 rounded-lg border border-blue-300">
                      <h4 className="text-sm font-semibold text-blue-800 mb-3">Account Information</h4>
                      <div className="space-y-2 text-sm">
                        {(() => {
                          const account = JSON.parse(localStorage.getItem("userAccount") || '{}');
                          return (
                            <>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Email:</span>
                                <span className="text-gray-800 font-medium">{account.email || 'Not available'}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Family Name:</span>
                                <span className="text-gray-800 font-medium">{account.familyName || 'Not set'}</span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Created:</span>
                                <span className="text-gray-800 font-medium">
                                  {account.createdAt ? new Date(account.createdAt).toLocaleDateString() : 'Not available'}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-600">Status:</span>
                                <span className="text-green-800 font-medium bg-green-100 px-2 py-1 rounded-full text-xs">
                                  âœ… Active
                                </span>
                              </div>
                            </>
                          );
                        })()}
                      </div>
                    </div>

                    <button
                      onClick={handleLogout}
                      className="w-full bg-red-500 hover:bg-red-600 text-white p-3 rounded-lg font-medium transition-colors"
                    >
                      ðŸšª Log Out
                    </button>
                  </div>
                ) : (
                  /* Non-Authenticated User */
                  <div className="space-y-4">
                    <div className="bg-white p-4 rounded-lg border border-orange-300">
                      <h4 className="text-sm font-semibold text-orange-800 mb-3">Guest Mode</h4>
                      <div className="flex items-center justify-between mb-3">
                        <span className="text-gray-600 text-sm">Current Status:</span>
                        <span className="text-orange-800 font-medium bg-orange-100 px-2 py-1 rounded-full text-xs">
                          ðŸ‘¤ Guest User
                        </span>
                      </div>
                      <p className="text-xs text-gray-600 mb-3">
                        You're using Chicken Chores as a guest. Your data is saved locally but won't sync across devices and resets daily at midnight.
                      </p>
                      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                        <h5 className="text-xs font-semibold text-yellow-800 mb-1">Why create an account?</h5>
                        <ul className="text-xs text-yellow-700 space-y-1">
                          <li>â€¢ Save progress across devices</li>
                          <li>â€¢ Backup your family's tasks</li>
                          <li>â€¢ Access from anywhere</li>
                          <li>â€¢ Keep data permanently (no daily reset)</li>
                        </ul>
                      </div>

                      {/* Manual Reset for Guest Users */}
                      <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                        <h5 className="text-xs font-semibold text-red-800 mb-2">ðŸ”„ Reset Everything</h5>
                        <p className="text-xs text-red-700 mb-2">
                          Restore all default tasks and family members. This will delete all your current progress!
                        </p>
                        <button
                          onClick={() => {
                            if (confirm("Are you sure you want to reset everything? This will restore all default tasks and family members, and delete all your current progress. This action cannot be undone!")) {
                              // Clear all guest data
                              localStorage.removeItem("tasks");
                              localStorage.removeItem("users");
                              localStorage.removeItem("customBadges");
                              localStorage.removeItem("taskCompletions");
                              localStorage.removeItem("lastWeeklyReset");
                              localStorage.removeItem("lastResetDate");
                              
                              // Reset to initial state
                              setTasks(initialTasks);
                              setUsers(initialUsers);
                              setCustomBadges({});
                              setTaskCompletions({});
                              setLastWeeklyReset(null);
                              setLastResetDate(new Date().toDateString());
                              
                              // Reset UI state
                              setEditingTask(null);
                              setEditedTaskData({});
                              setEditingProfile(null);
                              setSelectedProfile(null);
                              
                              alert("âœ… Everything has been reset to defaults!");
                              
                              // Navigate back to tasks page
                              navigateToPage(PAGES.TASKS);
                            }
                          }}
                          className="w-full bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors"
                        >
                          ðŸ”„ Reset to Defaults
                        </button>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <button
                        onClick={() => navigateToPage(PAGES.LOGIN)}
                        className="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg font-medium transition-colors"
                      >
                        ðŸ“ Login / Create Account
                      </button>
                      <button
                        onClick={() => navigateToPage(PAGES.ONBOARDING)}
                        className="w-full bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-medium transition-colors"
                      >
                        ðŸŽ“ View Tutorial
                      </button>
                    </div>
                  </div>
                )}
              </div>

              {/* App Information Section */}
              <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-base font-semibold text-green-800 mb-1">â„¹ï¸ App Information</h3>
                    <div className="text-sm text-green-700 space-y-1">
                      <p><strong>Version:</strong> 2.0.0</p>
                      <p><strong>Family Members:</strong> {users.length}</p>
                      <p><strong>Total Tasks:</strong> {tasks.length}</p>
                      <p><strong>Total Badges:</strong> {Object.keys(badgeDefinitions).length}</p>
                      {isAuthenticated && (
                        <p><strong>Account:</strong> Connected</p>
                      )}
                    </div>
                  </div>
                  <div className="text-green-600">
                    <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Login Page Component
      const LoginPage = ({ handleSignup, handleLogin, handleGoogleLogin, navigateToPage }) => {
        const [authMode, setAuthMode] = useState('login'); // Default to login here
        const [authForm, setAuthForm] = useState({
          email: '',
          password: '',
          confirmPassword: '',
          familyName: ''
        });
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-yellow-50 flex items-center justify-center p-4">
            <div className="max-w-md w-full">
              <div className="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">ðŸ”</div>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">Welcome to Chicken Chores</h1>
                  <p className="text-gray-600 mb-6">Sign in to your account or create a new one to save your progress</p>
                </div>

                {/* Auth Mode Toggle */}
                <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
                  <button
                    onClick={() => setAuthMode('login')}
                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                      authMode === 'login' 
                        ? 'bg-white text-gray-800 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-800'
                    }`}
                  >
                    Log In
                  </button>
                  <button
                    onClick={() => setAuthMode('signup')}
                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                      authMode === 'signup' 
                        ? 'bg-white text-gray-800 shadow-sm' 
                        : 'text-gray-600 hover:text-gray-800'
                    }`}
                  >
                    Sign Up
                  </button>
                </div>

                {/* Auth Form */}
                <form onSubmit={(e) => authMode === 'signup' ? handleSignup(e, authForm) : handleLogin(e, authForm)} className="space-y-4">
                  {authMode === 'signup' && (
                    <div>
                      <input
                        type="text"
                        placeholder="Family Name (e.g., The Smiths)"
                        value={authForm.familyName || ''}
                        onChange={(e) => setAuthForm({ ...authForm, familyName: e.target.value })}
                        className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                        required
                      />
                    </div>
                  )}

                  <div>
                    <input
                      type="email"
                      placeholder="Email Address"
                      value={authForm.email || ''}
                      onChange={(e) => setAuthForm({ ...authForm, email: e.target.value })}
                      className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                      required
                    />
                  </div>

                  <div>
                    <input
                      type="password"
                      placeholder="Password"
                      value={authForm.password || ''}
                      onChange={(e) => setAuthForm({ ...authForm, password: e.target.value })}
                      className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                      required
                    />
                  </div>

                  {authMode === 'signup' && (
                    <div>
                      <input
                        type="password"
                        placeholder="Confirm Password"
                        value={authForm.confirmPassword || ''}
                        onChange={(e) => setAuthForm({ ...authForm, confirmPassword: e.target.value })}
                        className="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-blue-500 focus:outline-none"
                        required
                      />
                    </div>
                  )}

                  <button
                    type="submit"
                    className="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105"
                  >
                    {authMode === 'signup' ? 'Create Account' : 'Log In'}
                  </button>
                </form>

                {/* Google Login Button */}
                <div className="mt-6">
                  <div className="relative">
                    <div className="absolute inset-0 flex items-center">
                      <div className="w-full border-t border-gray-300" />
                    </div>
                    <div className="relative flex justify-center text-sm">
                      <span className="px-2 bg-white text-gray-500">Or continue with</span>
                    </div>
                  </div>
                  <button
                    onClick={handleGoogleLogin}
                    className="w-full mt-4 bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-200 hover:bg-gray-50 flex items-center justify-center"
                  >
                    <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24">
                      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                  </button>
                </div>

                {/* Continue as Guest Option */}
                <div className="text-center mt-6">
                  <button
                    onClick={() => navigateToPage(PAGES.TASKS)}
                    className="text-gray-500 hover:text-gray-700 text-sm font-medium transition-colors"
                  >
                    Continue as Guest
                  </button>
                </div>

                {/* Back to Tasks Button for Existing Users */}
                <div className="text-center mt-4">
                  <button
                    onClick={() => navigateToPage(PAGES.TASKS)}
                    className="text-blue-500 hover:text-blue-700 text-sm font-medium transition-colors"
                  >
                    â† Back to Tasks
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Show onboarding if not completed
      if (currentPage === PAGES.ONBOARDING) {
        return <OnboardingPage 
          handleSignup={handleSignup} 
          handleLogin={handleLogin} 
          handleGoogleLogin={handleGoogleLogin} 
          navigateToPage={navigateToPage} 
        />;
      }

      // Show login page
      if (currentPage === PAGES.LOGIN) {
        return <LoginPage 
          handleSignup={handleSignup} 
          handleLogin={handleLogin} 
          handleGoogleLogin={handleGoogleLogin} 
          navigateToPage={navigateToPage} 
        />;
      }

      return (
        <div className={`bg-white rounded-lg shadow-lg p-4 sm:p-6 transition-opacity duration-150 ${showPageTransition ? 'opacity-50' : 'opacity-100'}`}>

          {/* Emoji Picker Modal */}
          <EmojiPicker />




          {/* Mobile Footer Navigation */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
            <div className="flex justify-around items-center py-2">
              <button
                onClick={() => navigateToPage(PAGES.TASKS)}
                className={`flex flex-col items-center p-2 rounded-lg ${
                  currentPage === PAGES.TASKS ? "text-green-600" : "text-gray-500"
                }`}
              >
                <div className="text-xl mb-1">âœ…</div>
                <div className="text-xs font-medium">Tasks</div>
              </button>
              <button
                onClick={() => navigateToPage(PAGES.LEADERBOARD)}
                className={`flex flex-col items-center p-2 rounded-lg ${
                  currentPage === PAGES.LEADERBOARD ? "text-green-600" : "text-gray-500"
                }`}
              >
                <div className="text-xl mb-1">ðŸ†</div>
                <div className="text-xs font-medium">Rewards</div>
              </button>
              <button
                onClick={() => navigateToPage(PAGES.SETTINGS)}
                className={`flex flex-col items-center p-2 rounded-lg ${
                  currentPage === PAGES.SETTINGS ? "text-green-600" : "text-gray-500"
                }`}
              >
                <div className="text-xl mb-1">âš™ï¸</div>
                <div className="text-xs font-medium">Settings</div>
              </button>
            </div>
          </div>

          {/* Tasks View - New Mobile-Inspired Layout */}
          {currentPage === PAGES.TASKS && (
            <div className="relative pb-24">
              {/* Profile Selector - Top Left */}
              <div className="mb-4">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center">
                    <div className="flex items-center bg-gray-100 rounded-xl px-3 py-2">
                      <div className="text-2xl mr-2">
                        {(() => {
                          if (!selectedProfile || selectedProfile === "Family") {
                            return "";
                          }
                          const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                          const userIndex = users.findIndex(u => u.name === selectedProfile);
                          return avatarEmojis[userIndex] || "ðŸ‘¤";
                        })()}
                      </div>
                      <div className="relative">
                        <select
                          value={selectedProfile || "Family"}
                          onChange={(e) => {
                            if (e.target.value === "Add Profile") {
                              navigateToPage(PAGES.FAMILY_MEMBERS);
                            } else {
                              setSelectedProfile(e.target.value === "Family" ? null : e.target.value);
                            }
                          }}
                          className="bg-transparent text-lg font-semibold text-gray-800 border-none outline-none cursor-pointer pr-6 appearance-none"
                        >
                          <option value="Family">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family</option>
                          {users.map((user, index) => {
                            const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                            const userAvatar = user.avatar || avatarEmojis[index] || "ðŸ‘¤";
                            return (
                              <option key={user.name} value={user.name}>
                                {userAvatar} {user.name}
                              </option>
                            );
                          })}
                          <option value="Add Profile">âž• Add Profile</option>
                        </select>
                        <div className="absolute right-0 top-1/2 transform -translate-y-1/2 pointer-events-none">
                          <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center bg-gradient-to-r from-yellow-100 to-orange-100 rounded-full px-4 py-2 shadow-sm border border-yellow-200">
                    <span className="text-2xl mr-2 filter drop-shadow-sm">â­</span>
                    <span className="font-bold text-lg text-orange-800">
                      {(() => {
                        if (!selectedProfile || selectedProfile === "Family") {
                          return users.reduce((total, user) => total + user.points, 0);
                        }
                        return users.find(u => u.name === selectedProfile)?.points || 0;
                      })()}
                    </span>
                  </div>
                </div>
              </div>

              {/* Calendar Section */}
              <div className="mb-4">
                <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                  <div className="flex items-center justify-between mb-4">
                    <button
                      onClick={() => {
                        const newDate = new Date(selectedDate);
                        newDate.setDate(selectedDate.getDate() - 7);
                        setSelectedDate(newDate);
                      }}
                      className="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-600 transition-colors"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                      </svg>
                    </button>

                    <div className="text-center">
                      <h3 className="text-lg font-bold text-gray-800">
                        {selectedDate.toDateString() === new Date().toDateString() ? 
                          `Today, ${selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}` : 
                          selectedDate.toLocaleDateString('en-US', { 
                            weekday: 'short',
                            month: 'short', 
                            day: 'numeric' 
                          })
                        }
                      </h3>
                    </div>

                    <button
                      onClick={() => {
                        const newDate = new Date(selectedDate);
                        newDate.setDate(selectedDate.getDate() + 7);
                        setSelectedDate(newDate);
                      }}
                      className="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-600 transition-colors"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                      </svg>
                    </button>
                  </div>

                  <div className="flex justify-between items-center text-center">
                    {(() => {
                      const weekDays = [];
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());

                      const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const isToday = day.toDateString() === new Date().toDateString();
                        const isSelected = day.toDateString() === selectedDate.toDateString();
                        const dayNumber = day.getDate();

                        weekDays.push(
                          <button
                            key={i}
                            onClick={() => setSelectedDate(new Date(day))}
                            className={`flex flex-col items-center p-2 rounded-xl min-w-[40px] ${
                              isSelected 
                                ? "bg-orange-500 text-white" 
                                : isToday 
                                ? "bg-orange-100 text-orange-600 ring-2 ring-orange-300" 
                                : "text-gray-500 hover:bg-gray-100"
                            }`}
                          >
                            <div className="text-xs font-medium mb-1">{dayNames[i]}</div>
                            <div className="text-lg font-bold">{dayNumber}</div>
                          </button>
                        );
                      }
                      return weekDays;
                    })()}
                  </div>
                </div>
              </div>

              {/* Tasks Section */}
              <div className="mb-4">
                {(() => {
                  const allTodayTasks = getTasksForDay(getCurrentDayName());
                  const todayTasks = !selectedProfile || selectedProfile === "Family" 
                    ? allTodayTasks 
                    : allTodayTasks.filter(t => t.assignee === selectedProfile);

                  if (todayTasks.length === 0) {
                    return (
                      <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center text-gray-500">
                        <div className="text-3xl mb-2">ðŸŽ‰</div>
                        <p>No tasks for today!</p>
                      </div>
                    );
                  }

                  return (
                    <div className="space-y-3">
                      {todayTasks.map(task => (
                        <div key={task.id} className={`rounded-2xl shadow-sm border p-4 ${
                          isTaskCompleted(task.id, selectedDate) 
                            ? "bg-green-100 border-green-300" 
                            : "bg-white border-gray-100"
                        }`}>
                          <div className="flex items-center">
                            <button
                              onClick={() => toggleTask(task)}
                              disabled={isNotToday(selectedDate)}
                              className={`w-8 h-8 rounded-full mr-4 flex items-center justify-center ${
                                isTaskCompleted(task.id, selectedDate)
                                  ? "bg-green-500 text-white"
                                  : "bg-gray-200 text-gray-400"
                              } ${isNotToday(selectedDate) ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                            >
                              {isTaskCompleted(task.id, selectedDate) ? "âœ“" : ""}
                            </button>

                            <div className="flex items-center flex-1">
                              <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <span className="text-lg">{getTaskEmoji(task.name, task.emoji)}</span>
                              </div>
                              <div className="flex-1">
                                <div className={`font-medium text-gray-800 ${isTaskCompleted(task.id, selectedDate) ? "line-through" : ""}`}>
                                  {task.name}
                                </div>
                                <div className="text-xs mt-1 flex items-center gap-2">
                                  {(!selectedProfile || selectedProfile === "Family") && (
                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${getPersonColor(task.assignee)}`}>
                                      {task.assignee}
                                    </span>
                                  )}

                                  <span className="text-gray-500">
                                    {task.daysOfWeek && task.daysOfWeek.length === 7 
                                      ? "Daily" 
                                      : task.daysOfWeek 
                                        ? task.daysOfWeek.map(d => d.slice(0, 3)).join(", ")
                                        : task.frequency === "Daily" 
                                          ? "Daily" 
                                          : "Custom"
                                    }
                                  </span>
                                </div>
                              </div>
                              <div className="flex items-center bg-gradient-to-r from-yellow-100 to-orange-100 rounded-full px-3 py-1 shadow-sm border border-yellow-200">
                                <span className="text-lg mr-1 filter drop-shadow-sm">â­</span>
                                <span className="font-bold text-orange-800 text-sm">{task.points}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  );
                })()}
              </div>

              {/* Profile Header for Individual Members - Bottom Section */}
              {selectedProfile && selectedProfile !== "Family" && (
                <div className="mt-6">
                  {(() => {
                    const user = users.find(u => u.name === selectedProfile);
                    const userIndex = users.findIndex(u => u.name === selectedProfile);
                    const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                    const colors = ["bg-blue-50 border-blue-200", "bg-purple-50 border-purple-200", "bg-orange-50 border-orange-200", "bg-pink-50 border-pink-200"];
                    const userTasks = tasks.filter(t => t.assignee === selectedProfile);
                    const todayTasks = userTasks.filter(t => getTasksForDay(getCurrentDayName()).includes(t));
                    const completedTasks = todayTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                    const completionRate = todayTasks.length ? Math.round((completedTasks.length / todayTasks.length) * 100) : 0;

                    if (!user) return null;

                    return (
                      <div className={`${colors[userIndex]} border-2 p-4 rounded-2xl shadow-lg mb-4`}>
                        <div className="grid grid-cols-3 gap-3 mb-4">
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-2xl font-bold text-green-600">{completionRate}%</div>
                            <div className="text-xs text-gray-600">Today's Progress</div>
                          </div>
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-2xl font-bold text-blue-600">{todayTasks.length}</div>
                            <div className="text-xs text-gray-600">Today's Tasks</div>
                          </div>
                          <div className="bg-white p-3 rounded-xl text-center shadow-sm">
                            <div className="text-2xl font-bold text-yellow-600">{user.badges.length}</div>
                            <div className="text-xs text-gray-600">Badges</div>
                          </div>
                        </div>

                        {/* Progress Bar */}
                        <div className="mb-4">
                          <div className="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Today's Progress</span>
                            <span>{completedTasks.length}/{todayTasks.length}</span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-3">
                            <div 
                              className="bg-green-500 h-3 rounded-full transition-all duration-500" 
                              style={{ width: `${completionRate}%` }}
                            ></div>
                          </div>
                        </div>

                        {/* Recent Badges */}
                        {user.badges.length > 0 && (
                          <div>
                            <div className="text-sm font-semibold text-gray-700 mb-2">ðŸ† Recent Badges:</div>
                            <div className="flex flex-wrap gap-2">
                              {user.badges.slice(0, 4).map((badge, badgeIndex) => (
                                <span key={badgeIndex} className="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full border border-yellow-300">
                                  <span className="mr-1">{badgeDefinitions[badge]?.emoji || "ðŸ…"}</span>
                                  <span>{badge}</span>
                                </span>
                              ))}
                              {user.badges.length > 4 && (
                                <span className="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full">
                                  +{user.badges.length - 4} more
                                </span>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </div>
              )}


            </div>
          )}

          {/* Calendar View */}
          {view === "calendar" && (
            <div className="pb-20">
              <div className="text-center mb-4">
                <h2 className="text-lg sm:text-xl font-bold mb-2 text-green-700">ðŸ“… Family Calendar</h2>
                <p className="text-xs sm:text-sm text-gray-600">Navigate through days</p>
              </div>
              <div className="bg-blue-50 p-3 rounded-lg mb-4">
                <div className="flex items-center justify-between mb-3">
                  <button 
                    onClick={() => {
                      const newDate = new Date(selectedDate);
                      newDate.setDate(selectedDate.getDate() - selectedDate.getDay() -1);
                      setSelectedDate(newDate);
                    }}
                    className="bg-green-500 text-white px-3 py-1 rounded-lg text-xs sm:text-sm min-h-[40px]"
                  >
                    â† Prev
                  </button>
                  <div className="text-center">
                    <h3 className="text-sm font-bold text-green-800">
                      {selectedDate.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' })}
                    </h3>
                    <p className="text-xs text-green-600">
                      {selectedDate.toDateString() === new Date().toDateString() ? 
                        "Today" : 
                        selectedDate < new Date() ? "Past" : "Future"}
                    </p>
                  </div>
                  <button 
                    onClick={() => {
                      const newDate = new Date(selectedDate);
                      newDate.setDate(selectedDate.getDate() + 1);
                      setSelectedDate(newDate);
                    }}
                    className="bg-green-500 text-white px-3 py-1 rounded-lg text-xs sm:text-sm min-h-[40px]"
                  >
                    Next â†’
                  </button>
                </div>
                <div className="flex justify-center gap-1 flex-wrap">
                  <button 
                    onClick={() => setSelectedDate(new Date())}
                    className="bg-blue-500 text-white px-2 py-1 rounded text-xs min-h-[40px]"
                  >
                    Today
                  </button>
                  <button 
                    onClick={() => {
                      const yesterday = new Date();
                      yesterday.setDate(yesterday.getDate() - 1);
                      setSelectedDate(yesterday);
                    }}
                    className="bg-gray-500 text-white px-2 py-1 rounded text-xs min-h-[40px]"
                  >
                    Yesterday
                  </button>
                  <button 
                    onClick={() => {
                      const tomorrow = new Date();
                      tomorrow.setDate(tomorrow.getDate() + 1);
                      setSelectedDate(tomorrow);
                    }}
                    className="bg-orange-500 text-white px-2 py-1 rounded text-xs min-h-[40px]"
                  >
                    Tomorrow
                  </button>
                </div>
              </div>
              <div className="bg-white p-3 rounded-lg mb-4 border-2 border-green-200 overflow-x-auto">
                <h3 className="text-sm font-bold text-green-800 mb-2 text-center">Week Overview</h3>
                <div className="grid grid-cols-7 gap-1 min-w-[200px]">
                  {(() => {
                    const weekDays = [];
                    const startOfWeek = new Date(selectedDate);
                    startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                    for (let i = 0; i < 7; i++) {
                      const day = new Date(startOfWeek);
                      day.setDate(startOfWeek.getDate() + i);
                      const isToday = day.toDateString() === new Date().toDateString();
                      const isSelected = day.toDateString() === selectedDate.toDateString();
                      const dayName = day.toLocaleDateString('en-US', { weekday: 'short' });
                      const dayNumber = day.getDate();
                      weekDays.push(
                        <button
                          key={i}
                          onClick={() => setSelectedDate(new Date(day))}
                          className={`p-1 rounded-lg text-center text-xs ${
                            isSelected 
                              ? "bg-green-500 text-white" 
                              : isToday 
                                ? "bg-blue-100 border-2 border-blue-300" 
                                : "bg-gray-50 hover:bg-gray-100"
                          }`}
                        >
                          <div>{dayName}</div>
                          <div className="font-bold">{dayNumber}</div>
                        </button>
                      );
                    }
                    return weekDays;
                  })()}
                </div>
              </div>

              <div className="mt-6 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl border-2 border-green-200">
                <h3 className="text-base sm:text-lg font-bold text-green-800 mb-3 text-center">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Family Summary</h3>
                <div className="grid grid-cols-2 gap-2 text-center text-xs sm:text-sm">
                  <div className="bg-white p-2 rounded-lg">
                    <div className="text-lg sm:text-xl font-bold text-blue-600">{(() => {
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                      let totalWeeklyTasks = 0;
                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                        totalWeeklyTasks += getTasksForDay(dayName).length;
                      }
                      return totalWeeklyTasks;
                    })()}</div>
                    <div className="text-xs text-gray-600">Total Tasks</div>
                  </div>
                  <div className="bg-white p-2 rounded-lg">
                    <div className="text-lg sm:text-xl font-bold text-green-600">{(() => {
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                      let completedWeeklyTasks = 0;
                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                        const dayTasks = getTasksForDay(dayName);
                        completedWeeklyTasks += dayTasks.filter(t => isTaskCompleted(t.id, day)).length;
                      }
                      return completedWeeklyTasks;
                    })()}</div>
                    <div className="text-xs text-gray-600">Completed</div>
                  </div>
                  <div className="bg-white p-2 rounded-lg">
                    <div className="text-lg sm:text-xl font-bold text-yellow-600">{(() => {
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                      let weeklyPoints = 0;
                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                        const dayTasks = getTasksForDay(dayName);
                        dayTasks.forEach(task => {
                          if (isTaskCompleted(task.id, day)) {
                            weeklyPoints += task.points;
                          }
                        });
                      }
                      return weeklyPoints;
                    })()}</div>
                    <div className="text-xs text-gray-600">Total Points</div>
                  </div>
                  <div className="bg-white p-2 rounded-lg">
                    <div className="text-lg sm:text-xl font-bold text-purple-600">{(() => {
                      const startOfWeek = new Date(selectedDate);
                      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                      let totalWeeklyTasks = 0;
                      let completedWeeklyTasks = 0;
                      for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);
                        const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                        const dayTasks = getTasksForDay(dayName);
                        totalWeeklyTasks += dayTasks.length;
                        completedWeeklyTasks += dayTasks.filter(t => isTaskCompleted(t.id, day)).length;
                      }
                      return totalWeeklyTasks ? Math.round((completedWeeklyTasks / totalWeeklyTasks) * 100) : 0;
                    })()}%</div>
                    <div className="text-xs text-gray-600">Progress</div>
                  </div>
                </div>
              </div>
              <div className="bg-blue-50 p-3 rounded-lg mb-4 text-center text-xs">
                <div className="text-blue-600 mb-1">
                  {selectedDate.toDateString() === new Date().toDateString() ? 
                    "ðŸ“ Current Day" :
                    selectedDate < new Date() ? 
                    "ðŸ“… Past Day" : 
                    "ðŸ”® Future Day"}
                </div>
                <div className="text-gray-600">
                  {selectedDate < new Date() ? 
                    "Showing past tasks" :
                    selectedDate.toDateString() === new Date().toDateString() ?
                    "Complete tasks today" :
                    "Plan upcoming tasks"}
                </div>
              </div>
              <div className="grid grid-cols-1 gap-4">
                {users.map((user, index) => {
                  const userTasks = tasks.filter(t => t.assignee === user.name);
                  const completedTasks = userTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                  const dailyTasks = userTasks.filter(t => t.frequency === "Daily");
                  const customTasks = userTasks.filter(t => t.frequency !== "Daily");
                  const completedDaily = dailyTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                  const completedCustom = customTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                  const colors = ["bg-blue-50 border-blue-200", "bg-purple-50 border-purple-200", "bg-orange-50 border-orange-200", "bg-pink-50 border-pink-200"];
                  const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                  const dateContext = selectedDate.toDateString() === new Date().toDateString() ? 
                    "" : selectedDate < new Date() ? " (Past)" : " (Future)";

                  return (
                    <div key={user.name} className={`${colors[index]} border-2 p-4 rounded-xl shadow-lg`}>
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center">
                          <div className="text-2xl sm:text-3xl mr-2">{avatarEmojis[index]}</div>
                          <div>
                            <h4 className="text-base sm:text-lg font-semibold text-gray-800">{user.name}{dateContext}</h4>
                            <p className="text-xs text-gray-600">{user.points} pts</p>
                          </div>
                        </div>
                        <div className="text-center">
                          <div className="text-lg font-bold text-green-600">{userTasks.length ? Math.round((completedTasks.length / userTasks.length) * 100) : 0}%</div>
                          <div className="text-xs text-gray-500">Complete</div>
                        </div>
                      </div>
                      <div className="mb-3">
                        <div className="flex justify-between text-xs sm:text-sm text-gray-600 mb-1">
                          <span>Progress</span>
                          <span>{completedTasks.length}/{userTasks.length}</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div 
                            className="bg-green-500 h-2 rounded-full transition-all duration-500" 
                            style={{ width: `${userTasks.length ? (completedTasks.length / userTasks.length) * 100 : 0}%` }}
                          ></div>
                        </div>
                      </div>
                      {dailyTasks.length > 0 && (
                        <div className="mb-3">
                          <div className="flex items-center justify-between mb-1">
                            <h4 className="font-semibold text-blue-700 text-sm">ðŸŒ… Daily Tasks</h4>
                            <span className="text-xs bg-blue-200 px-1 py-0.5 rounded-full">{completedDaily.length}/{dailyTasks.length}</span>
                          </div>
                          <div className="space-y-1">
                            {dailyTasks.map(task => (
                              <div key={task.id} className={`flex items-center p-2 rounded-lg text-xs sm:text-sm min-h-[48px] ${
                                isTaskCompleted(task.id, selectedDate)
                                  ? "bg-green-100 text-green-800" 
                                  : "bg-white border border-blue-100"
                              }`}>
                                <div className={`w-4 h-4 rounded-full mr-2 flex items-center justify-center text-xs ${
                                  isTaskCompleted(task.id, selectedDate) ? "bg-green-500 text-white" : "bg-gray-200"
                                }`}>
                                  {isTaskCompleted(task.id, selectedDate) ? "âœ“" : ""}
                                </div>
                                <span className="mr-1">{getTaskEmoji(task.name, task.emoji)}</span>
                                <span className={isTaskCompleted(task.id, selectedDate) ? "line-through" : ""}>{task.name}</span>
                                <span className="ml-auto text-yellow-600">{task.points}pts</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {customTasks.length > 0 && (
                        <div>
                          <div className="flex items-center justify-between mb-1">
                            <h4 className="font-semibold text-purple-700 text-sm">ðŸ“… Custom Tasks</h4>
                            <span className="text-xs bg-purple-200 px-1 py-0.5 rounded-full">{completedCustom.length}/{customTasks.length}</span>
                          </div>
                          <div className="space-y-1">
                            {customTasks.map(task => (
                              <div key={task.id} className={`flex items-center p-2 rounded-lg text-xs sm:text-sm min-h-[48px] ${
                                isTaskCompleted(task.id, selectedDate)
                                  ? "bg-green-100 text-green-800" 
                                  : "bg-white border border-purple-100"
                              }`}>
                                <div className={`w-4 h-4 rounded-full mr-2 flex items-center justify-center text-xs ${
                                  isTaskCompleted(task.id, selectedDate) ? "bg-green-500 text-white" : "bg-gray-200"
                                }`}>
                                  {isTaskCompleted(task.id, selectedDate) ? "âœ“" : ""}
                                </div>
                                <span className="mr-1">{getTaskEmoji(task.name, task.emoji)}</span>
                                <span className={isTaskCompleted(task.id, selectedDate) ? "line-through" : ""}>{task.name}</span>
                                <span className="ml-auto text-yellow-600">{task.points}pts</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      {userTasks.length === 0 && (
                        <div className="text-center py-3 text-gray-500">
                          <div className="text-lg mb-1">ðŸŽ‰</div>
                          <p className="text-xs">No tasks assigned!</p>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
              <div className="mt-4 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl border-2 border-green-200">
                <h3 className="text-base sm:text-lg font-semibold text-green-800 mb-2 text-center">Family Summary</h3>
                <div className="grid grid-cols-2 gap-2 text-center text-xs sm:text-sm">
                  <div className="bg-white p-1 rounded-lg">
                    <div className="text-sm sm:text-lg font-bold text-blue-600">{tasks.length}</div>
                    <div className="text-xs">Total</div>
                  </div>
                  <div className="bg-white p-1 rounded-lg">
                    <div className="text-sm sm:text-lg font-bold text-green-600">{tasks.filter(t => isTaskCompleted(t.id, selectedDate)).length}</div>
                    <div className="text-xs">Done</div>
                  </div>
                  <div className="bg-white p-1 rounded-lg">
                    <div className="text-sm sm:text-lg font-bold text-yellow-600">{tasks.reduce((sum, task) => sum + (isTaskCompleted(task.id, selectedDate) ? task.points : 0), 0)}</div>
                    <div className="text-xs">Points</div>
                  </div>
                  <div className="bg-white p-1 rounded-lg">
                    <div className="text-sm sm:text-lg font-bold text-purple-600">{completionRate()}%</div>
                    <div className="text-xs">Progress</div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Leaderboard View */}
          {currentPage === PAGES.LEADERBOARD && (
            <div className="pb-20">
              <div className="text-center mb-4">
                <h2 className="text-lg sm:text-xl font-bold text-green-700">ðŸ† Rewards</h2>
                <div className="text-sm text-gray-600 mt-1">
                  {(() => {
                    const startOfWeek = new Date();
                    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);

                    return `Week of ${startOfWeek.toLocaleDateString('en-US', { 
                      month: 'short', 
                      day: 'numeric' 
                    })} - ${endOfWeek.toLocaleDateString('en-US', { 
                      month: 'short', 
                      day: 'numeric',
                      year: 'numeric'
                    })}`;
                  })()}
                </div>
              </div>
              <div className="mb-6">
                <ul className="grid grid-cols-1 gap-2">
                  {users
                    .sort((a, b) => b.points - a.points)
                    .map((user, index) => (
                      <li key={user.name} className="border-2 p-3 rounded-lg bg-gradient-to-r from-white to-green-50">
                        <div className="flex flex-col sm:flex-row justify-between">
                          <div className="flex-1">
                            <div className="flex items-center mb-2">
                              <span className="text-lg sm:text-xl mr-2">
                                {index === 0 ? "ðŸ¥‡" : index === 1 ? "ðŸ¥ˆ" : index === 2 ? "ðŸ¥‰" : "ðŸŽ¯"}
                              </span>
                              <span className="font-bold text-sm sm:text-base">{user.name}</span>
                              <div className="ml-2 flex items-center bg-gradient-to-r from-yellow-100 to-orange-100 rounded-full px-2 py-1 shadow-sm border border-yellow-200">
                                <span className="text-lg mr-1 filter drop-shadow-sm">â­</span>
                                <span className="font-bold text-orange-800 text-xs sm:text-sm">{user.points}</span>
                              </div>
                            </div>

                            <div>
                              <span className="text-xs font-semibold text-gray-700">Badges ({user.badges.length}):</span>
                              <div className="flex flex-wrap gap-1 mt-1">
                                {user.badges.length ? user.badges.map(badge => (
                                  <span key={badge} className="inline-flex items-center px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full border border-yellow-300">
                                    <span className="mr-1">{badgeDefinitions[badge]?.emoji || "ðŸ…"}</span>
                                    <span>{badge}</span>
                                  </span>
                                )) : (
                                  <span className="text-gray-400 text-xs">No badges yet</span>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      </li>
                    ))}
                </ul>
              </div>




            </div>
          )}

          {/* Badge Editor View */}
          {currentPage === PAGES.BADGE_EDITOR && (
            <div className="pb-20">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg sm:text-xl font-bold text-green-700">ðŸŽ–ï¸ Add/Edit Badges</h2>
                <button
                  onClick={() => navigateToPage(PAGES.LEADERBOARD)}
                  className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
                >
                  â† Back
                </button>
              </div>
              <div className="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                <h3 className="text-base sm:text-lg font-semibold text-yellow-800 mb-3">âž• New Badge</h3>
                <form onSubmit={addCustomBadge} className="space-y-2">
                  <div className="grid grid-cols-1 gap-2">
                    <input
                      type="text"
                      placeholder="Badge Name"
                      value={newCustomBadge.name}
                      onChange={(e) => setNewCustomBadge({ ...newCustomBadge, name: e.target.value })}
                      className="w-full border border-gray-200 p-2 rounded-lg focus:border-yellow-400 text-sm"
                      required
                    />
                    <input
                      type="text"
                      placeholder="Description"
                      value={newCustomBadge.description}
                      onChange={(e) => setNewCustomBadge({ ...newCustomBadge, description: e.target.value })}
                      className="w-full border border-gray-200 p-2 rounded-lg focus:border-yellow-400 text-sm"
                      required
                    />                    <div>
                      <label className="block text-xs font-semibold mb-1">Stars:</label>
                      <input
                        type="number"
                        placeholder="0"
                        min="0"
                        value={newCustomBadge.points === 0 ? '' : (newCustomBadge.points || '')}
                        onChange={(e) => setNewCustomBadge({ ...newCustomBadge, points: e.target.value === '' ? 0 : Number(e.target.value) })}
                        className="w-full border border-gray-200 p-2 rounded-lg focus:border-yellow-400 text-sm"
                      />
                      <div className="text-xs text-yellow-700 mt-1">Set to 0 if no stars required</div>
                    </div>
                    <div>
                      <label className="block text-xs font-semibold mb-1">Emoji:</label>
                      <button
                        type="button"
                        onClick={() => openEmojiPicker('newBadge')}
                        className="w-full border border-gray-200 p-2 rounded-lg focus:border-yellow-400 text-sm flex items-center justify-between"
                      >
                        <div className="flex items-center">
                          {newCustomBadge.emoji && <span className="text-lg mr-2">{newCustomBadge.emoji}</span>}
                          <span className={newCustomBadge.emoji ? "text-gray-800" : "text-gray-500"}>
                            {newCustomBadge.emoji ? "Change Emoji" : "Choose Emoji"}
                          </span>
                        </div>
                        <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>
                    </div>
                    <button 
                      type="submit" 
                      className="w-full bg-yellow-500 text-white p-2 rounded-lg text-sm font-semibold min-h-[48px]"
                    >
                      Create Badge
                    </button>
                  </div>
                </form>
              </div>
              <div className="bg-white p-4 rounded-lg border border-gray-200">
                <h3 className="text-base sm:text-lg font-semibold text-gray-800 mb-3">All Badges</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs sm:text-sm">
                  {Object.entries(badgeDefinitions).map(([badgeName, badgeInfo]) => (
                    <div key={badgeName} className={`border ${badgeInfo.isCustom ? "bg-blue-50 border-blue-200" : "bg-white border-gray-200"}`}>
                      {editingBadge === badgeName ? (
                        <div className="p-3 space-y-2">
                          <div className="grid grid-cols-1 gap-2">
                            <input
                              type="text"
                              value={badgeInfo.emoji}
                              onChange={(e) => updateBadge(badgeName, { ...badgeInfo, emoji: e.target.value })}
                              className="w-full border p-2 rounded text-lg text-center"
                              maxLength="4"
                            />
                            <input
                              type="text"
                              value={badgeInfo.description}
                              onChange={(e) => updateBadge(badgeName, { ...badgeInfo, description: e.target.value })}
                              className="w-full border p-2 rounded text-sm"
                            />
                            <input
                              type="number"
                              min="0"
                              value={badgeInfo.points === 0 ? '' : (badgeInfo.points || '')}
                              onChange={(e) => updateBadge(badgeName, { ...badgeInfo, points: e.target.value === '' ? 0 : Number(e.target.value) })}
                              className="w-full border p-2 rounded text-sm"
                            />
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => setEditingBadge(null)}
                              className="w-full bg-green-500 text-white px-2 py-1 rounded text-xs sm:text-sm min-h-[40px]"
                            >
                              Save
                            </button>
                            <button
                              onClick={() => setEditingBadge(null)}
                              className="w-full bg-gray-500 text-white px-2 py-1 rounded text-xs sm:text-sm min-h-[40px]"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="flex items-center p-2 rounded relative">
                          <span className="text-base sm:text-lg mr-2">{badgeInfo.emoji}</span>
                          <div className="flex-1">
                            <div className="font-semibold text-xs">{badgeName}</div>
                            <div className="text-gray-600 text-xs">{badgeInfo.description}</div>
                            {badgeInfo.points > 0 && (
                              <div className="text-yellow-600 text-xs">{badgeInfo.points} â­</div>
                            )}

                          </div>
                          <div className="absolute top-1 right-1 flex gap-1">
                            <button
                              onClick={() => setEditingBadge(badgeName)}
                              className="bg-blue-500 text-white px-1 py-1 rounded text-xs min-h-[24px] min-w-[24px]"
                            >
                              âœï¸
                            </button>
                            <button
                              onClick={() => deleteBadge(badgeName)}
                              className="bg-red-500 text-white px-1 py-1 rounded text-xs min-h-[24px] min-w-[24px]"
                            >
                              ðŸ—‘ï¸
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Profile View */}
          {currentPage === PAGES.PROFILE && selectedProfile && (
            <div className="pb-20">
              {(() => {
                const user = users.find(u => u.name === selectedProfile);
                const userIndex = users.findIndex(u => u.name === selectedProfile);
                const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                const colors = ["bg-blue-50 border-blue-200", "bg-purple-50 border-purple-200", "bg-orange-50 border-orange-200", "bg-pink-50 border-pink-200"];
                const userTasks = tasks.filter(t => t.assignee === selectedProfile);
                const todayTasks = userTasks.filter(t => getTasksForDay(getCurrentDayName()).includes(t));
                const completedTasks = todayTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                const completionRate = todayTasks.length ? Math.round((completedTasks.length / todayTasks.length) * 100) : 0;

                if (!user) return <div>Profile not found</div>;

                return (
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h2 className="text-lg sm:text-xl font-bold text-green-700">ðŸ‘¤ {user.name}'s Profile</h2>
                      <button
                        onClick={() => navigateToPage(PAGES.TASKS)}
                        className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
                      >
                        â† Back
                      </button>
                    </div>

                    {/* Profile Card */}
                    <div className={`${colors[userIndex]} border-2 p-6 rounded-xl shadow-lg mb-6`}>
                      {editingProfile ? (
                        <div className="space-y-4">
                          <div className="text-center">
                            <h3 className="text-lg font-bold text-gray-800 mb-4">Edit Profile</h3>
                            <div className="mb-4">
                              <label className="block text-sm font-semibold mb-2">Avatar Emoji:</label>
                              <div className="relative">
                                <select
                                  value={avatarEmojis[userIndex]}
                                  onChange={(e) => {
                                    // This would require updating the avatar system
                                    alert("Avatar customization coming soon!");
                                  }}
                                  className="w-full sm:w-32 border border-gray-200 p-2 rounded-lg text-center text-xl pr-8 appearance-none"
                                >
                                  {["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦", "ðŸ‘§", "ðŸ§’", "ðŸ™‹â€â™€ï¸", "ðŸ™‹â€â™‚ï¸", "ðŸ¤·â€â™€ï¸", "ðŸ¤·â€â™‚ï¸"].map((emoji, idx) => (
                                    <option key={idx} value={emoji}>{emoji}</option>
                                  ))}
                                </select>
                                <div className="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                  <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                  </svg>
                                </div>
                              </div>
                            </div>
                            <div className="mb-4">
                              <label className="block text-sm font-semibold mb-2">Name:</label>
                              <input
                                type="text"
                                value={user.name}
                                onChange={(e) => {
                                  const updatedUsers = users.map(u => 
                                    u.name === selectedProfile ? { ...u, name: e.target.value } : u
                                  );
                                  setUsers(updatedUsers);
                                }}
                                className="w-full sm:w-48 border border-gray-200 p-2 rounded-lg text-center"
                              />
                            </div>
                            <div className="flex gap-2 justify-center">
                              <button
                                onClick={() => setEditingProfile(false)}
                                className="bg-green-500 text-white px-4 py-2 rounded-lg text-sm"
                              >
                                âœ… Save
                              </button>
                              <button
                                onClick={() => setEditingProfile(false)}
                                className="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm"
                              >
                                âŒ Cancel
                              </button>
                            </div>
                          </div>
                        </div>
                      ) : (
                        <div>
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center">
                              <div className="text-4xl mr-4">{avatarEmojis[userIndex]}</div>
                              <div>
                                <h3 className="text-xl font-bold text-gray-800">{user.name}</h3>
                                <p className="text-gray-600">{user.points} points this week</p>
                              </div>
                            </div>
                            <button
                              onClick={() => setEditingProfile(true)}
                              className="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm"
                            >
                              âœï¸ Edit
                            </button>
                          </div>

                          <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-white p-3 rounded-lg text-center">
                              <div className="text-2xl font-bold text-green-600">{completionRate}%</div>
                              <div className="text-xs text-gray-600">Today's Progress</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg text-center">
                              <div className="text-2xl font-bold text-yellow-600">{user.badges.length}</div>
                              <div className="text-xs text-gray-600">Badges Earned</div>
                            </div>
                          </div>

                          {user.badges.length > 0 && (
                            <div className="mb-4">
                              <h4 className="text-sm font-semibold text-gray-700 mb-2">ðŸ† Badges:</h4>
                              <div className="flex flex-wrap gap-2">
                                {user.badges.map((badge, badgeIndex) => (
                                  <span key={badgeIndex} className="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full border border-yellow-300">
                                    <span className="mr-1">{badgeDefinitions[badge]?.emoji || "ðŸ…"}</span>
                                    {badge}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* User's Tasks */}
                    <div className="bg-white p-4 rounded-lg border border-gray-200">
                      <h3 className="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ My Tasks</h3>

                      {/* Today's Tasks */}
                      <div className="mb-6">
                        <h4 className="text-md font-semibold text-blue-700 mb-3">
                          ðŸŒ… Today ({selectedDate.toLocaleDateString('en-US', { 
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric' 
                          })})
                        </h4>
                        {todayTasks.length > 0 ? (
                          <div className="space-y-2">
                            {todayTasks.map(task => (
                              <div key={task.id} className={`flex items-center p-3 rounded-lg border-2 ${
                                isTaskCompleted(task.id, selectedDate)
                                  ? "bg-green-100 border-green-300 text-green-800" 
                                  : "bg-white border-gray-200"
                              }`}>
                                <div className={`w-5 h-5 rounded-full mr-3 flex items-center justify-center text-sm ${
                                  isTaskCompleted(task.id, selectedDate) ? "bg-green-500 text-white" : "bg-gray-200"
                                }`}>
                                  {isTaskCompleted(task.id, selectedDate) ? "âœ“" : ""}
                                </div>
                                <div className="flex items-center flex-1">
                                  <span className="text-lg mr-2">{getTaskEmoji(task.name, task.emoji)}</span>
                                  <div className="flex-1">
                                    <div className={`font-semibold text-sm ${isTaskCompleted(task.id, selectedDate) ? "line-through" : ""}`}>
                                      {task.name}
                                    </div>
                                    <div className="text-xs text-gray-600">
                                      <span className="text-yellow-600 font-medium">{task.points} pts</span>
                                      {task.daysOfWeek && task.daysOfWeek.length < 7 && (
                                        <span className="ml-2 text-blue-600">
                                          {task.daysOfWeek.map(d => d.slice(0, 3)).join(", ")}
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div className="text-center py-4 text-gray-500">
                            <div className="text-2xl mb-2">ðŸŽ‰</div>
                            <p className="text-sm">No tasks for today!</p>
                          </div>
                        )}
                      </div>

                      {/* Weekly Tasks */}
                      <div className="mb-6">
                        <h4 className="text-md font-semibold text-green-700 mb-3">ðŸ“… This Week's Tasks</h4>
                        <div className="space-y-3">
                          {(() => {
                            const weekDays = [];
                            const startOfWeek = new Date(selectedDate);
                            startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());

                            for (let i = 0; i < 7; i++) {
                              const day = new Date(startOfWeek);
                              day.setDate(startOfWeek.getDate() + i);
                              const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                              const dayTasks = userTasks.filter(t => {
                                if (!t.daysOfWeek) return t.frequency === "Daily";
                                return t.daysOfWeek.includes(dayName);
                              });

                              const isToday = day.toDateString() === new Date().toDateString();
                              const isPast = day < new Date() && !isToday;
                              const isFuture = day > new Date();

                              let dayStatus = "Today";
                              let dayColor = "bg-blue-50 border-blue-200";
                              if (isPast) {
                                dayStatus = "Past";
                                dayColor = "bg-gray-50 border-gray-200";
                              } else if (isFuture) {
                                dayStatus = "Future";
                                dayColor = "bg-yellow-50 border-yellow-200";
                              }

                              const completedCount = dayTasks.filter(t => isTaskCompleted(t.id, day)).length;
                              const completionRate = dayTasks.length ? Math.round((completedCount / dayTasks.length) * 100) : 0;

                              weekDays.push(
                                <div key={i} className={`${dayColor} border-2 p-3 rounded-lg`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center">
                                      <h5 className="font-semibold text-sm">
                                        {day.toLocaleDateString('en-US', { 
                                          weekday: 'short', 
                                          month: 'short', 
                                          day: 'numeric' 
                                        })}
                                      </h5>
                                      <span className={`ml-2 px-2 py-0.5 rounded-full text-xs ${
                                        isToday ? "bg-blue-200 text-blue-800" :
                                        isPast ? "bg-gray-200 text-gray-700" :
                                        "bg-yellow-200 text-yellow-800"
                                      }`}>
                                        {dayStatus}
                                      </span>
                                    </div>
                                    <div className="text-right">
                                      <div className="text-sm font-bold text-green-600">{completionRate}%</div>
                                      <div className="text-xs text-gray-500">{completedCount}/{dayTasks.length}</div>
                                    </div>
                                  </div>

                                  {dayTasks.length > 0 ? (
                                    <div className="space-y-1">
                                      {dayTasks.map(task => (
                                        <div key={`${task.id}-${i}`} className={`flex items-center p-2 rounded text-xs ${
                                          isTaskCompleted(task.id, day)
                                            ? "bg-green-100 text-green-800" 
                                            : "bg-white border border-gray-100"
                                        }`}>
                                          <div className={`w-3 h-3 rounded-full mr-2 flex items-center justify-center text-xs ${
                                            isTaskCompleted(task.id, day) ? "bg-green-500 text-white" : "bg-gray-300"
                                          }`}>
                                            {isTaskCompleted(task.id, day) ? "âœ“" : ""}
                                          </div>
                                          <span className="mr-1">{getTaskEmoji(task.name, task.emoji)}</span>
                                          <span className={`flex-1 ${isTaskCompleted(task.id, day) ? "line-through" : ""}`}>
                                            {task.name}
                                          </span>
                                          <span className="text-yellow-600 font-medium">{task.points}pts</span>
                                        </div>
                                      ))}
                                    </div>
                                  ) : (
                                    <div className="text-center py-2 text-gray-500">
                                      <span className="text-xs">No tasks</span>
                                    </div>
                                  )}
                                </div>
                              );
                            }
                            return weekDays;
                          })()}
                        </div>
                      </div>

                    </div>

                    {/* Profile Summary Section */}
                    {(() => {
                      const currentUserIndex = users.findIndex(u => u.name === selectedProfile);
                      const colors = ["bg-blue-50 border-blue-200", "bg-purple-50 border-purple-200", "bg-orange-50 border-orange-200", "bg-pink-50 border-pink-200"];
                      const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                      const currentUserTasks = tasks.filter(t => t.assignee === selectedProfile);
                      const currentTodayTasks = currentUserTasks.filter(t => getTasksForDay(getCurrentDayName()).includes(t));
                      const currentCompletedTasks = currentTodayTasks.filter(t => isTaskCompleted(t.id, selectedDate));
                      const currentCompletionRate = currentTodayTasks.length ? Math.round((currentCompletedTasks.length / currentTodayTasks.length) * 100) : 0;

                      return (
                        <div className={`${colors[currentUserIndex] || "bg-gray-50 border-gray-200"} border-2 p-6 rounded-xl shadow-lg mb-6 mt-6`}>
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center">
                              <div className="text-4xl mr-4">{user.avatar || avatarEmojis[currentUserIndex] || "ðŸ‘¤"}</div>
                              <div>
                                <h3 className="text-xl font-bold text-gray-800">{user.name}</h3>
                                <p className="text-gray-600">{user.points} points this week</p>
                              </div>
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-white p-3 rounded-lg text-center">
                              <div className="text-2xl font-bold text-green-600">{currentCompletionRate}%</div>
                              <div className="text-xs text-gray-600">Today's Progress</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg text-center">
                              <div className="text-2xl font-bold text-yellow-600">{user.badges.length}</div>
                              <div className="text-xs text-gray-600">Badges Earned</div>
                            </div>
                          </div>

                          {user.badges.length > 0 && (
                            <div className="mb-4">
                              <h4 className="text-sm font-semibold text-gray-700 mb-2">ðŸ† Badges:</h4>
                              <div className="flex flex-wrap gap-2">
                                {user.badges.map((badge, badgeIndex) => (
                                  <span key={badgeIndex} className="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full border border-yellow-300">
                                    <span className="mr-1">{badgeDefinitions[badge]?.emoji || "ðŸ…"}</span>
                                    {badge}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })()}

                    {/* Weekly Stats */}
                    <div className="mt-6 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl border-2 border-green-200">
                      <h3 className="text-lg font-bold text-green-800 mb-3 text-center">ðŸ“Š Weekly Stats</h3>
                      <div className="grid grid-cols-2 gap-4 text-center text-sm">
                        <div className="bg-white p-3 rounded-lg">
                          <div className="text-xl font-bold text-blue-600">{(() => {
                            const startOfWeek = new Date(selectedDate);
                            startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                            let weeklyTotalTasks = 0;
                            for (let i = 0; i < 7; i++) {
                              const day = new Date(startOfWeek);
                              day.setDate(startOfWeek.getDate() + i);
                              const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                              const dayTasks = userTasks.filter(t => {
                                if (!t.daysOfWeek) return t.frequency === "Daily";
                                return t.daysOfWeek.includes(dayName);
                              });
                              weeklyTotalTasks += dayTasks.length;
                            }
                            return weeklyTotalTasks;
                          })()}</div>
                          <div className="text-xs text-gray-600">Total Tasks This Week</div>
                        </div>
                        <div className="bg-white p-3 rounded-lg">
                          <div className="text-xl font-bold text-green-600">{(() => {
                            const startOfWeek = new Date(selectedDate);
                            startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
                            let weeklyCompleted = 0;
                            for (let i = 0; i < 7; i++) {
                              const day = new Date(startOfWeek);
                              day.setDate(startOfWeek.getDate() + i);
                              const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
                              const dayTasks = userTasks.filter(t => {
                                if (!t.daysOfWeek) return t.frequency === "Daily";
                                return t.daysOfWeek.includes(dayName);
                              });
                              weeklyCompleted += dayTasks.filter(t => isTaskCompleted(t.id, day)).length;
                            }
                            return weeklyCompleted;
                          })()}</div>
                          <div className="text-xs text-gray-600">Completed This Week</div>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>
          )}

          {/* Task Editor View */}
          {currentPage === PAGES.TASK_EDITOR && (
            <div className="pb-20">
              {/* Header */}
              <div className="flex items-center justify-between mb-6">
                <button
                  onClick={() => {
                    setShowPresets(false);
                    navigateToPage(PAGES.TASKS);
                  }}
                  className="bg-gray-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px]"
                >
                  â† Back
                </button>
              </div>

              {/* Add New Task Section */}
              <div className="bg-orange-50 rounded-lg p-4 sm:p-6 border border-orange-200 mb-6">
                <div className="mb-4">
                  <h3 className="text-lg font-semibold text-gray-800 flex items-center mb-3">
                    <span className="mr-2">âž•</span>
                    Add New Task
                  </h3>
                </div>

                {showPresets ? (
                  /* Preset Tasks List */
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-semibold text-gray-800">Choose a Preset</h3>
                      <button
                        onClick={() => setShowPresets(false)}
                        className="text-gray-500 text-sm"
                      >
                        Cancel
                      </button>
                    </div>
                    <div className="space-y-3">
                      {presetTasks.map((preset, index) => (
                        <button
                          key={index}
                          onClick={() => selectPresetTask(preset)}
                          className="w-full bg-white border border-gray-200 rounded-lg p-4 text-left hover:border-orange-500 hover:bg-orange-50 transition-colors"
                        >
                          <div className="flex items-center">
                            <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                              <span className="text-lg">{preset.emoji}</span>
                            </div>
                            <div className="flex-1">
                              <div className="font-medium text-gray-800">{preset.name}</div>
                              <div className="text-sm text-gray-600">{preset.notes}</div>
                              <div className="flex items-center mt-1">
                                <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full mr-2">
                                  â­ {preset.points} pts
                                </span>
                                <span className="text-xs text-gray-500">
                                  {preset.frequency === "Daily" ? "Daily" : `${preset.daysOfWeek?.join(", ") || "Custom"}`}
                                </span>
                              </div>
                            </div>
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div>
                    <div className="space-y-6">
                      {/* Task Name */}
                      <div>
                        <input
                          type="text"
                          placeholder="Task Name"
                          value={newTask.name}
                          onChange={(e) => setNewTask({ ...newTask, name: e.target.value })}
                          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-orange-500 focus:outline-none"
                          required
                        />
                        <div className="flex justify-end mt-2">
                          <button 
                            onClick={() => setShowPresets(true)}
                            className="text-orange-500 text-sm font-medium flex items-center"
                          >
                            <span className="mr-1">ðŸŽ¯</span>
                            Use Preset
                          </button>
                        </div>
                      </div>

                      {/* Notes */}
                      <div>
                        <textarea
                          placeholder="Notes"
                          value={newTask.notes || ''}
                          onChange={(e) => setNewTask({ ...newTask, notes: e.target.value })}
                          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-gray-800 placeholder-gray-500 focus:border-orange-500 focus:outline-none h-20 resize-none"
                        />
                      </div>

                      {/* Emoji Selection */}
                      <div>
                        <button
                          type="button"
                          onClick={() => openEmojiPicker('newTask')}
                          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:border-orange-500 focus:outline-none flex items-center justify-between"
                        >
                          <div className="flex items-center">
                            {newTask.emoji && <span className="text-2xl mr-2">{newTask.emoji}</span>}
                            <span className={newTask.emoji ? "text-gray-800" : "text-gray-500"}>
                              {newTask.emoji ? "Change Emoji" : "Choose Emoji"}
                            </span>
                          </div>
                          <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7 7" />
                          </svg>
                        </button>
                      </div>

                      {/* Stars per completion */}
                      <div>
                        <label className="block text-gray-600 text-sm font-medium mb-3">STARS PER COMPLETION</label>
                        <div className="flex items-center justify-center space-x-4">
                          <button
                            onClick={() => setNewTask({ ...newTask, points: Math.max(0, (newTask.points || 0) - 1) })}
                            className="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center text-gray-800 text-xl"
                          >
                            âˆ’
                          </button>
                          <div className="flex items-center bg-gray-100 rounded-lg px-6 py-3">
                            <span className="text-2xl font-bold text-gray-800 mr-2">{newTask.points || 0}</span>
                            <span className="text-2xl">â­</span>
                          </div>
                          <button
                            onClick={() => setNewTask({ ...newTask, points: (newTask.points || 0) + 1 })}
                            className="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center text-white text-xl"
                          >
                            +
                          </button>
                        </div>
                      </div>

                      {/* Start Date */}
                      <div className="flex items-center justify-between">
                        <span className="text-gray-800 font-medium">Start Date</span>
                        <input
                          type="date"
                          value={newTask.startDate}
                          onChange={(e) => setNewTask({ ...newTask, startDate: e.target.value })}
                          className="bg-transparent text-gray-600 border-none outline-none text-right"
                        />
                      </div>

                      {/* Repeat */}
                      <div className="flex items-center justify-between">
                        <span className="text-gray-800 font-medium">Repeat</span>
                        <div className="flex items-center">
                          <select
                            value={newTask.frequency}
                            onChange={(e) => {
                              const freq = e.target.value;
                              setNewTask({ 
                                ...newTask, 
                                frequency: freq,
                                daysOfWeek: freq === "Daily" ? ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] : ["Monday"] 
                              });
                            }}
                            className="bg-transparent text-gray-600 border-none outline-none pr-6 appearance-none"
                          >
                            <option value="Daily" className="bg-white">Every Day</option>
                            <option value="Custom" className="bg-white">Custom Days</option>
                          </select>
                          <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </div>

                      {/* Custom Days Selection */}
                      {newTask.frequency === "Custom" && (
                        <div>
                          <label className="block text-gray-600 text-sm font-medium mb-3">SELECT DAYS</label>
                          <div className="grid grid-cols-7 gap-2">
                            {["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map((day, index) => {
                              const fullDay = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"][index];
                              return (
                                <button
                                  key={day}
                                  type="button"
                                  onClick={() => {
                                    if (newTask.daysOfWeek.includes(fullDay)) {
                                      setNewTask({ 
                                        ...newTask, 
                                        daysOfWeek: newTask.daysOfWeek.filter(d => d !== fullDay)
                                      });
                                    } else {
                                      setNewTask({ 
                                        ...newTask, 
                                        daysOfWeek: [...newTask.daysOfWeek, fullDay]
                                      });
                                    }
                                  }}
                                  className={`py-2 px-2 rounded-lg text-sm font-medium ${
                                    newTask.daysOfWeek.includes(fullDay)
                                      ? "bg-orange-500 text-white"
                                      : "bg-gray-200 text-gray-700"
                                  }`}
                                >
                                  {day}
                                </button>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* Assignee */}
                      <div className="flex items-center justify-between">
                        <span className="text-gray-800 font-medium">Assigned To</span>
                        <div className="flex items-center">
                          <select
                            value={newTask.assignee}
                            onChange={(e) => setNewTask({ ...newTask, assignee: e.target.value })}
                            className="bg-transparent text-gray-600 border-none outline-none pr-6 appearance-none"
                          >
                            {users.map((u, index) => {
                              const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                              const userAvatar = u.avatar || avatarEmojis[index] || "ðŸ‘¤";
                              return (
                                <option key={u.name} value={u.name} className="bg-white">
                                  {userAvatar} {u.name}
                                </option>
                              );
                            })}
                          </select>
                          <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </div>

                      {/* Add Button */}
                      <div className="pt-4">
                        <button
                          onClick={addTask}
                          disabled={!newTask.name || newTask.daysOfWeek.length === 0}
                          className={`w-full px-4 py-3 rounded-lg font-medium text-base ${
                            !newTask.name || newTask.daysOfWeek.length === 0 
                              ? "bg-gray-300 text-gray-500 cursor-not-allowed" 
                              : "bg-orange-500 text-white hover:bg-orange-600"
                          }`}
                        >
                          Add Task
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Existing Tasks List */}
              <div className="bg-gray-50 rounded-lg p-4 sm:p-6 border border-gray-200">
                <div className="mb-4">
                  <h3 className="text-lg font-semibold text-gray-800 flex items-center mb-3">
                    <span className="mr-2">ðŸ“‹</span>
                    Edit Tasks
                  </h3>
                  <div className="flex flex-wrap gap-2">
                    <span className="text-xs sm:text-sm text-gray-500 bg-white px-2 sm:px-3 py-1 rounded-full border">
                      {tasks.length} total
                    </span>
                    <span className="text-xs sm:text-sm text-green-700 bg-green-100 px-2 sm:px-3 py-1 rounded-full border border-green-300">
                      {tasks.filter(t => t.active !== false).length} active
                    </span>
                    {tasks.filter(t => t.active === false).length > 0 && (
                      <span className="text-xs sm:text-sm text-red-700 bg-red-100 px-2 sm:px-3 py-1 rounded-full border border-red-300">
                        {tasks.filter(t => t.active === false).length} inactive
                      </span>
                    )}
                  </div>
                </div>
                {tasks.length > 0 ? (
                  <div className="space-y-3">
                    {tasks.map((task) => (
                      <div key={task.id} className={`bg-white border rounded-lg p-3 sm:p-4 shadow-sm hover:shadow-md transition-shadow ${
                        task.active === false 
                          ? "border-red-300 bg-red-50 opacity-75" 
                          : "border-gray-300"
                      }`}>
                        {editingTask === task.id ? (
                          // Edit Mode
                          <div className="space-y-4">
                            <input
                              type="text"
                              value={editedTaskData.name || task.name}
                              onChange={(e) => setEditedTaskData({ ...editedTaskData, name: e.target.value })}
                              className="w-full bg-white border border-gray-300 rounded-lg px-3 sm:px-4 py-3 text-gray-800 focus:border-orange-500 focus:outline-none text-sm sm:text-base"
                              placeholder="Task Name"
                            />

                            <textarea
                              value={editedTaskData.notes || task.notes || ''}
                              onChange={(e) => setEditedTaskData({ ...editedTaskData, notes: e.target.value })}
                              className="w-full bg-white border border-gray-300 rounded-lg px-3 sm:px-4 py-3 text-gray-800 focus:border-orange-500 focus:outline-none h-20 resize-none text-sm sm:text-base"
                              placeholder="Notes"
                            />

                            {/* Emoji Selection */}
                            <div>
                              <button
                                type="button"
                                onClick={() => openEmojiPicker('editTask')}
                                className="w-full bg-white border border-gray-300 rounded-lg px-3 sm:px-4 py-3 text-gray-800 focus:border-orange-500 focus:outline-none flex items-center justify-between text-sm sm:text-base min-h-[48px]"
                              >
                                <div className="flex items-center">
                                  {(editedTaskData.emoji !== undefined ? editedTaskData.emoji : task.emoji) && (
                                    <span className="text-2xl mr-2">
                                      {editedTaskData.emoji !== undefined ? editedTaskData.emoji : task.emoji}
                                    </span>
                                  )}
                                  <span className={(editedTaskData.emoji !== undefined ? editedTaskData.emoji : task.emoji) ? "text-gray-800" : "text-gray-500"}>
                                    {(editedTaskData.emoji !== undefined ? editedTaskData.emoji : task.emoji) ? "Change Emoji" : "Choose Emoji"}
                                  </span>
                                </div>
                                <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7 7" />
                                </svg>
                              </button>
                            </div>

                            {/* Points */}
                            <div>
                              <label className="block text-gray-600 text-sm font-medium mb-3">STARS PER COMPLETION</label>
                              <div className="flex items-center justify-center space-x-3 sm:space-x-4">
                                <button
                                  onClick={() => setEditedTaskData({ 
                                    ...editedTaskData, 
                                    points: Math.max(0, (editedTaskData.points !== undefined ? editedTaskData.points : task.points) - 1) 
                                  })}
                                  className="w-12 h-12 sm:w-14 sm:h-14 bg-gray-200 rounded-lg flex items-center justify-center text-gray-800 text-xl sm:text-2xl min-h-[48px]"
                                >
                                  âˆ’
                                </button>
                                <div className="flex items-center bg-gray-100 rounded-lg px-4 sm:px-6 py-3">
                                  <span className="text-xl sm:text-2xl font-bold text-gray-800 mr-2">
                                    {editedTaskData.points !== undefined ? editedTaskData.points : task.points}
                                  </span>
                                  <span className="text-xl sm:text-2xl">â­</span>
                                </div>
                                <button
                                  onClick={() => setEditedTaskData({ 
                                    ...editedTaskData, 
                                    points: (editedTaskData.points !== undefined ? editedTaskData.points : task.points) + 1 
                                  })}
                                  className="w-12 h-12 sm:w-14 sm:h-14 bg-green-600 rounded-lg flex items-center justify-center text-white text-xl sm:text-2xl min-h-[48px]"
                                >
                                  +
                                </button>
                              </div>
                            </div>

                            {/* Frequency */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                              <span className="text-gray-800 font-medium text-sm sm:text-base">Repeat</span>
                              <div className="flex items-center">
                                <select
                                  value={editedTaskData.frequency || task.frequency}
                                  onChange={(e) => {
                                    const freq = e.target.value;
                                    setEditedTaskData({ 
                                      ...editedTaskData, 
                                      frequency: freq,
                                      daysOfWeek: freq === "Daily" ? 
                                        ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] : 
                                        (editedTaskData.daysOfWeek || task.daysOfWeek || ["Monday"])
                                    });
                                  }}
                                  className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-600 pr-8 appearance-none text-sm sm:text-base min-h-[40px]"
                                >
                                  <option value="Daily" className="bg-white">Every Day</option>
                                  <option value="Custom" className="bg-white">Custom Days</option>
                                </select>
                                <svg className="w-4 h-4 text-gray-600 -ml-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                              </div>
                            </div>

                            {/* Custom Days Selection */}
                            {(editedTaskData.frequency || task.frequency) === "Custom" && (
                              <div>
                                <label className="block text-gray-600 text-sm font-medium mb-3">SELECT DAYS</label>
                                <div className="grid grid-cols-7 gap-1 sm:gap-2">
                                  {["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map((day, index) => {
                                    const fullDay = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"][index];
                                    const currentDaysOfWeek = editedTaskData.daysOfWeek || task.daysOfWeek || [];
                                    return (
                                      <button
                                        key={day}
                                        type="button"
                                        onClick={() => {
                                          if (currentDaysOfWeek.includes(fullDay)) {
                                            setEditedTaskData({ 
                                              ...editedTaskData, 
                                              daysOfWeek: currentDaysOfWeek.filter(d => d !== fullDay)
                                            });
                                          } else {
                                            setEditedTaskData({ 
                                              ...editedTaskData, 
                                              daysOfWeek: [...currentDaysOfWeek, fullDay]
                                            });
                                          }
                                        }}
                                        className={`py-2 px-1 sm:px-2 rounded-lg text-xs sm:text-sm font-medium min-h-[40px] ${
                                          currentDaysOfWeek.includes(fullDay)
                                            ? "bg-orange-500 text-white"
                                            : "bg-gray-200 text-gray-700"
                                        }`}
                                      >
                                        {day}
                                      </button>
                                    );
                                  })}
                                </div>
                              </div>
                            )}

                            {/* Assignee */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                              <span className="text-gray-800 font-medium text-sm sm:text-base">Assigned To</span>
                              <div className="flex items-center">
                                <select
                                  value={editedTaskData.assignee || task.assignee}
                                  onChange={(e) => setEditedTaskData({ ...editedTaskData, assignee: e.target.value })}
                                  className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-600 pr-8 appearance-none text-sm sm:text-base min-h-[40px]"
                                >
                                  {users.map((u, index) => {
                                    const avatarEmojis = ["ðŸ‘©", "ðŸ‘¨", "ðŸ§‘", "ðŸ‘¦"];
                                    const userAvatar = u.avatar || avatarEmojis[index] || "ðŸ‘¤";
                                    return (
                                      <option key={u.name} value={u.name} className="bg-white">
                                        {userAvatar} {u.name}
                                      </option>
                                    );
                                  })}
                                </select>
                                <svg className="w-4 h-4 text-gray-600 -ml-6 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                              </div>
                            </div>

                            {/* Active/Inactive Toggle */}
                            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
                              <span className="text-gray-800 font-medium text-sm sm:text-base">Task Status</span>
                              <div className="flex items-center">
                                <button
                                  onClick={() => setEditedTaskData({ 
                                    ...editedTaskData, 
                                    active: editedTaskData.active !== undefined ? !editedTaskData.active : !(task.active !== false) 
                                  })}
                                  className={`flex items-center px-3 py-2 rounded-lg text-sm font-medium transition-colors min-h-[44px] ${
                                    (editedTaskData.active !== undefined ? editedTaskData.active : (task.active !== false))
                                      ? "bg-green-100 text-green-800 border border-green-300"
                                      : "bg-red-100 text-red-800 border border-red-300"
                                  }`}
                                >
                                  <span className="mr-2">
                                    {(editedTaskData.active !== undefined ? editedTaskData.active : (task.active !== false)) ? "âœ…" : "âŒ"}
                                  </span>
                                  {(editedTaskData.active !== undefined ? editedTaskData.active : (task.active !== false)) ? "Active" : "Inactive"}
                                </button>
                              </div>
                            </div>

                            {/* Save/Cancel Buttons */}
                            <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
                              <button
                                onClick={() => updateTask(task.id, editedTaskData)}
                                className="flex-1 bg-green-500 text-white py-3 px-4 rounded-lg font-medium text-sm sm:text-base min-h-[48px]"
                              >
                                Save Changes
                              </button>
                              <button
                                onClick={() => {
                                  setEditingTask(null);
                                  setEditedTaskData({});
                                }}
                                className="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg font-medium text-sm sm:text-base min-h-[48px]"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        ) : (
                          // View Mode
                          <div>
                            <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-3 space-y-3 sm:space-y-0">
                              <div className="flex items-center flex-1 min-w-0">
                                <div className="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                  <span className="text-lg sm:text-xl">{getTaskEmoji(task.name, task.emoji)}</span>
                                </div>
                                <div className="flex-1 min-w-0">
                                  <h4 className="font-medium text-gray-800 text-sm sm:text-base truncate">{task.name}</h4>
                                  <div className="flex flex-wrap gap-1 sm:gap-2 mt-1">
                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${getPersonColor(task.assignee)}`}>
                                      {task.assignee}
                                    </span>
                                    <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full whitespace-nowrap">
                                      â­ {task.points} pts
                                    </span>
                                    <span className={`text-xs px-2 py-1 rounded-full font-medium whitespace-nowrap ${
                                      task.active === false 
                                        ? "bg-red-100 text-red-800" 
                                        : "bg-green-100 text-green-800"
                                    }`}>
                                      {task.active === false ? "Inactive" : "Active"}
                                    </span>
                                  </div>
                                </div>
                              </div>
                              <div className="flex space-x-2 flex-shrink-0">
                                <button
                                  onClick={() => {
                                    setEditingTask(task.id);
                                    setEditedTaskData({});
                                  }}
                                  className="bg-blue-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px] flex items-center justify-center"
                                >
                                  Edit
                                </button>
                                <button
                                  onClick={() => deleteTask(task.id)}
                                  className="bg-red-500 text-white px-3 py-2 rounded-lg text-xs sm:text-sm min-h-[40px] flex items-center justify-center"
                                >
                                  Delete
                                </button>
                              </div>
                            </div>

                            <div className="text-xs sm:text-sm text-gray-600 mb-2 bg-gray-50 p-2 rounded-lg">
                              <div className="font-medium text-gray-700 mb-1">Schedule</div>
                              <div>{task.frequency === "Daily" ? "Every day" : 
                                `${task.daysOfWeek?.join(", ") || "Custom days"}`}</div>
                            </div>

                            {task.notes && (
                              <div className="text-xs sm:text-sm text-gray-600 bg-blue-50 p-2 rounded-lg">
                                <div className="font-medium text-gray-700 mb-1">Notes</div>
                                <div className="break-words">{task.notes}</div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <div className="text-4xl mb-3">ðŸ“</div>
                    <p className="text-lg font-medium mb-1">No tasks yet</p>
                    <p className="text-sm">Create your first task using the form above</p>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Family Members View */}
          {currentPage === PAGES.FAMILY_MEMBERS && <FamilyMembersPage />}

          {/* Settings View */}
          {currentPage === PAGES.SETTINGS && <SettingsPage />}

        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
